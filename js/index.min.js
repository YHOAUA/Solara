const dom={container:document.getElementById("mainContainer"),backgroundStage:document.getElementById("backgroundStage"),backgroundBaseLayer:document.getElementById("backgroundBaseLayer"),backgroundTransitionLayer:document.getElementById("backgroundTransitionLayer"),playlist:document.getElementById("playlist"),playlistItems:document.getElementById("playlistItems"),playlistSelectorButton:document.getElementById("playlistSelectorButton"),playlistSelectorLabel:document.getElementById("playlistSelectorLabel"),playlistMenu:document.getElementById("playlistMenu"),createPlaylistBtn:document.getElementById("createPlaylistBtn"),importPlaylistBtn:document.getElementById("importPlaylistBtn"),deletePlaylistBtn:document.getElementById("deletePlaylistBtn"),lyrics:document.getElementById("lyrics"),lyricsScroll:document.getElementById("lyricsScroll"),lyricsContent:document.getElementById("lyricsContent"),mobileInlineLyrics:document.getElementById("mobileInlineLyrics"),mobileInlineLyricsScroll:document.getElementById("mobileInlineLyricsScroll"),mobileInlineLyricsContent:document.getElementById("mobileInlineLyricsContent"),audioPlayer:document.getElementById("audioPlayer"),themeToggleButton:document.getElementById("themeToggleButton"),showPlaylistBtn:document.getElementById("showPlaylistBtn"),showLyricsBtn:document.getElementById("showLyricsBtn"),searchInput:document.getElementById("searchInput"),searchBtn:document.getElementById("searchBtn"),sourceSelectButton:document.getElementById("sourceSelectButton"),sourceSelectLabel:document.getElementById("sourceSelectLabel"),sourceMenu:document.getElementById("sourceMenu"),searchResults:document.getElementById("searchResults"),notification:document.getElementById("notification"),albumCover:document.getElementById("albumCover"),currentSongTitle:document.getElementById("currentSongTitle"),currentSongArtist:document.getElementById("currentSongArtist"),debugInfo:document.getElementById("debugInfo"),playModeBtn:document.getElementById("playModeBtn"),playPauseBtn:document.getElementById("playPauseBtn"),progressBar:document.getElementById("progressBar"),currentTimeDisplay:document.getElementById("currentTimeDisplay"),durationDisplay:document.getElementById("durationDisplay"),volumeSlider:document.getElementById("volumeSlider"),volumeIcon:document.getElementById("volumeIcon"),qualityToggle:document.getElementById("qualityToggle"),playerQualityMenu:document.getElementById("playerQualityMenu"),qualityLabel:document.getElementById("qualityLabel"),mobileToolbarTitle:document.getElementById("mobileToolbarTitle"),mobileSearchToggle:document.getElementById("mobileSearchToggle"),mobileSearchClose:document.getElementById("mobileSearchClose"),mobilePanelClose:document.getElementById("mobilePanelClose"),mobileClearPlaylistBtn:document.getElementById("mobileClearPlaylistBtn"),mobileOverlayScrim:document.getElementById("mobileOverlayScrim"),mobileQualityToggle:document.getElementById("mobileQualityToggle"),mobileQualityLabel:document.getElementById("mobileQualityLabel"),mobilePanel:document.getElementById("mobilePanel"),mobilePanelTitle:document.getElementById("mobilePanelTitle"),mobileQueueToggle:document.getElementById("mobileQueueToggle"),searchArea:document.getElementById("searchArea"),playlistSyncStatus:document.getElementById("playlistSyncStatus"),playlistSyncBtn:document.getElementById("playlistSyncBtn")};window.SolaraDom=dom;const isMobileView=Boolean(window.__SOLARA_IS_MOBILE),mobileBridge=window.SolaraMobileBridge||{};function invokeMobileHook(e,...t){if(!isMobileView)return;const a=mobileBridge.handlers[e];if("function"==typeof a)return a(...t);mobileBridge.queue.push({name:e,args:t})}function initializeMobileUI(){return invokeMobileHook("initialize")}function updateMobileToolbarTitle(){return invokeMobileHook("updateToolbarTitle")}function runAfterOverlayFrame(e){if("function"!=typeof e||!isMobileView)return;const t=()=>{document.body&&e()};"function"==typeof window.requestAnimationFrame?window.requestAnimationFrame(t):window.setTimeout(t,0)}function syncMobileOverlayVisibility(){if(!isMobileView||!document.body)return;const e=document.body.classList.contains("mobile-search-open"),t=document.body.classList.contains("mobile-panel-open");dom.searchArea&&dom.searchArea.setAttribute("aria-hidden",e?"false":"true"),dom.mobileOverlayScrim&&dom.mobileOverlayScrim.setAttribute("aria-hidden",e||t?"false":"true")}function updateMobileClearPlaylistVisibility(){if(!isMobileView)return;const e=dom.mobileClearPlaylistBtn;if(!e)return;const t=dom.playlist,a=document.body,n=a?a.getAttribute("data-mobile-panel-view"):null,l=!a||!n||"playlist"===n,i=0===(void 0!==state&&Array.isArray(state.playlistSongs)?state.playlistSongs:[]).length||!t||t.classList.contains("empty"),o=l&&!i;e.hidden=!o,e.setAttribute("aria-hidden",o?"false":"true")}function forceCloseMobileSearchOverlay(){isMobileView&&document.body&&(document.body.classList.remove("mobile-search-open"),dom.searchInput&&dom.searchInput.blur(),syncMobileOverlayVisibility())}function forceCloseMobilePanelOverlay(){isMobileView&&document.body&&(document.body.classList.remove("mobile-panel-open"),syncMobileOverlayVisibility())}function openMobileSearch(){return invokeMobileHook("openSearch")}function closeMobileSearch(){const e=invokeMobileHook("closeSearch");return runAfterOverlayFrame(forceCloseMobileSearchOverlay),e}function toggleMobileSearch(){return invokeMobileHook("toggleSearch")}function openMobilePanel(e="playlist"){return invokeMobileHook("openPanel",e)}function closeMobilePanel(){const e=invokeMobileHook("closePanel");return runAfterOverlayFrame(forceCloseMobilePanelOverlay),e}function toggleMobilePanel(e="playlist"){return invokeMobileHook("togglePanel",e)}function closeAllMobileOverlays(){const e=invokeMobileHook("closeAllOverlays");return runAfterOverlayFrame(()=>{forceCloseMobileSearchOverlay(),forceCloseMobilePanelOverlay()}),e}function updateMobileInlineLyricsAria(e){dom.mobileInlineLyrics&&dom.mobileInlineLyrics.setAttribute("aria-hidden",e?"false":"true")}function setMobileInlineLyricsOpen(e){isMobileView&&document.body&&dom.mobileInlineLyrics&&(state.isMobileInlineLyricsOpen=Boolean(e),document.body.classList.toggle("mobile-inline-lyrics-open",Boolean(e)),updateMobileInlineLyricsAria(Boolean(e)))}function hasInlineLyricsContent(){const e=dom.mobileInlineLyricsContent;return!!e&&e.textContent.trim().length>0}function canOpenMobileInlineLyrics(){if(!isMobileView||!document.body)return!1;return Boolean(state.currentSong)&&hasInlineLyricsContent()}function closeMobileInlineLyrics(e={}){return!(!isMobileView||!document.body)&&(document.body.classList.contains("mobile-inline-lyrics-open")?(setMobileInlineLyricsOpen(!1),e.force&&(state.userScrolledLyrics=!1),!0):(updateMobileInlineLyricsAria(!1),state.isMobileInlineLyricsOpen=!1,!1))}function openMobileInlineLyrics(){return!(!isMobileView||!document.body)&&(!!canOpenMobileInlineLyrics()&&(setMobileInlineLyricsOpen(!0),state.userScrolledLyrics=!1,window.requestAnimationFrame(()=>{const e=dom.mobileInlineLyricsScroll||dom.mobileInlineLyrics,t=dom.mobileInlineLyricsContent?.querySelector(".current")||dom.mobileInlineLyricsContent?.querySelector("div[data-index]");e&&t&&scrollToCurrentLyric(t,e)}),syncLyrics(),!0))}function toggleMobileInlineLyrics(){isMobileView&&document.body&&(document.body.classList.contains("mobile-inline-lyrics-open")?closeMobileInlineLyrics():openMobileInlineLyrics())}mobileBridge.handlers=mobileBridge.handlers||{},mobileBridge.queue=Array.isArray(mobileBridge.queue)?mobileBridge.queue:[],window.SolaraMobileBridge=mobileBridge;const PLACEHOLDER_HTML='<div class="placeholder"><i class="fas fa-music"></i></div>',paletteCache=new Map,PALETTE_STORAGE_KEY="paletteCache.v1";let paletteAbortController=null;const BACKGROUND_TRANSITION_DURATION=850;let backgroundTransitionTimer=null;const PALETTE_APPLY_DELAY=140;let pendingPaletteTimer=null,deferredPaletteHandle=null,deferredPaletteType="",deferredPaletteUrl=null;const themeDefaults={light:{gradient:"",primaryColor:"",primaryColorDark:""},dark:{gradient:"",primaryColor:"",primaryColorDark:""}};let paletteRequestId=0;function safeGetLocalStorage(e){try{return localStorage.getItem(e)}catch(t){return console.warn(`读取本地存储失败: ${e}`,t),null}}function safeSetLocalStorage(e,t){try{localStorage.setItem(e,t)}catch(t){console.warn(`写入本地存储失败: ${e}`,t)}}function safeRemoveLocalStorage(e){try{localStorage.removeItem(e)}catch(t){console.warn(`移除本地存储失败: ${e}`,t)}}function parseJSON(e,t){if(!e)return t;try{return JSON.parse(e)}catch(e){return console.warn("解析本地存储 JSON 失败",e),t}}function loadStoredPalettes(){const e=safeGetLocalStorage("paletteCache.v1");if(e)try{const t=JSON.parse(e);if(Array.isArray(t))for(const e of t)Array.isArray(e)&&"string"==typeof e[0]&&e[1]&&"object"==typeof e[1]&&paletteCache.set(e[0],e[1])}catch(e){console.warn("解析调色板缓存失败",e)}}function persistPaletteCache(){const e=Array.from(paletteCache.entries()).slice(-20);try{safeSetLocalStorage("paletteCache.v1",JSON.stringify(e))}catch(e){console.warn("保存调色板缓存失败",e)}}function generateLocalPlaylistId(){return"undefined"!=typeof crypto&&"function"==typeof crypto.randomUUID?crypto.randomUUID():`pl_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,8)}`}function normalizePlaylistName(e){const t="string"==typeof e?e.trim():"";return t?t.length>MAX_PLAYLIST_NAME_LENGTH?t.slice(0,MAX_PLAYLIST_NAME_LENGTH):t:DEFAULT_PLAYLIST_NAME}function normalizePlaylistEntry(e){const t=e&&"object"==typeof e?e:{};const a={id:"string"==typeof t.id&&t.id.trim()?t.id.trim():generateLocalPlaylistId(),name:normalizePlaylistName(t.name),songs:Array.isArray(t.songs)?t.songs.filter(e=>e&&"object"==typeof e):[]};return a.id||(a.id=generateLocalPlaylistId()),a}function clonePlaylistSongs(e){return Array.isArray(e)?e.filter(e=>e&&"object"==typeof e):[]}function extractNeteasePlaylistId(e){if(null==e)return"";const t=String(e).trim();if(!t)return"";if(/^\d+$/.test(t))return t;const a=t.match(/id=(\d+)/);if(a)return a[1];try{const e=/^https?:\/\//i.test(t)?t:`https://${t.replace(/^\/+/,"")}`,a=new URL(e),n=a.searchParams.get("id");if(n&&/^\d+$/.test(n))return n;if(a.hash){const e=a.hash.match(/id=(\d+)/);if(e)return e[1];const t=a.hash.replace(/^#/,"");if(t)try{const e=new URL(`${a.origin}/${t.startsWith("/")?t.slice(1):t}`).searchParams.get("id");if(e&&/^\d+$/.test(e))return e}catch{}}const l=a.pathname.match(/playlist[\/-](\d+)/i);if(l)return l[1]}catch{}return""}const PLAYLIST_SYNC_STORAGE_KEY="playlistSync.meta.v1",PLAYLIST_SYNC_ENDPOINT="/playlist",PLAYLIST_SYNC_SHARE_PARAM="sync",PLAYLIST_SYNC_DEBOUNCE_MS=800,savedPlaylistSyncMeta=(()=>{const e=parseJSON(safeGetLocalStorage("playlistSync.meta.v1"),null);return e&&"object"==typeof e?{id:"string"==typeof e.id&&e.id.trim()?e.id.trim():null,updatedAt:"string"==typeof e.updatedAt?e.updatedAt:null,lastSyncedAt:"string"==typeof e.lastSyncedAt?e.lastSyncedAt:null,lastSyncedSnapshot:"string"==typeof e.lastSyncedSnapshot?e.lastSyncedSnapshot:null}:null})(),PLAYLIST_SYNC_PLAY_MODES=["list","single","random"],PLAYLIST_SYNC_SCOPES=["playlist","online","search"],PLAYLIST_COLLECTION_STORAGE_KEY="playlists.v1",ACTIVE_PLAYLIST_ID_STORAGE_KEY="activePlaylistId.v1",DEFAULT_PLAYLIST_NAME="默认歌单",MAX_PLAYLIST_NAME_LENGTH=40,MAX_NETEASE_IMPORT_TRACKS=500,playlistSync={id:savedPlaylistSyncMeta?.id||null,updatedAt:savedPlaylistSyncMeta?.updatedAt||null,lastSyncedAt:savedPlaylistSyncMeta?.lastSyncedAt||null,lastSyncedSnapshot:savedPlaylistSyncMeta?.lastSyncedSnapshot||null,pendingSnapshot:null,debounceTimer:null,inFlight:null,enabled:!0,error:null,notifiedError:!1};let isRestoringPlaylistFromRemote=!1;function disablePlaylistSync({message:e,type:t="error"}={}){const a=playlistSync.enabled;playlistSync.debounceTimer&&(window.clearTimeout(playlistSync.debounceTimer),playlistSync.debounceTimer=null),playlistSync.enabled=!1,playlistSync.pendingSnapshot=null,playlistSync.inFlight=null,playlistSync.id=null,playlistSync.updatedAt=null,playlistSync.lastSyncedAt=null,playlistSync.lastSyncedSnapshot=null,playlistSync.error=null,playlistSync.notifiedError=!1,persistPlaylistSyncMeta(),updatePlaylistShareUrl(),updatePlaylistSyncUI(),e&&a&&showNotification(e,t)}function preferHttpsUrl(e){if(!e||"string"!=typeof e)return e;try{const t=new URL(e,window.location.href);return"http:"===t.protocol&&"https:"===window.location.protocol?(t.protocol="https:",t.toString()):t.toString()}catch(t){return"https:"===window.location.protocol&&e.startsWith("http://")?"https://"+e.substring(7):e}}function buildAudioProxyUrl(e){if(!e||"string"!=typeof e)return e;try{const t=new URL(e,window.location.href);return"https:"===t.protocol?t.toString():"http:"===t.protocol&&/(^|\.)kuwo\.cn$/i.test(t.hostname)?`${API.baseUrl}?target=${encodeURIComponent(t.toString())}`:t.toString()}catch(t){return console.warn("无法解析音频地址，跳过代理",t),e}}function getPlaylistSyncPayload(){const e=Array.isArray(state.playlistSongs)?state.playlistSongs:[];let t=Number.isInteger(state.currentTrackIndex)?state.currentTrackIndex:e.length?0:-1;0===e.length?t=-1:(t<0||t>=e.length)&&(t=Math.min(Math.max(t,0),e.length-1));const a={songs:e,currentTrackIndex:t,playMode:"string"==typeof state.playMode&&PLAYLIST_SYNC_PLAY_MODES.includes(state.playMode)?state.playMode:PLAYLIST_SYNC_PLAY_MODES[0],playbackQuality:normalizeQuality(state.playbackQuality),currentPlaylist:"string"==typeof state.currentPlaylist&&PLAYLIST_SYNC_SCOPES.includes(state.currentPlaylist)?state.currentPlaylist:PLAYLIST_SYNC_SCOPES[0],currentSong:state.currentSong&&"object"==typeof state.currentSong?state.currentSong:null,currentPlaybackTime:Number.isFinite(state.currentPlaybackTime)&&state.currentPlaybackTime>=0?state.currentPlaybackTime:0};return Number.isFinite(state.volume)&&(a.volume=Math.min(Math.max(state.volume,0),1)),a}function computePlaylistSyncSnapshot(e=null){const t=e||getPlaylistSyncPayload();try{return JSON.stringify(t)}catch(e){return console.warn("序列化播放列表失败，使用空数据",e),JSON.stringify({songs:[],currentTrackIndex:-1,playMode:PLAYLIST_SYNC_PLAY_MODES[0],playbackQuality:"320",currentPlaylist:PLAYLIST_SYNC_SCOPES[0],currentSong:null,currentPlaybackTime:0})}}function persistPlaylistSyncMeta(){if(!playlistSync.id)return void safeRemoveLocalStorage("playlistSync.meta.v1");const e={id:playlistSync.id,updatedAt:playlistSync.updatedAt,lastSyncedAt:playlistSync.lastSyncedAt,lastSyncedSnapshot:playlistSync.lastSyncedSnapshot};safeSetLocalStorage("playlistSync.meta.v1",JSON.stringify(e))}function formatRelativeSyncTime(e){if(!e)return"";const t=Date.parse(e);if(!Number.isFinite(t))return e;const a=Date.now()-t;if(a<45e3)return"刚刚";if(a<36e5)return`${Math.round(a/6e4)} 分钟前`;if(a<864e5)return`${Math.round(a/36e5)} 小时前`;const n=new Date(t);return`${n.toLocaleDateString()} ${n.toLocaleTimeString()}`}function buildPlaylistShareUrl(e=playlistSync.id){if(!e)return window.location.href;try{const t=new URL(window.location.href);return t.searchParams.set("sync",e),t.toString()}catch(t){return console.warn("生成云同步链接失败",t),`${window.location.origin}${window.location.pathname}?sync=${encodeURIComponent(e)}`}}function updatePlaylistShareUrl(){try{const e=new URL(window.location.href);if(playlistSync.id){if(e.searchParams.get("sync")===playlistSync.id)return;e.searchParams.set("sync",playlistSync.id)}else{if(!e.searchParams.has("sync"))return;e.searchParams.delete("sync")}const t=`${e.pathname}${e.search}${e.hash}`;window.history.replaceState(window.history.state,document.title,t)}catch(e){console.warn("更新云同步分享链接失败",e)}}function updatePlaylistSyncUI(){if(!dom.playlistSyncBtn||!dom.playlistSyncStatus)return;const e=dom.playlistSyncBtn,t=dom.playlistSyncStatus;if(t.className="playlist-sync-status",!playlistSync.enabled)return e.disabled=!0,e.title="云同步不可用",t.textContent="云同步不可用",void t.classList.add("playlist-sync-status--error");if(!playlistSync.id)return e.disabled=!0,e.title="云同步初始化中...",void(t.textContent="云同步初始化中...");if(e.disabled=Boolean(playlistSync.inFlight),e.title="复制云同步链接",playlistSync.inFlight)return void(t.textContent="云同步中...");if(playlistSync.error)return t.textContent="同步失败，将自动重试",void t.classList.add("playlist-sync-status--error");let a="";if(playlistSync.lastSyncedAt){const e=formatRelativeSyncTime(playlistSync.lastSyncedAt);a=e?` · 更新于 ${e}`:"",t.classList.add("playlist-sync-status--success")}t.textContent=`云同步 ID: ${playlistSync.id}${a}`}function handlePlaylistSyncChange(e){if(playlistSync.enabled){if(e||(e=computePlaylistSyncSnapshot()),!playlistSync.id)return playlistSync.pendingSnapshot=e,void updatePlaylistSyncUI();(playlistSync.lastSyncedSnapshot!==e||playlistSync.pendingSnapshot)&&queuePlaylistSyncUpdate(e)}}function queuePlaylistSyncUpdate(e){playlistSync.pendingSnapshot=e,playlistSync.debounceTimer&&window.clearTimeout(playlistSync.debounceTimer),playlistSync.id?(playlistSync.debounceTimer=window.setTimeout(()=>{playlistSync.debounceTimer=null,flushPlaylistSyncQueue()},800),updatePlaylistSyncUI()):updatePlaylistSyncUI()}async function flushPlaylistSyncQueue(){if(!playlistSync.enabled)return playlistSync.pendingSnapshot=null,void updatePlaylistSyncUI();if(!playlistSync.id||!playlistSync.pendingSnapshot)return void updatePlaylistSyncUI();if(playlistSync.inFlight)return;const e=playlistSync.pendingSnapshot;playlistSync.pendingSnapshot=null;const t=sendPlaylistSyncUpdate(e).catch(t=>{playlistSync.error=t,playlistSync.pendingSnapshot=e,playlistSync.notifiedError||(showNotification("云同步失败，将自动重试","error"),playlistSync.notifiedError=!0),console.warn("同步播放列表失败:",t)}).finally(()=>{playlistSync.inFlight=null,playlistSync.pendingSnapshot&&!playlistSync.debounceTimer&&playlistSync.enabled&&(playlistSync.debounceTimer=window.setTimeout(()=>{playlistSync.debounceTimer=null,flushPlaylistSyncQueue()},1600)),updatePlaylistSyncUI()});playlistSync.inFlight=t,updatePlaylistSyncUI(),await t}async function sendPlaylistSyncUpdate(e){if(!playlistSync.id)throw new Error("Missing playlist sync identifier");let t;try{t=JSON.parse(e)}catch(a){console.warn("解析同步数据失败",a),t=getPlaylistSyncPayload(),e=computePlaylistSyncSnapshot(t)}const a=await fetch(`/playlist?id=${encodeURIComponent(playlistSync.id)}`,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(t)});if(404===a.status)return createPlaylistOnServer(t,e);if(501===a.status)throw disablePlaylistSync({message:"云同步不可用，将使用本地播放列表"}),new Error("Playlist sync unavailable");if(!a.ok)throw new Error(`Failed to update playlist: ${a.status}`);const n=await a.json(),l="string"==typeof n.updatedAt?n.updatedAt:(new Date).toISOString();return playlistSync.updatedAt=l,playlistSync.lastSyncedAt=l,playlistSync.lastSyncedSnapshot=e,playlistSync.error=null,playlistSync.notifiedError=!1,persistPlaylistSyncMeta(),n}async function createPlaylistOnServer(e,t=computePlaylistSyncSnapshot(e)){const a=await fetch("/playlist",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(e)});if(501===a.status)throw disablePlaylistSync({message:"云同步不可用，将使用本地播放列表"}),new Error("Playlist sync unavailable");if(!a.ok)throw new Error(`Failed to create playlist: ${a.status}`);const n=await a.json();"string"==typeof n.id&&n.id.trim()&&(playlistSync.id=n.id.trim());const l="string"==typeof n.updatedAt?n.updatedAt:(new Date).toISOString();return playlistSync.updatedAt=l,playlistSync.lastSyncedAt=l,playlistSync.lastSyncedSnapshot=t,playlistSync.pendingSnapshot=null,playlistSync.error=null,playlistSync.notifiedError=!1,persistPlaylistSyncMeta(),updatePlaylistShareUrl(),updatePlaylistSyncUI(),n}async function fetchPlaylistFromServer(e){const t=await fetch(`/playlist?id=${encodeURIComponent(e)}`,{method:"GET",headers:{Accept:"application/json"}});if(404===t.status)return null;if(501===t.status)return disablePlaylistSync({message:"云同步不可用，将使用本地播放列表"}),null;if(!t.ok)throw new Error(`Failed to fetch playlist: ${t.status}`);const a=await t.json();return{updatedAt:"string"==typeof a.updatedAt?a.updatedAt:(new Date).toISOString(),playlist:normalizeRemotePlaylist(a.playlist),version:a.version??1}}function normalizeRemotePlaylist(e){const t=e&&"object"==typeof e?e:{},a=Array.isArray(t.songs)?t.songs:[];let n=Number.isInteger(t.currentTrackIndex)?t.currentTrackIndex:a.length?0:-1;0===a.length?n=-1:(n<0||n>=a.length)&&(n=Math.min(Math.max(n,0),a.length-1));const l={songs:a,currentTrackIndex:n,playMode:"string"==typeof t.playMode&&PLAYLIST_SYNC_PLAY_MODES.includes(t.playMode)?t.playMode:PLAYLIST_SYNC_PLAY_MODES[0],playbackQuality:normalizeQuality("string"==typeof t.playbackQuality?t.playbackQuality:void 0),currentPlaylist:"string"==typeof t.currentPlaylist&&PLAYLIST_SYNC_SCOPES.includes(t.currentPlaylist)?t.currentPlaylist:PLAYLIST_SYNC_SCOPES[0],currentSong:t.currentSong&&"object"==typeof t.currentSong?t.currentSong:null,currentPlaybackTime:"number"==typeof t.currentPlaybackTime&&Number.isFinite(t.currentPlaybackTime)&&t.currentPlaybackTime>=0?t.currentPlaybackTime:0};return"number"==typeof t.volume&&Number.isFinite(t.volume)&&(l.volume=Math.min(Math.max(t.volume,0),1)),l}function applyRemotePlaylist(e,t){const a=normalizeRemotePlaylist(e);isRestoringPlaylistFromRemote=!0;try{setActivePlaylistSongs(a.songs),state.currentTrackIndex=a.currentTrackIndex,state.playMode=a.playMode,state.playbackQuality=a.playbackQuality,state.currentPlaylist=a.currentPlaylist,state.currentSong=a.currentSong,state.currentPlaybackTime=a.currentPlaybackTime,"number"!=typeof a.volume||Number.isNaN(a.volume)||(state.volume=a.volume,dom.audioPlayer&&(dom.audioPlayer.volume=a.volume),dom.volumeSlider&&(dom.volumeSlider.value=a.volume,updateVolumeSliderBackground(a.volume),updateVolumeIcon(a.volume))),renderPlaylist()}finally{isRestoringPlaylistFromRemote=!1}playlistSync.lastSyncedSnapshot=t||computePlaylistSyncSnapshot(a),playlistSync.pendingSnapshot=null,playlistSync.error=null,playlistSync.notifiedError=!1,persistPlaylistSyncMeta(),updatePlaylistSyncUI()}async function initializePlaylistSync(){if(!playlistSync.enabled)return void updatePlaylistSyncUI();if("function"!=typeof fetch)return void disablePlaylistSync({message:"当前环境不支持云同步"});updatePlaylistSyncUI();let e=null;try{const t=new URL(window.location.href);e=t.searchParams.get("sync")?.trim()||null}catch(e){console.warn("解析云同步参数失败",e)}e&&e!==playlistSync.id&&(playlistSync.id=e,playlistSync.updatedAt=null,playlistSync.lastSyncedAt=null,playlistSync.lastSyncedSnapshot=null,playlistSync.pendingSnapshot=null,persistPlaylistSyncMeta());const t=computePlaylistSyncSnapshot();if(playlistSync.id){updatePlaylistShareUrl();try{const e=await fetchPlaylistFromServer(playlistSync.id);if(!playlistSync.enabled)return void updatePlaylistSyncUI();if(!e)return await sendPlaylistSyncUpdate(t),void updatePlaylistSyncUI();const a=computePlaylistSyncSnapshot(e.playlist),n=Date.parse(e.updatedAt||""),l=playlistSync.updatedAt?Date.parse(playlistSync.updatedAt):NaN;Number.isFinite(n)&&(!Number.isFinite(l)||n>=l)&&a!==playlistSync.lastSyncedSnapshot&&applyRemotePlaylist(e.playlist,a),playlistSync.updatedAt=e.updatedAt,playlistSync.lastSyncedAt=e.updatedAt,playlistSync.lastSyncedSnapshot=a,playlistSync.error=null,playlistSync.notifiedError=!1,persistPlaylistSyncMeta(),updatePlaylistSyncUI(),a!==t?queuePlaylistSyncUpdate(t):playlistSync.pendingSnapshot=null}catch(e){if(!playlistSync.enabled)return void updatePlaylistSyncUI();playlistSync.error=e,playlistSync.notifiedError=!0,console.warn("拉取云播放列表失败:",e),showNotification("同步云播放列表失败，将稍后重试","error"),updatePlaylistSyncUI()}}else{try{await createPlaylistOnServer(getPlaylistSyncPayload(),t)}catch(e){return console.warn("初始化云同步失败:",e),void disablePlaylistSync({message:"云同步不可用，将使用本地播放列表"})}updatePlaylistSyncUI()}}async function copyPlaylistSyncLink(){if(!playlistSync.id)return void showNotification("云同步尚未初始化","error");const e=buildPlaylistShareUrl(playlistSync.id);try{if(navigator.clipboard&&"function"==typeof navigator.clipboard.writeText)await navigator.clipboard.writeText(e),showNotification("云同步链接已复制","success");else{null!==window.prompt("复制云同步链接",e)&&showNotification("请在新浏览器中打开该链接以恢复播放列表","success")}}catch(e){console.warn("复制云同步链接失败",e),showNotification("复制失败，请手动复制链接","error")}}const SOURCE_OPTIONS=[{value:"netease",label:"网易云音乐"},{value:"kuwo",label:"酷我音乐"},{value:"joox",label:"JOOX音乐"}];function normalizeSource(e){return SOURCE_OPTIONS.map(e=>e.value).includes(e)?e:SOURCE_OPTIONS[0].value}const QUALITY_OPTIONS=[{value:"128",label:"标准音质",description:"128 kbps"},{value:"192",label:"高品音质",description:"192 kbps"},{value:"320",label:"极高音质",description:"320 kbps"},{value:"999",label:"无损音质",description:"FLAC"}];function normalizeQuality(e){const t=QUALITY_OPTIONS.find(t=>t.value===e);return t?t.value:"320"}const savedPlaylistSongs=(()=>{const e=parseJSON(safeGetLocalStorage("playlistSongs"),[]);return Array.isArray(e)?e:[]})(),savedPlaylistCollection=(()=>{const e=parseJSON(safeGetLocalStorage("playlists.v1"),null);if(!Array.isArray(e))return null;const t=[],a=new Set;for(const n of e){const e=normalizePlaylistEntry(n);let l=e.id;for(;a.has(l);)l=generateLocalPlaylistId();e.id=l,a.add(l),t.push(e)}return t})(),savedActivePlaylistId=(()=>{const e=safeGetLocalStorage("activePlaylistId.v1");return"string"==typeof e&&e.trim()?e.trim():null})(),savedCurrentTrackIndex=(()=>{const e=safeGetLocalStorage("currentTrackIndex"),t=Number.parseInt(e,10);return Number.isInteger(t)?t:-1})(),savedPlayMode=(()=>{const e=safeGetLocalStorage("playMode");return["list","single","random"].includes(e)?e:"list"})(),savedPlaybackQuality=normalizeQuality(safeGetLocalStorage("playbackQuality")),savedVolume=(()=>{const e=safeGetLocalStorage("playerVolume"),t=Number.parseFloat(e);return Number.isFinite(t)?Math.min(Math.max(t,0),1):.8})(),savedSearchSource=normalizeSource(safeGetLocalStorage("searchSource")),savedPlaybackTime=(()=>{const e=safeGetLocalStorage("currentPlaybackTime"),t=Number.parseFloat(e);return Number.isFinite(t)&&t>=0?t:0})(),savedCurrentSong=parseJSON(safeGetLocalStorage("currentSong"),null),savedCurrentPlaylist=(()=>{const e=safeGetLocalStorage("currentPlaylist");return["playlist","online","search"].includes(e)?e:"playlist"})(),initialPlaylists=(()=>{const e=savedPlaylistCollection&&savedPlaylistCollection.length?savedPlaylistCollection:null;if(e&&e.length)return e.map(e=>({id:e.id,name:normalizePlaylistName(e.name),songs:clonePlaylistSongs(e.songs)}));const t=clonePlaylistSongs(savedPlaylistSongs);return[normalizePlaylistEntry({id:generateLocalPlaylistId(),name:DEFAULT_PLAYLIST_NAME,songs:t})]})(),initialActivePlaylistId=initialPlaylists.length?savedActivePlaylistId&&initialPlaylists.some(e=>e.id===savedActivePlaylistId)?savedActivePlaylistId:initialPlaylists[0].id:null,initialActivePlaylist=(()=>{if(!initialPlaylists.length)return null;return initialPlaylists.find(e=>e.id===initialActivePlaylistId)||initialPlaylists[0]})(),initialPlaylistSongs=initialActivePlaylist?initialActivePlaylist.songs:[],API={baseUrl:"/proxy",generateSignature:()=>Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15),fetchJson:async e=>{try{const t=await fetch(e,{headers:{Accept:"application/json"}});if(!t.ok)throw new Error(`Request failed with status ${t.status}`);const a=await t.text();try{return JSON.parse(a)}catch(e){return console.warn("JSON parse failed, returning raw text",e),a}}catch(e){throw console.error("API request error:",e),e}},search:async(e,t="netease",a=20,n=1)=>{const l=API.generateSignature(),i=`${API.baseUrl}?types=search&source=${t}&name=${encodeURIComponent(e)}&count=${a}&pages=${n}&s=${l}`;try{debugLog(`API请求: ${i}`);const e=await API.fetchJson(i);if(debugLog(`API响应: ${JSON.stringify(e).substring(0,200)}...`),!Array.isArray(e))throw new Error("搜索结果格式错误");return e.map(e=>({id:e.id,name:e.name,artist:e.artist,album:e.album,pic_id:e.pic_id,url_id:e.url_id,lyric_id:e.lyric_id,source:e.source}))}catch(e){throw debugLog(`API错误: ${e.message}`),e}},getRadarPlaylist:async(e="3778678",t={})=>{const a=API.generateSignature();let n=50,l=0;"number"==typeof t?n=t:t&&"object"==typeof t&&(Number.isFinite(t.limit)?n=t.limit:Number.isFinite(t.count)&&(n=t.count),Number.isFinite(t.offset)&&(l=t.offset)),n=Math.max(1,Math.min(200,Math.trunc(n))||50),l=Math.max(0,Math.trunc(l)||0);const i=new URLSearchParams({types:"playlist",id:e,limit:String(n),offset:String(l),s:a}),o=`${API.baseUrl}?${i.toString()}`;try{const e=await API.fetchJson(o),t=e&&e.playlist&&Array.isArray(e.playlist.tracks)?e.playlist.tracks.slice(0,n):[];if(0===t.length)throw new Error("No tracks found");return t.map(e=>({id:e.id,name:e.name,artist:Array.isArray(e.ar)?e.ar.map(e=>e.name).join(" / "):"",source:"netease",lyric_id:e.id,pic_id:e.al?.pic_str||e.al?.pic||e.al?.picUrl||""}))}catch(e){throw console.error("API request failed:",e),e}},getNeteasePlaylistDetail:async(e,t={})=>{if(!e)throw new Error("缺少歌单ID");const a=Number.isFinite(t.limit)?Math.trunc(t.limit):null,n=Number.isFinite(t.maxTracks)?Math.trunc(t.maxTracks):null,l=Number.isFinite(t.offset)?Math.trunc(t.offset):null,i=Math.max(1,Math.min(200,a??200)),o=Math.max(i,Math.min(500,n??500));let s=Math.max(0,l??0);const r=[],c=new Set;let u=null,d=null,y=0;for(;r.length<o;){const t=new URLSearchParams({types:"playlist",id:e,limit:String(i),offset:String(s),s:API.generateSignature()}),a=`${API.baseUrl}?${t.toString()}`,n=await API.fetchJson(a),l=n&&n.playlist?n.playlist:null;if(!l)break;u||(u={id:l.id??e,name:l.name??"",trackCount:"number"==typeof l.trackCount?l.trackCount:null,coverImgUrl:l.coverImgUrl||l.cover?.imgUrl||""}),null==d&&"number"==typeof l.trackCount&&(d=l.trackCount);const m=Array.isArray(l.tracks)?l.tracks:[],p=r.length;for(const e of m){if(!e||"object"!=typeof e)continue;const t=e.id??e.trackId??e.song?.id;if(null==t)continue;const a=String(t);if(c.has(a))continue;c.add(a);const n=Array.isArray(e.ar)?e.ar.map(e=>e&&e.name?e.name:null).filter(Boolean):Array.isArray(e.artists)?e.artists.map(e=>e?"string"==typeof e?e:Array.isArray(e.alias)&&e.alias.length?e.alias[0]:e.name||null:null).filter(Boolean):[],l=n.length?n.join(" / "):"string"==typeof e.artist&&e.artist.trim()?e.artist:"未知艺术家",i=e.al?.name||e.album?.name||e.album||"",s=e.al?.pic_str||e.al?.pic||e.al?.picUrl||e.album?.picUrl||e.al?.coverImgId_str||e.al?.coverImgId||e.al?.picId||"";if(r.push({id:a,name:e.name||e.song?.name||`未命名歌曲 ${a}`,artist:l,album:i,source:"netease",lyric_id:e.id||e.lyricId||a,pic_id:s,url_id:a}),r.length>=o)break}if(r.length>=o)break;if(m.length<i)break;if(r.length===p)break;if(s+=m.length,y+=1,y>=5)break;if(null!=d&&s>=d)break}const m=d??u?.trackCount??null,p=r.length>=o,g=p||null!=m&&m>r.length;return{playlist:u||{id:e,name:"",trackCount:r.length,coverImgUrl:""},songs:r.slice(0,o),truncated:g,truncatedByLimit:p}},getSongUrl:(e,t="320")=>{const a=API.generateSignature();return`${API.baseUrl}?types=url&id=${e.id}&source=${e.source||"netease"}&br=${t}&s=${a}`},getLyric:e=>{const t=API.generateSignature();return`${API.baseUrl}?types=lyric&id=${e.lyric_id||e.id}&source=${e.source||"netease"}&s=${t}`},getPicUrl:e=>{const t=API.generateSignature();return`${API.baseUrl}?types=pic&id=${e.pic_id}&source=${e.source||"netease"}&size=300&s=${t}`}};Object.freeze(API);const state={onlineSongs:[],searchResults:[],renderedSearchCount:0,playlists:initialPlaylists,activePlaylistId:initialActivePlaylistId,currentTrackIndex:savedCurrentTrackIndex,currentAudioUrl:null,lyricsData:[],currentLyricLine:-1,currentPlaylist:savedCurrentPlaylist,searchPage:1,searchKeyword:"",searchSource:savedSearchSource,hasMoreResults:!0,currentSong:savedCurrentSong,debugMode:!1,isSearchMode:!1,playlistSongs:initialPlaylistSongs,playMode:savedPlayMode,playbackQuality:savedPlaybackQuality,volume:savedVolume,currentPlaybackTime:savedPlaybackTime,lastSavedPlaybackTime:savedPlaybackTime,pendingSeekTime:null,isSeeking:!1,qualityMenuOpen:!1,sourceMenuOpen:!1,playlistMenuOpen:!1,userScrolledLyrics:!1,lyricsScrollTimeout:null,themeDefaultsCaptured:!1,dynamicPalette:null,currentPaletteImage:null,pendingPaletteData:null,pendingPaletteImage:null,pendingPaletteImmediate:!1,pendingPaletteReady:!1,audioReadyForPalette:!0,currentGradient:"",isMobileInlineLyricsOpen:!1,defaultDocumentTitle:document.title,tabTitleBase:document.title,currentLyricForTitle:"",bilingualLyrics:!0};let playlistPickerElement=null;function getPlaylistById(e){return e&&state.playlists.find(t=>t.id===e)||null}function ensureActivePlaylist(){if(!state.playlists.length){const e=normalizePlaylistEntry({id:generateLocalPlaylistId(),name:DEFAULT_PLAYLIST_NAME,songs:[]});return state.playlists.push(e),state.activePlaylistId=e.id,state.playlistSongs=e.songs,e}let e=getPlaylistById(state.activePlaylistId);return e||(e=state.playlists[0],state.activePlaylistId=e.id,state.playlistSongs=e.songs),e}function getActivePlaylist(){return ensureActivePlaylist()}function setActivePlaylistSongs(e){const t=ensureActivePlaylist();return t.songs=Array.isArray(e)?clonePlaylistSongs(e):[],state.playlistSongs=t.songs,t}function getSongIdentityKey(e){if(!e||"object"!=typeof e)return"";return`${null!=e.id?String(e.id):JSON.stringify(e)}::${null!=e.source?String(e.source):""}`}function addSongToPlaylist(e,t=state.activePlaylistId){const a=getPlaylistById(t);if(!a||!e||"object"!=typeof e)return{added:!1,index:-1,playlist:a||null,duplicate:!1};a.songs=Array.isArray(a.songs)?a.songs:[];const n=a.songs,l=getSongIdentityKey(e),i=n.findIndex(e=>getSongIdentityKey(e)===l);return-1!==i?{added:!1,index:i,playlist:a,duplicate:!0}:(n.push(e),t===state.activePlaylistId&&(state.playlistSongs=n),{added:!0,index:n.length-1,playlist:a,duplicate:!1})}function addSongsToPlaylist(e,t=state.activePlaylistId){const a=getPlaylistById(t);if(!a||!Array.isArray(e)||!e.length)return{added:0,duplicates:0,playlist:a};a.songs=Array.isArray(a.songs)?a.songs:[];const n=new Set(a.songs.map(getSongIdentityKey));let l=0,i=0;for(const t of e){if(!t||"object"!=typeof t)continue;const e=getSongIdentityKey(t);n.has(e)?i+=1:(n.add(e),a.songs.push(t),l+=1)}return t===state.activePlaylistId&&(state.playlistSongs=a.songs),{added:l,duplicates:i,playlist:a}}function updatePlaylistSelectorLabel(){if(!dom.playlistSelectorLabel||!dom.playlistSelectorButton)return;const e=getActivePlaylist(),t=e?e.name:DEFAULT_PLAYLIST_NAME;if(dom.playlistSelectorLabel.textContent=t,dom.playlistSelectorButton.setAttribute("aria-expanded",state.playlistMenuOpen?"true":"false"),e?(dom.playlistSelectorButton.dataset.playlistId=e.id,dom.playlistSelectorButton.title=`当前歌单：${t}`):(dom.playlistSelectorButton.dataset.playlistId="",dom.playlistSelectorButton.title="选择歌单"),dom.deletePlaylistBtn){const e=state.playlists.length<=1;dom.deletePlaylistBtn.disabled=e,dom.deletePlaylistBtn.setAttribute("aria-disabled",e?"true":"false"),dom.deletePlaylistBtn.title=e?"至少保留一个歌单":"删除当前歌单"}}function buildPlaylistMenu(){if(dom.playlistMenu){if(dom.playlistMenu.innerHTML="",!state.playlists.length){const e=document.createElement("div");return e.className="playlist-selector__empty",e.textContent="暂无歌单",void dom.playlistMenu.appendChild(e)}state.playlists.forEach(e=>{const t=e.id===state.activePlaylistId,a=document.createElement("div");a.className="playlist-selector__item"+(t?" active":""),a.dataset.playlistId=e.id,a.setAttribute("role","option"),a.setAttribute("aria-selected",t?"true":"false");const n=document.createElement("span");n.className="playlist-selector__item-name",n.textContent=e.name;const l=document.createElement("span");l.className="playlist-selector__item-count",l.textContent=String(Array.isArray(e.songs)?e.songs.length:0),a.appendChild(n),a.appendChild(l),dom.playlistMenu.appendChild(a)})}}function openPlaylistMenu(){dom.playlistMenu&&dom.playlistSelectorButton&&(state.playlistMenuOpen||(closePlaylistPicker(),buildPlaylistMenu(),dom.playlistMenu.classList.add("show"),dom.playlistSelectorButton.setAttribute("aria-expanded","true"),state.playlistMenuOpen=!0))}function closePlaylistMenu(){dom.playlistMenu&&dom.playlistSelectorButton?(dom.playlistMenu.classList.remove("show"),dom.playlistSelectorButton.setAttribute("aria-expanded","false"),state.playlistMenuOpen=!1):state.playlistMenuOpen=!1}function togglePlaylistMenu(e){e&&(e.preventDefault(),e.stopPropagation()),state.playlistMenuOpen?closePlaylistMenu():openPlaylistMenu()}function handlePlaylistMenuSelection(e){const t=e.target.closest(".playlist-selector__item");if(!t)return;const a=t.dataset.playlistId;closePlaylistMenu(),a&&switchActivePlaylist(a)}function switchActivePlaylist(e){const t=getPlaylistById(e);t&&t.id!==state.activePlaylistId?(closePlaylistPicker(),closePlaylistMenu(),state.activePlaylistId=t.id,state.playlistSongs=t.songs,state.currentPlaylist="playlist","playlist"===state.currentPlaylist&&(state.currentTrackIndex=-1),renderPlaylist()):updatePlaylistSelectorLabel()}function promptForPlaylistName(e=""){const t=normalizePlaylistName(e||`新歌单${state.playlists.length+1}`),a=window.prompt("输入歌单名称",t);if(null===a)return null;return normalizePlaylistName(a)||t}function createPlaylistWithName(e,{activate:t=!0,songs:a=[]}={}){const n=normalizePlaylistEntry({id:generateLocalPlaylistId(),name:e,songs:a});return state.playlists.push(n),t&&(state.activePlaylistId=n.id,state.playlistSongs=n.songs,state.currentTrackIndex=-1),buildPlaylistMenu(),updatePlaylistSelectorLabel(),t||savePlayerState(),n}function handleCreatePlaylist(){closePlaylistPicker(),closePlaylistMenu();const e=promptForPlaylistName();if(null===e)return;const t=createPlaylistWithName(e,{activate:!0});state.currentPlaylist="playlist",renderPlaylist(),showNotification(`已创建歌单「${t.name}」`,"success")}function deleteActivePlaylist(){if(state.playlists.length<=1)return void showNotification("至少保留一个歌单","warning");closePlaylistPicker(),closePlaylistMenu();const e=getActivePlaylist();if(!e)return;const t=e.songs.length?`确定删除歌单「${e.name}」？这将移除其中的 ${e.songs.length} 首歌曲`:`确定删除歌单「${e.name}」？`;if(!window.confirm(t))return;const a=state.playlists.findIndex(t=>t.id===e.id);if(-1===a)return;"playlist"===state.currentPlaylist&&state.activePlaylistId===e.id&&clearPlaylist({silent:!0}),state.playlists.splice(a,1);const n=state.playlists[a]||state.playlists[a-1]||state.playlists[0]||null;if(n)state.activePlaylistId=n.id,state.playlistSongs=n.songs;else{const e=createPlaylistWithName(DEFAULT_PLAYLIST_NAME,{activate:!0});state.activePlaylistId=e.id,state.playlistSongs=e.songs}state.currentPlaylist="playlist",renderPlaylist(),showNotification(`已删除歌单「${e.name}」`,"success")}async function handleImportNeteasePlaylist(){closePlaylistPicker(),closePlaylistMenu();const e=window.prompt("输入网易云歌单链接或ID","");if(null===e)return;const t=extractNeteasePlaylistId(e);if(!t)return void showNotification("请输入有效的网易云歌单链接或ID","error");const a=dom.importPlaylistBtn;let n=null;a&&(n=a.innerHTML,a.disabled=!0,a.setAttribute("aria-busy","true"),a.innerHTML='<i class="fas fa-spinner fa-spin"></i>');try{const{playlist:e,songs:a,truncated:n,truncatedByLimit:l}=await API.getNeteasePlaylistDetail(t,{limit:200,maxTracks:500,offset:0});if(!a.length)return void showNotification("未能从该歌单导入歌曲，请检查链接是否正确","error");const i=getActivePlaylist(),o=i?i.name:DEFAULT_PLAYLIST_NAME,s=e&&e.name?e.name:"网易云歌单";if(!(!e||!e.name)&&window.confirm(`导入歌单「${e.name}」，是否创建新的本地歌单保存？\n选择“确定”创建新歌单，选择“取消”将歌曲添加到当前歌单「${o}」。`)){const e=promptForPlaylistName(s);if(null===e)return void showNotification("已取消导入","warning");const t=createPlaylistWithName(e,{activate:!0,songs:a});if(state.currentPlaylist="playlist",state.currentTrackIndex=-1,renderPlaylist(),showNotification(`已导入 ${a.length} 首歌曲到新歌单「${t.name}」`,"success"),n){showNotification(l?"部分歌曲未导入，已达到导入上限（最多 500 首）":"部分歌曲未导入，网易云接口未返回全部歌曲","warning")}return}const r=i?i.id:state.activePlaylistId,c=addSongsToPlaylist(a,r),u=getPlaylistById(r);if(c.added>0){u&&u.id===state.activePlaylistId?renderPlaylist():(buildPlaylistMenu(),updatePlaylistSelectorLabel(),savePlayerState());let e=`已导入 ${c.added} 首歌曲到「${u?u.name:DEFAULT_PLAYLIST_NAME}」`;if(c.duplicates>0&&(e+=`，跳过 ${c.duplicates} 首已存在的歌曲`),showNotification(e,"success"),n){showNotification(l?"部分歌曲未导入，已达到导入上限（最多 500 首）":"部分歌曲未导入，网易云接口未返回全部歌曲","warning")}}else showNotification("导入的歌曲已全部存在当前歌单","warning")}catch(e){console.error("导入网易云歌单失败:",e);showNotification(`导入失败：${e&&e.message?e.message:"导入失败"}`,"error")}finally{a&&(a.disabled=!1,a.setAttribute("aria-busy","false"),null!=n&&(a.innerHTML=n))}}function closePlaylistPicker(){playlistPickerElement&&playlistPickerElement.parentNode&&playlistPickerElement.parentNode.removeChild(playlistPickerElement),playlistPickerElement=null}function openPlaylistPickerForSearchResult(e,t){const a=state.searchResults[t];if(!a||!e)return;closePlaylistMenu(),closePlaylistPicker();const n=document.createElement("div");if(n.className="playlist-picker",state.playlists.length)state.playlists.forEach(e=>{const t=document.createElement("button");t.type="button",t.className="playlist-picker__item"+(e.id===state.activePlaylistId?" playlist-picker__item--active":""),t.dataset.playlistId=e.id;const l=document.createElement("span");l.className="playlist-picker__item-name",l.textContent=e.name;const i=document.createElement("span");i.className="playlist-picker__item-count",i.textContent=String(Array.isArray(e.songs)?e.songs.length:0),t.appendChild(l),t.appendChild(i),t.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation();const n=addSongToPlaylist(a,e.id);e.id===state.activePlaylistId?renderPlaylist():n.added&&(buildPlaylistMenu(),savePlayerState()),closePlaylistPicker(),n.added?showNotification(`已添加到「${e.name}」`,"success"):n.duplicate&&showNotification("歌曲已在歌单中","warning")}),n.appendChild(t)});else{const e=document.createElement("div");e.className="playlist-picker__empty",e.textContent="暂无歌单，请先创建一个",n.appendChild(e)}const l=document.createElement("button");l.type="button",l.className="playlist-picker__item playlist-picker__item--create";const i=document.createElement("span");i.className="playlist-picker__item-name";const o=document.createElement("i");o.className="fas fa-plus playlist-picker__item-icon",o.setAttribute("aria-hidden","true"),i.appendChild(o),i.appendChild(document.createTextNode("新建歌单")),l.appendChild(i),l.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),closePlaylistPicker();const t=promptForPlaylistName();if(null===t)return;const n=createPlaylistWithName(t,{activate:!0}),l=addSongToPlaylist(a,n.id);renderPlaylist(),l.added?showNotification(`已创建歌单并添加到「${n.name}」`,"success"):l.duplicate&&showNotification("歌曲已在歌单中","warning")}),n.appendChild(l),n.addEventListener("click",e=>{e.stopPropagation()}),document.body.appendChild(n);const s=e.getBoundingClientRect(),r=n.getBoundingClientRect(),c=Math.max(window.innerWidth||0,document.documentElement.clientWidth||0),u=Math.max(window.innerHeight||0,document.documentElement.clientHeight||0);let d=s.left,y=s.bottom+8;d+r.width>c-16&&(d=Math.max(16,c-r.width-16)),y+r.height>u-16&&(y=Math.max(16,s.top-r.height-8)),n.style.left=`${d}px`,n.style.top=`${y}px`,playlistPickerElement=n}function applyDocumentTitle(){const e=state.defaultDocumentTitle||document.title||"",t=(state.currentLyricForTitle||"").trim(),a=(state.tabTitleBase||e).trim(),n=[];t&&n.push(t),a&&a!==t&&n.push(a);const l=n.join(" · ")||e;document.title!==l&&(document.title=l)}function setTabTitleBase(e){const t=state.defaultDocumentTitle||document.title||"",a=("string"==typeof e?e.trim():"")||t;state.tabTitleBase!==a&&(state.tabTitleBase=a),applyDocumentTitle()}function setTabTitleLyric(e){const t="string"==typeof e?e.trim():"";state.currentLyricForTitle!==t&&(state.currentLyricForTitle=t),applyDocumentTitle()}let sourceMenuPositionFrame=null,qualityMenuPositionFrame=null,floatingMenuListenersAttached=!1,qualityMenuAnchor=null;function runWithoutTransition(e,t){if(!e||"function"!=typeof t)return;const a=e.style.transition;e.style.transition="none",t(),e.offsetHeight,a?e.style.transition=a:e.style.removeProperty("transition")}function cancelSourceMenuPositionUpdate(){null!==sourceMenuPositionFrame&&(window.cancelAnimationFrame(sourceMenuPositionFrame),sourceMenuPositionFrame=null)}function scheduleSourceMenuPositionUpdate(){state.sourceMenuOpen?null===sourceMenuPositionFrame&&(sourceMenuPositionFrame=window.requestAnimationFrame(()=>{sourceMenuPositionFrame=null,updateSourceMenuPosition()})):cancelSourceMenuPositionUpdate()}function cancelPlayerQualityMenuPositionUpdate(){null!==qualityMenuPositionFrame&&(window.cancelAnimationFrame(qualityMenuPositionFrame),qualityMenuPositionFrame=null)}function schedulePlayerQualityMenuPositionUpdate(){state.qualityMenuOpen?null===qualityMenuPositionFrame&&(qualityMenuPositionFrame=window.requestAnimationFrame(()=>{qualityMenuPositionFrame=null,updatePlayerQualityMenuPosition()})):cancelPlayerQualityMenuPositionUpdate()}function handleFloatingMenuResize(){state.sourceMenuOpen&&scheduleSourceMenuPositionUpdate(),state.qualityMenuOpen&&schedulePlayerQualityMenuPositionUpdate()}function handleFloatingMenuScroll(){state.sourceMenuOpen&&scheduleSourceMenuPositionUpdate(),state.qualityMenuOpen&&schedulePlayerQualityMenuPositionUpdate()}function ensureFloatingMenuListeners(){floatingMenuListenersAttached||(window.addEventListener("resize",handleFloatingMenuResize),window.addEventListener("scroll",handleFloatingMenuScroll,{passive:!0,capture:!0}),floatingMenuListenersAttached=!0)}function releaseFloatingMenuListenersIfIdle(){state.sourceMenuOpen||state.qualityMenuOpen||floatingMenuListenersAttached&&(window.removeEventListener("resize",handleFloatingMenuResize),window.removeEventListener("scroll",handleFloatingMenuScroll,!0),floatingMenuListenersAttached=!1)}function setGlobalThemeProperty(e,t){"string"==typeof e&&(document.documentElement.style.setProperty(e,t),document.body&&document.body.style.setProperty(e,t))}function removeGlobalThemeProperty(e){"string"==typeof e&&(document.documentElement.style.removeProperty(e),document.body&&document.body.style.removeProperty(e))}function captureThemeDefaults(){if(state.themeDefaultsCaptured)return;const e=document.body.classList.contains("dark-mode");document.body.classList.remove("dark-mode");const t=getComputedStyle(document.body);themeDefaults.light.gradient=t.getPropertyValue("--bg-gradient").trim(),themeDefaults.light.primaryColor=t.getPropertyValue("--primary-color").trim(),themeDefaults.light.primaryColorDark=t.getPropertyValue("--primary-color-dark").trim(),document.body.classList.add("dark-mode");const a=getComputedStyle(document.body);themeDefaults.dark.gradient=a.getPropertyValue("--bg-gradient").trim(),themeDefaults.dark.primaryColor=a.getPropertyValue("--primary-color").trim(),themeDefaults.dark.primaryColorDark=a.getPropertyValue("--primary-color-dark").trim(),e||document.body.classList.remove("dark-mode"),state.themeDefaultsCaptured=!0}function applyThemeTokens(e){e&&(e.primaryColor&&setGlobalThemeProperty("--primary-color",e.primaryColor),e.primaryColorDark&&setGlobalThemeProperty("--primary-color-dark",e.primaryColorDark))}function setDocumentGradient(e,{immediate:t=!1}={}){const a=(e||"").trim(),n=(state.currentGradient||"").trim(),l=t||a===n;return dom.backgroundTransitionLayer&&dom.backgroundBaseLayer?(window.clearTimeout(backgroundTransitionTimer),l?(a?(setGlobalThemeProperty("--bg-gradient",a),setGlobalThemeProperty("--bg-gradient-next",a)):(removeGlobalThemeProperty("--bg-gradient"),removeGlobalThemeProperty("--bg-gradient-next")),document.body.classList.remove("background-transitioning"),void(state.currentGradient=a)):(a?setGlobalThemeProperty("--bg-gradient-next",a):removeGlobalThemeProperty("--bg-gradient-next"),void requestAnimationFrame(()=>{document.body.classList.add("background-transitioning"),backgroundTransitionTimer=window.setTimeout(()=>{a?(setGlobalThemeProperty("--bg-gradient",a),setGlobalThemeProperty("--bg-gradient-next",a)):(removeGlobalThemeProperty("--bg-gradient"),removeGlobalThemeProperty("--bg-gradient-next")),document.body.classList.remove("background-transitioning"),state.currentGradient=a},850)}))):(a?(setGlobalThemeProperty("--bg-gradient",a),setGlobalThemeProperty("--bg-gradient-next",a)):(removeGlobalThemeProperty("--bg-gradient"),removeGlobalThemeProperty("--bg-gradient-next")),void(state.currentGradient=a))}function applyDynamicGradient(e={}){state.themeDefaultsCaptured||captureThemeDefaults();const t=document.body.classList.contains("dark-mode")?"dark":"light",a=themeDefaults[t];let n=a.gradient||"";applyThemeTokens(a);const l=state.dynamicPalette;if(l&&l.gradients){const e=l.gradients;let a=t,i=e[a]||null;if(!i){const t="dark"===a?["light"]:["dark"];for(const n of t)if(e[n]){a=n,i=e[n];break}if(!i){const t=Object.keys(e);if(t.length){const n=t[0];a=n,i=e[n]}}}if(i&&i.gradient&&(n=i.gradient),l.tokens){const e=l.tokens[a]||l.tokens[t];e&&applyThemeTokens(e)}}setDocumentGradient(n,e)}function queueDefaultPalette(e={}){window.clearTimeout(pendingPaletteTimer),pendingPaletteTimer=null,cancelDeferredPaletteUpdate(),state.pendingPaletteData=null,state.pendingPaletteImage=null,state.pendingPaletteImmediate=Boolean(e.immediate),state.pendingPaletteReady=!0,attemptPaletteApplication()}function resetDynamicBackground(e={}){paletteRequestId+=1,cancelDeferredPaletteUpdate(),paletteAbortController&&(paletteAbortController.abort(),paletteAbortController=null),state.dynamicPalette=null,state.currentPaletteImage=null,queueDefaultPalette(e)}function queuePaletteApplication(e,t,a={}){window.clearTimeout(pendingPaletteTimer),pendingPaletteTimer=null,state.pendingPaletteData=e||null,state.pendingPaletteImage=t||null,state.pendingPaletteImmediate=Boolean(a.immediate),state.pendingPaletteReady=!0,attemptPaletteApplication()}function cancelDeferredPaletteUpdate(){null!==deferredPaletteHandle&&("idle"===deferredPaletteType&&"function"==typeof window.cancelIdleCallback?window.cancelIdleCallback(deferredPaletteHandle):window.clearTimeout(deferredPaletteHandle),deferredPaletteHandle=null,deferredPaletteType="",deferredPaletteUrl=null)}function scheduleDeferredPaletteUpdate(e,t={}){const a=Boolean(t.immediate);cancelDeferredPaletteUpdate(),paletteAbortController&&(paletteAbortController.abort(),paletteAbortController=null),state.currentPaletteImage=null,queueDefaultPalette({immediate:a})}function attemptPaletteApplication(){if(!state.pendingPaletteReady||!state.audioReadyForPalette)return;const e=state.pendingPaletteData||null,t=state.pendingPaletteImage||null,a=state.pendingPaletteImmediate;state.pendingPaletteData=null,state.pendingPaletteImage=null,state.pendingPaletteImmediate=!1,state.pendingPaletteReady=!1;if(a)return pendingPaletteTimer=null,state.dynamicPalette=e,state.currentPaletteImage=t,void applyDynamicGradient({immediate:!0});pendingPaletteTimer=window.setTimeout(()=>{pendingPaletteTimer=null,state.dynamicPalette=e,state.currentPaletteImage=t,applyDynamicGradient({immediate:!1})},140)}function showAlbumCoverPlaceholder(){dom.albumCover.innerHTML=PLACEHOLDER_HTML,dom.albumCover.classList.remove("loading"),queueDefaultPalette()}function setAlbumCoverImage(e){dom.albumCover.innerHTML=`<img src="${e}" alt="专辑封面">`,dom.albumCover.classList.remove("loading")}async function fetchPaletteData(e,t){if(paletteCache.has(e)){const t=paletteCache.get(e);return paletteCache.delete(e),paletteCache.set(e,t),t}const a=await fetch(`/palette?image=${encodeURIComponent(e)}`,{signal:t}),n=await a.text();let l=null;try{l=n?JSON.parse(n):null}catch(e){console.warn("解析调色板响应失败:",e)}if(!a.ok){const e=l&&l.error?` (${l.error})`:"";throw new Error(`Palette request failed: ${a.status}${e}`)}if(null===l)throw new Error("Palette response missing body");const i=l;return paletteCache.has(e)&&paletteCache.delete(e),paletteCache.set(e,i),persistPaletteCache(),i}async function updateDynamicBackground(e){paletteRequestId+=1;const t=paletteRequestId;if(!e)return void resetDynamicBackground();if(paletteAbortController&&(paletteAbortController.abort(),paletteAbortController=null),paletteCache.has(e)){const t=paletteCache.get(e);return paletteCache.delete(e),paletteCache.set(e,t),void queuePaletteApplication(t,e)}if(state.currentPaletteImage===e&&state.dynamicPalette)return void queuePaletteApplication(state.dynamicPalette,e);let a=null;try{paletteAbortController&&paletteAbortController.abort(),a=new AbortController,paletteAbortController=a;const n=await fetchPaletteData(e,a.signal);if(t!==paletteRequestId)return;queuePaletteApplication(n,e)}catch(e){if("AbortError"===e?.name)return;console.warn("获取动态背景失败:",e),t===paletteRequestId&&resetDynamicBackground()}finally{a&&paletteAbortController===a&&(paletteAbortController=null)}}function savePlayerState(){safeSetLocalStorage("playlistSongs",JSON.stringify(state.playlistSongs)),safeSetLocalStorage("playlists.v1",JSON.stringify(state.playlists)),state.activePlaylistId?safeSetLocalStorage("activePlaylistId.v1",state.activePlaylistId):safeRemoveLocalStorage("activePlaylistId.v1"),safeSetLocalStorage("currentTrackIndex",String(state.currentTrackIndex)),safeSetLocalStorage("playMode",state.playMode),safeSetLocalStorage("playbackQuality",state.playbackQuality),safeSetLocalStorage("playerVolume",String(state.volume)),safeSetLocalStorage("currentPlaylist",state.currentPlaylist),state.currentSong?safeSetLocalStorage("currentSong",JSON.stringify(state.currentSong)):safeSetLocalStorage("currentSong",""),safeSetLocalStorage("currentPlaybackTime",String(state.currentPlaybackTime||0));const e=computePlaylistSyncSnapshot();if(isRestoringPlaylistFromRemote)return playlistSync.lastSyncedSnapshot=e,persistPlaylistSyncMeta(),void updatePlaylistSyncUI();handlePlaylistSyncChange(e),updatePlaylistSyncUI()}function debugLog(e){if(console.log(`[DEBUG] ${e}`),state.debugMode){const t=dom.debugInfo;t.innerHTML+=`<div>${(new Date).toLocaleTimeString()}: ${e}</div>`,t.classList.add("show"),t.scrollTop=t.scrollHeight}}function toggleSearchMode(e){state.isSearchMode=e,e?(dom.container.classList.add("search-mode"),debugLog("进入搜索模式")):(dom.container.classList.remove("search-mode"),debugLog("退出搜索模式"))}function showSearchResults(){toggleSearchMode(!0),state.sourceMenuOpen&&scheduleSourceMenuPositionUpdate(),state.qualityMenuOpen&&schedulePlayerQualityMenuPositionUpdate()}function hideSearchResults(){toggleSearchMode(!1),state.sourceMenuOpen&&scheduleSourceMenuPositionUpdate(),state.qualityMenuOpen&&schedulePlayerQualityMenuPositionUpdate(),dom.searchResults.innerHTML="",state.renderedSearchCount=0}state.currentGradient=getComputedStyle(document.documentElement).getPropertyValue("--bg-gradient").trim(),state.currentGradient&&setGlobalThemeProperty("--bg-gradient-next",state.currentGradient),loadStoredPalettes(),document.addEventListener("keydown",e=>{e.ctrlKey&&"d"===e.key&&(e.preventDefault(),state.debugMode=!state.debugMode,state.debugMode?(dom.debugInfo.classList.add("show"),debugLog("调试模式已启用")):dom.debugInfo.classList.remove("show"))});const playModeTexts={list:"列表循环",single:"单曲循环",random:"随机播放"},playModeIcons={list:"fa-repeat",single:"fa-redo",random:"fa-shuffle"};function updatePlayModeUI(){const e=state.playMode;dom.playModeBtn.innerHTML=`<i class="fas ${playModeIcons[e]||playModeIcons.list}"></i>`,dom.playModeBtn.title=`播放模式: ${playModeTexts[e]||playModeTexts.list}`}function togglePlayMode(){const e=["list","single","random"],t=(e.indexOf(state.playMode)+1)%e.length;state.playMode=e[t],updatePlayModeUI(),savePlayerState();showNotification(`播放模式: ${playModeTexts[state.playMode]||playModeTexts.list}`),debugLog(`播放模式切换为: ${state.playMode}`)}function formatTime(e){if(!Number.isFinite(e)||e<0)return"00:00";const t=Math.floor(e),a=Math.floor(t/60),n=t%60;return`${String(a).padStart(2,"0")}:${String(n).padStart(2,"0")}`}function updatePlayPauseButton(){if(!dom.playPauseBtn)return;const e=!dom.audioPlayer.paused&&!dom.audioPlayer.ended;dom.playPauseBtn.innerHTML=`<i class="fas ${e?"fa-pause":"fa-play"}"></i>`,dom.playPauseBtn.title=e?"暂停":"播放",document.body&&document.body.classList.toggle("is-playing",e)}function updateProgressBarBackground(e=Number(dom.progressBar.value),t=Number(dom.progressBar.max)){const a=Number.isFinite(t)&&t>0?t:0,n=Number.isFinite(e)?Math.max(e,0):0,l=a>0?100*Math.min(n/a,1):0;dom.progressBar.style.setProperty("--progress",`${l}%`)}function updateVolumeSliderBackground(e=dom.audioPlayer.volume){const t=Math.min(Math.max(Number.isFinite(e)?e:0,0),1);dom.volumeSlider.style.setProperty("--volume-progress",100*t+"%")}function updateVolumeIcon(e){if(!dom.volumeIcon)return;const t=Math.min(Math.max(Number.isFinite(e)?e:0,0),1);let a="fa-volume-high";0===t?a="fa-volume-xmark":t<.4&&(a="fa-volume-low"),dom.volumeIcon.className=`fas ${a}`}function onAudioVolumeChange(){const e=dom.audioPlayer.volume;state.volume=e,dom.volumeSlider.value=e,updateVolumeSliderBackground(e),updateVolumeIcon(e),savePlayerState()}function handleVolumeChange(e){const t=Number.parseFloat(e.target.value),a=Number.isFinite(t)?Math.min(Math.max(t,0),1):dom.audioPlayer.volume;dom.audioPlayer.volume=a,state.volume=a,updateVolumeSliderBackground(a),updateVolumeIcon(a),safeSetLocalStorage("playerVolume",String(a))}function handleTimeUpdate(){const e=dom.audioPlayer.currentTime||0;state.isSeeking||(dom.progressBar.value=e,dom.currentTimeDisplay.textContent=formatTime(e),updateProgressBarBackground(e,Number(dom.progressBar.max))),syncLyrics(),state.currentPlaybackTime=e,Math.abs(e-state.lastSavedPlaybackTime)>=2&&(state.lastSavedPlaybackTime=e,safeSetLocalStorage("currentPlaybackTime",e.toFixed(1)))}function handleLoadedMetadata(){const e=dom.audioPlayer.duration||0;dom.progressBar.max=e,dom.durationDisplay.textContent=formatTime(e),updateProgressBarBackground(dom.audioPlayer.currentTime||0,e),null!=state.pendingSeekTime&&(setAudioCurrentTime(state.pendingSeekTime),state.pendingSeekTime=null)}function setAudioCurrentTime(e){if(!Number.isFinite(e))return;const t=dom.audioPlayer.duration||Number(dom.progressBar.max)||0,a=t>0?Math.min(Math.max(e,0),t):Math.max(e,0);try{dom.audioPlayer.currentTime=a}catch(e){console.warn("设置播放进度失败",e)}dom.progressBar.value=a,dom.currentTimeDisplay.textContent=formatTime(a),updateProgressBarBackground(a,t),state.currentPlaybackTime=a}function handleProgressInput(){state.isSeeking=!0;const e=Number(dom.progressBar.value);dom.currentTimeDisplay.textContent=formatTime(e),updateProgressBarBackground(e,Number(dom.progressBar.max))}function handleProgressChange(){const e=Number(dom.progressBar.value);state.isSeeking=!1,seekAudio(e)}function seekAudio(e){Number.isFinite(e)&&(setAudioCurrentTime(e),state.lastSavedPlaybackTime=state.currentPlaybackTime,safeSetLocalStorage("currentPlaybackTime",state.currentPlaybackTime.toFixed(1)))}async function togglePlayPause(){if(state.currentSong)if(dom.audioPlayer.src)if(dom.audioPlayer.paused){const e=dom.audioPlayer.play();void 0!==e&&e.catch(e=>{console.error("播放失败:",e),showNotification("播放失败，请检查网络连接","error")})}else dom.audioPlayer.pause();else try{await playSong(state.currentSong,{autoplay:!0,startTime:state.currentPlaybackTime,preserveProgress:!0})}catch(e){console.error("恢复播放失败:",e),showNotification("播放失败，请稍后重试","error")}else if(state.playlistSongs.length>0){const e=state.currentTrackIndex>=0&&state.currentTrackIndex<state.playlistSongs.length?state.currentTrackIndex:0;await playPlaylistSong(e)}else showNotification("播放列表为空，请先添加歌曲","error")}function buildSourceMenu(){if(!dom.sourceMenu)return;const e=SOURCE_OPTIONS.map(e=>{const t=e.value===state.searchSource;return`\n            <div class="source-option${t?" active":""}" data-source="${e.value}" role="option" aria-selected="${t}">\n                <span>${e.label}</span>\n                ${t?'<i class="fas fa-check" aria-hidden="true"></i>':""}\n            </div>\n        `}).join("");dom.sourceMenu.innerHTML=e,state.sourceMenuOpen&&scheduleSourceMenuPositionUpdate()}function updateSourceLabel(){const e=SOURCE_OPTIONS.find(e=>e.value===state.searchSource)||SOURCE_OPTIONS[0];e&&dom.sourceSelectLabel&&dom.sourceSelectButton&&(dom.sourceSelectLabel.textContent=e.label,dom.sourceSelectButton.dataset.source=e.value,dom.sourceSelectButton.setAttribute("aria-expanded",state.sourceMenuOpen?"true":"false"),dom.sourceSelectButton.setAttribute("aria-label",`当前音源：${e.label}，点击切换音源`),dom.sourceSelectButton.setAttribute("title",`音源：${e.label}`))}function updateSourceMenuPosition(){if(!state.sourceMenuOpen||!dom.sourceMenu||!dom.sourceSelectButton)return;const e=dom.sourceMenu,t=dom.sourceSelectButton,a=Math.ceil(t.getBoundingClientRect().width),n=Math.max(a,140);e.style.left="0px",e.style.width=`${n}px`,e.style.minWidth=`${n}px`,e.style.maxWidth=`${n}px`;const l=Math.max(e.scrollHeight,0),i=t.getBoundingClientRect(),o=Math.max(window.innerHeight||0,document.documentElement.clientHeight||0),s=Math.max(o-i.bottom-10,0),r=i.top-10-l>=0;l>s&&r?(e.classList.add("open-upwards"),e.classList.remove("open-downwards"),e.style.top="",e.style.bottom=`${t.offsetHeight+10}px`):(e.classList.add("open-downwards"),e.classList.remove("open-upwards"),e.style.bottom="",e.style.top=`${t.offsetHeight+10}px`)}function resetSourceMenuPosition(){dom.sourceMenu&&(dom.sourceMenu.classList.remove("open-upwards","open-downwards"),dom.sourceMenu.style.top="",dom.sourceMenu.style.left="",dom.sourceMenu.style.bottom="",dom.sourceMenu.style.minWidth="",dom.sourceMenu.style.maxWidth="",dom.sourceMenu.style.width="")}function openSourceMenu(){dom.sourceMenu&&dom.sourceSelectButton&&(state.sourceMenuOpen=!0,ensureFloatingMenuListeners(),buildSourceMenu(),dom.sourceMenu.classList.add("show"),dom.sourceSelectButton.classList.add("active"),dom.sourceSelectButton.setAttribute("aria-expanded","true"),updateSourceMenuPosition(),scheduleSourceMenuPositionUpdate())}function closeSourceMenu(){dom.sourceMenu&&(dom.sourceMenu.classList.remove("show"),dom.sourceSelectButton.classList.remove("active"),dom.sourceSelectButton.setAttribute("aria-expanded","false"),state.sourceMenuOpen=!1,cancelSourceMenuPositionUpdate(),resetSourceMenuPosition(),releaseFloatingMenuListenersIfIdle())}function toggleSourceMenu(e){e.preventDefault(),e.stopPropagation(),state.sourceMenuOpen?closeSourceMenu():openSourceMenu()}function handleSourceSelection(e){const t=e.target.closest(".source-option");if(!t)return;e.preventDefault(),e.stopPropagation();const{source:a}=t.dataset;a&&selectSearchSource(a)}function selectSearchSource(e){const t=normalizeSource(e);t!==state.searchSource?(state.searchSource=t,safeSetLocalStorage("searchSource",t),updateSourceLabel(),buildSourceMenu(),closeSourceMenu()):closeSourceMenu()}function buildQualityMenu(){if(!dom.playerQualityMenu)return;const e=QUALITY_OPTIONS.map(e=>`\n            <div class="player-quality-option${e.value===state.playbackQuality?" active":""}" data-quality="${e.value}">\n                <span>${e.label}</span>\n                <small>${e.description}</small>\n            </div>\n        `).join("");dom.playerQualityMenu.innerHTML=e,state.qualityMenuOpen&&schedulePlayerQualityMenuPositionUpdate()}function isElementNode(e){return Boolean(e)&&"object"==typeof e&&1===e.nodeType}function resolveQualityAnchor(e){return isElementNode(e)?e:isElementNode(dom.qualityToggle)?dom.qualityToggle:isElementNode(dom.mobileQualityToggle)?dom.mobileQualityToggle:null}function setQualityAnchorState(e,t){isElementNode(e)&&(e.classList.toggle("active",Boolean(t)),"function"==typeof e.setAttribute&&e.setAttribute("aria-expanded",t?"true":"false"))}function getQualityMenuAnchor(){if(isElementNode(qualityMenuAnchor)&&(!document.body||document.body.contains(qualityMenuAnchor)))return qualityMenuAnchor;const e=resolveQualityAnchor();return qualityMenuAnchor=e,e}function updateQualityLabel(){const e=QUALITY_OPTIONS.find(e=>e.value===state.playbackQuality)||QUALITY_OPTIONS[0];e&&(dom.qualityLabel.textContent=e.label,dom.qualityToggle.title=`音质: ${e.label} (${e.description})`,dom.mobileQualityLabel&&(dom.mobileQualityLabel.textContent=e.label),dom.mobileQualityToggle&&(dom.mobileQualityToggle.title=`音质: ${e.label} (${e.description})`))}function togglePlayerQualityMenu(e){e&&(e.preventDefault(),e.stopPropagation());const t=resolveQualityAnchor(e&&e.currentTarget?e.currentTarget:qualityMenuAnchor);t&&(state.qualityMenuOpen&&qualityMenuAnchor===t?closePlayerQualityMenu():openPlayerQualityMenu(t))}function updatePlayerQualityMenuPosition(){if(!state.qualityMenuOpen||!dom.playerQualityMenu)return;const e=getQualityMenuAnchor();if(!isElementNode(e))return;const t=dom.playerQualityMenu,a=e.getBoundingClientRect(),n=Math.max(window.innerWidth||0,document.documentElement.clientWidth||0),l=Math.max(window.innerHeight||0,document.documentElement.clientHeight||0),i=10;t.classList.add("floating");const o=Math.max(Math.round(a.width),180);t.style.minWidth=`${o}px`,t.style.maxWidth=`${o}px`,t.style.width=`${o}px`,t.style.right="auto";const s=t.getBoundingClientRect(),r=Math.round(s.height),c=Math.round(s.width)||o;let u=Math.round(a.bottom+i),d=!1;if(u+r>l-i){const e=Math.round(a.top-i-r);e>=i?(u=e,d=!0):u=Math.max(i,l-i-r)}const y=(()=>{if("function"==typeof window.matchMedia){const e=window.matchMedia("(orientation: portrait)");if("boolean"==typeof e.matches)return e.matches}return l>=n})();let m;m=isMobileView&&y?Math.round(a.left+(a.width-c)/2):Math.round(a.right-c);const p=Math.max(10,n-i-c);m=Math.min(Math.max(m,10),p),t.style.top=`${u}px`,t.style.left=`${m}px`,t.classList.toggle("open-upwards",d),t.classList.toggle("open-downwards",!d)}function resetPlayerQualityMenuPosition(){dom.playerQualityMenu&&(dom.playerQualityMenu.classList.remove("floating","open-upwards","open-downwards"),dom.playerQualityMenu.style.top="",dom.playerQualityMenu.style.left="",dom.playerQualityMenu.style.right="",dom.playerQualityMenu.style.minWidth="",dom.playerQualityMenu.style.maxWidth="",dom.playerQualityMenu.style.width="")}function openPlayerQualityMenu(e){if(!dom.playerQualityMenu)return;const t=resolveQualityAnchor(e);if(!t)return;qualityMenuAnchor&&qualityMenuAnchor!==t&&setQualityAnchorState(qualityMenuAnchor,!1),qualityMenuAnchor=t,state.qualityMenuOpen=!0,ensureFloatingMenuListeners();const a=dom.playerQualityMenu;setQualityAnchorState(qualityMenuAnchor,!0),a.classList.add("floating"),a.classList.remove("show"),runWithoutTransition(a,()=>{updatePlayerQualityMenuPosition()}),requestAnimationFrame(()=>{state.qualityMenuOpen&&a.classList.add("show")}),schedulePlayerQualityMenuPositionUpdate()}function closePlayerQualityMenu(){if(!dom.playerQualityMenu)return;const e=dom.playerQualityMenu;if(!(state.qualityMenuOpen||e.classList.contains("show")))return resetPlayerQualityMenuPosition(),setQualityAnchorState(qualityMenuAnchor,!1),qualityMenuAnchor=null,void releaseFloatingMenuListenersIfIdle();const t=()=>{t._timeout&&(window.clearTimeout(t._timeout),t._timeout=null),e.removeEventListener("transitionend",a),state.qualityMenuOpen||e.classList.contains("show")||(resetPlayerQualityMenuPosition(),releaseFloatingMenuListenersIfIdle())},a=a=>{a.target===e&&(a.propertyName&&!["opacity","transform"].includes(a.propertyName)||t())};e.addEventListener("transitionend",a),t._timeout=window.setTimeout(t,250),e.classList.remove("show"),state.qualityMenuOpen=!1,cancelPlayerQualityMenuPositionUpdate(),setQualityAnchorState(qualityMenuAnchor,!1),qualityMenuAnchor=null}function handlePlayerQualitySelection(e){const t=e.target.closest(".player-quality-option");if(!t)return;e.preventDefault(),e.stopPropagation();const{quality:a}=t.dataset;a&&selectPlaybackQuality(a)}async function selectPlaybackQuality(e){const t=normalizeQuality(e);if(t===state.playbackQuality)return void closePlayerQualityMenu();state.playbackQuality=t,updateQualityLabel(),buildQualityMenu(),savePlayerState(),closePlayerQualityMenu();const a=QUALITY_OPTIONS.find(e=>e.value===t);if(a&&showNotification(`音质已切换为 ${a.label} (${a.description})`),state.currentSong){await reloadCurrentSong()||showNotification("切换音质失败，请稍后重试","error")}}async function reloadCurrentSong(){if(!state.currentSong)return!0;const e=!dom.audioPlayer.paused,t=dom.audioPlayer.currentTime||state.currentPlaybackTime||0;try{return await playSong(state.currentSong,{autoplay:e,startTime:t,preserveProgress:!0}),e||(dom.audioPlayer.pause(),updatePlayPauseButton()),!0}catch(e){return console.error("切换音质失败:",e),!1}}async function restoreCurrentSongState(){if(state.currentSong)try{await playSong(state.currentSong,{autoplay:!1,startTime:state.currentPlaybackTime,preserveProgress:!0}),dom.audioPlayer.pause(),updatePlayPauseButton()}catch(e){console.warn("恢复音频失败:",e)}}async function setupInteractions(){function e(e){state.themeDefaultsCaptured||captureThemeDefaults(),document.body.classList.toggle("dark-mode",e),dom.themeToggleButton.classList.toggle("is-dark",e);const t=e?"切换为浅色模式":"切换为深色模式";dom.themeToggleButton.setAttribute("aria-label",t),dom.themeToggleButton.setAttribute("title",t),applyDynamicGradient()}captureThemeDefaults();const t=safeGetLocalStorage("theme"),a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;e(t?"dark"===t:a),dom.themeToggleButton.addEventListener("click",()=>{const t=!document.body.classList.contains("dark-mode");e(t),safeSetLocalStorage("theme",t?"dark":"light")}),dom.audioPlayer.volume=state.volume,dom.volumeSlider.value=state.volume,updateVolumeSliderBackground(state.volume),updateVolumeIcon(state.volume),buildSourceMenu(),updateSourceLabel(),buildQualityMenu(),buildPlaylistMenu(),updatePlaylistSelectorLabel(),function(){if(!dom.playerQualityMenu||!document.body||!isMobileView)return;const e=dom.playerQualityMenu.parentElement;e&&e!==document.body&&(e.removeChild(dom.playerQualityMenu),document.body.appendChild(dom.playerQualityMenu))}(),function(){if(!dom.playlistItems)return;const e=e=>{"number"!=typeof e||Number.isNaN(e)||playPlaylistSong(e)};dom.playlistItems.addEventListener("click",t=>{const a=t.target.closest("[data-playlist-action]");if(a)return void((e,t)=>{const a=Number(t.dataset.index);if(Number.isNaN(a))return;const n=t.dataset.playlistAction;"remove"===n?(e.preventDefault(),e.stopPropagation(),removeFromPlaylist(a)):"download"===n&&(e.preventDefault(),e.stopPropagation(),showQualityMenu(e,a,"playlist"))})(t,a);const n=t.target.closest(".playlist-item");if(!n||!dom.playlistItems.contains(n))return;const l=Number(n.dataset.index);Number.isNaN(l)||e(l)}),dom.playlistItems.addEventListener("keydown",t=>{if("Enter"!==t.key&&" "!==t.key)return;if(t.target.closest("[data-playlist-action]"))return;const a=t.target.closest(".playlist-item");if(!a||!dom.playlistItems.contains(a))return;const n=Number(a.dataset.index);Number.isNaN(n)||(t.preventDefault(),e(n))})}(),updateQualityLabel(),updatePlayPauseButton(),dom.currentTimeDisplay.textContent=formatTime(state.currentPlaybackTime),updateProgressBarBackground(0,Number(dom.progressBar.max)),dom.playPauseBtn.addEventListener("click",togglePlayPause),dom.audioPlayer.addEventListener("timeupdate",handleTimeUpdate),dom.audioPlayer.addEventListener("loadedmetadata",handleLoadedMetadata),dom.audioPlayer.addEventListener("play",updatePlayPauseButton),dom.audioPlayer.addEventListener("pause",updatePlayPauseButton),dom.audioPlayer.addEventListener("volumechange",onAudioVolumeChange),dom.progressBar.addEventListener("input",handleProgressInput),dom.progressBar.addEventListener("change",handleProgressChange),dom.progressBar.addEventListener("pointerup",handleProgressChange),dom.volumeSlider.addEventListener("input",handleVolumeChange),dom.sourceSelectButton&&dom.sourceMenu&&(dom.sourceSelectButton.addEventListener("click",toggleSourceMenu),dom.sourceMenu.addEventListener("click",handleSourceSelection)),dom.playlistSelectorButton&&dom.playlistMenu&&(dom.playlistSelectorButton.addEventListener("click",togglePlaylistMenu),dom.playlistMenu.addEventListener("click",handlePlaylistMenuSelection)),dom.createPlaylistBtn&&dom.createPlaylistBtn.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),handleCreatePlaylist()}),dom.importPlaylistBtn&&dom.importPlaylistBtn.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),handleImportNeteasePlaylist()}),dom.deletePlaylistBtn&&dom.deletePlaylistBtn.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),deleteActivePlaylist()}),dom.qualityToggle.addEventListener("click",togglePlayerQualityMenu),dom.mobileQualityToggle&&dom.mobileQualityToggle.addEventListener("click",togglePlayerQualityMenu),setQualityAnchorState(dom.qualityToggle,!1),dom.mobileQualityToggle&&setQualityAnchorState(dom.mobileQualityToggle,!1),dom.playerQualityMenu.addEventListener("click",handlePlayerQualitySelection),dom.playlistSyncBtn&&dom.playlistSyncBtn.addEventListener("click",copyPlaylistSyncLink),isMobileView&&dom.albumCover&&dom.albumCover.addEventListener("click",()=>{toggleMobileInlineLyrics()}),isMobileView&&dom.mobileInlineLyrics&&dom.mobileInlineLyrics.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),state.isMobileInlineLyricsOpen&&closeMobileInlineLyrics()}),dom.showPlaylistBtn&&dom.showPlaylistBtn.addEventListener("click",()=>{isMobileView?openMobilePanel("playlist"):switchMobileView("playlist")}),dom.showLyricsBtn&&dom.showLyricsBtn.addEventListener("click",()=>{isMobileView?openMobilePanel("lyrics"):switchMobileView("lyrics")}),updatePlayModeUI(),dom.playModeBtn.addEventListener("click",togglePlayMode),dom.searchBtn.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),debugLog("搜索按钮被点击"),performSearch()}),dom.searchInput.addEventListener("keypress",e=>{"Enter"===e.key&&(e.preventDefault(),e.stopPropagation(),debugLog("搜索输入框回车键被按下"),performSearch())}),document.addEventListener("click",e=>{const t=document.querySelector(".search-area");t&&!t.contains(e.target)&&state.isSearchMode&&(debugLog("点击搜索区域外部，隐藏搜索结果"),hideSearchResults())}),document.addEventListener("keydown",e=>{"Escape"===e.key&&(state.sourceMenuOpen&&closeSourceMenu(),state.qualityMenuOpen&&closePlayerQualityMenu(),state.playlistMenuOpen&&closePlaylistMenu(),playlistPickerElement&&closePlaylistPicker(),isMobileView&&closeAllMobileOverlays())}),document.addEventListener("click",e=>{if(document.querySelectorAll(".quality-menu").forEach(t=>{if(!t.contains(e.target)&&!e.target.closest(".playlist-item-download")){t.classList.remove("show");const e=t.closest(".search-result-item");e&&e.classList.remove("menu-active")}}),state.qualityMenuOpen&&dom.playerQualityMenu&&!dom.playerQualityMenu.contains(e.target)){const t=isElementNode(qualityMenuAnchor)?qualityMenuAnchor:resolveQualityAnchor();if(t&&t.contains(e.target))return;closePlayerQualityMenu()}state.sourceMenuOpen&&dom.sourceMenu&&dom.sourceSelectButton&&!dom.sourceMenu.contains(e.target)&&!dom.sourceSelectButton.contains(e.target)&&closeSourceMenu(),state.playlistMenuOpen&&dom.playlistMenu&&dom.playlistSelectorButton&&!dom.playlistMenu.contains(e.target)&&!dom.playlistSelectorButton.contains(e.target)&&closePlaylistMenu(),playlistPickerElement&&!playlistPickerElement.contains(e.target)&&closePlaylistPicker()}),dom.searchResults.addEventListener("click",e=>{debugLog(`点击事件触发: ${e.target.tagName} ${e.target.className} ${e.target.id}`);(e.target.closest(".load-more-btn")||e.target.closest("#loadMoreBtn")||("loadMoreBtn"===e.target.id?e.target:null)||(e.target.classList.contains("load-more-btn")?e.target:null))&&(debugLog("检测到加载更多按钮点击"),e.preventDefault(),e.stopPropagation(),loadMoreResults())}),document.addEventListener("click",e=>{("loadMoreBtn"===e.target.id||e.target.closest("#loadMoreBtn"))&&(debugLog("备用事件监听器触发"),e.preventDefault(),e.stopPropagation(),loadMoreResults())});const n=(e,t)=>{e&&e.addEventListener("scroll",()=>{state.userScrolledLyrics=!0,clearTimeout(state.lyricsScrollTimeout),state.lyricsScrollTimeout=setTimeout(()=>{state.userScrolledLyrics=!1;const a="function"==typeof t?t():dom.lyricsContent?.querySelector(".current");a&&scrollToCurrentLyric(a,e)},3e3)},{passive:!0})};if(n(dom.lyricsScroll,()=>dom.lyricsContent?.querySelector(".current")),n(dom.mobileInlineLyricsScroll,()=>dom.mobileInlineLyricsContent?.querySelector(".current")),dom.lyricsContent&&dom.lyricsContent.addEventListener("click",handleLyricLineClick),dom.mobileInlineLyricsContent&&dom.mobileInlineLyricsContent.addEventListener("click",handleLyricLineClick),document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState&&flushPlaylistSyncQueue()}),window.addEventListener("pagehide",()=>{flushPlaylistSyncQueue()}),await initializePlaylistSync(),updatePlaylistSyncUI(),updatePlayModeUI(),updateQualityLabel(),renderPlaylist(),state.playlistSongs.length>0){let e=state.currentTrackIndex;(e<0||e>=state.playlistSongs.length)&&(e=0),state.currentTrackIndex=e,state.currentPlaylist="playlist";const t=state.playlistSongs[e];t&&(state.currentSong=t,updatePlaylistHighlight(),updateCurrentSongInfo(t).catch(e=>{console.error("恢复歌曲信息失败:",e)}))}else updateMobileClearPlaylistVisibility();state.currentSong&&restoreCurrentSongState(),isMobileView&&(initializeMobileUI(),updateMobileClearPlaylistVisibility())}function updateCurrentSongInfo(e,t={}){const{loadArtwork:a=!0}=t;state.currentSong=e,dom.currentSongTitle.textContent=e.name,updateMobileToolbarTitle();const n=Array.isArray(e.artist)?e.artist.join(", "):e.artist||"未知艺术家";dom.currentSongArtist.textContent=n;const l="string"==typeof e.name?e.name.trim():"",i="string"==typeof n?n.trim():"",o=[];if(l&&o.push(l),i&&o.push(i),setTabTitleBase(o.join(" - ")),setTabTitleLyric(""),cancelDeferredPaletteUpdate(),!a)return dom.albumCover.classList.add("loading"),dom.albumCover.innerHTML=PLACEHOLDER_HTML,Promise.resolve();if(e.pic_id){cancelDeferredPaletteUpdate(),dom.albumCover.classList.add("loading");const t=API.getPicUrl(e);API.fetchJson(t).then(t=>{if(!t||!t.url)throw new Error("封面地址缺失");const a=new Image,n=preferHttpsUrl(t.url);a.crossOrigin="anonymous",a.onload=()=>{if(state.currentSong!==e)return;setAlbumCoverImage(n);const t=paletteCache.has(n)||state.currentPaletteImage===n&&state.dynamicPalette;scheduleDeferredPaletteUpdate(n,{immediate:t})},a.onerror=()=>{state.currentSong===e&&(cancelDeferredPaletteUpdate(),showAlbumCoverPlaceholder())},a.src=n}).catch(t=>{console.error("加载封面失败:",t),state.currentSong===e&&(cancelDeferredPaletteUpdate(),showAlbumCoverPlaceholder())})}else cancelDeferredPaletteUpdate(),showAlbumCoverPlaceholder();return Promise.resolve()}async function performSearch(e=!1){const t=dom.searchInput.value.trim();if(!t)return void showNotification("请输入搜索关键词","error");state.sourceMenuOpen&&closeSourceMenu();const a=normalizeSource(state.searchSource);state.searchSource=a,safeSetLocalStorage("searchSource",a),updateSourceLabel(),buildSourceMenu(),e?(state.searchKeyword=t,state.searchSource=a):(state.searchPage=1,state.searchKeyword=t,state.searchSource=a,state.searchResults=[],state.hasMoreResults=!0,state.renderedSearchCount=0,debugLog(`开始新搜索: ${t}, 来源: ${a}`));try{dom.searchBtn.disabled=!0,dom.searchBtn.innerHTML='<span class="loader"></span><span>搜索中...</span>',showSearchResults(),debugLog("已切换到搜索模式");const e=await API.search(t,a,20,state.searchPage);debugLog(`API返回结果数量: ${e.length}`),1===state.searchPage?state.searchResults=e:state.searchResults=[...state.searchResults,...e],state.hasMoreResults=20===e.length,displaySearchResults(e,{reset:1===state.searchPage,totalCount:state.searchResults.length}),debugLog(`搜索完成: 总共显示 ${state.searchResults.length} 个结果`),0===state.searchResults.length&&showNotification("未找到相关歌曲","error")}catch(e){console.error("搜索失败:",e),showNotification("搜索失败，请稍后重试","error"),hideSearchResults(),debugLog(`搜索失败: ${e.message}`)}finally{dom.searchBtn.disabled=!1,dom.searchBtn.innerHTML='<i class="fas fa-search"></i><span>搜索</span>'}}async function loadMoreResults(){if(!state.hasMoreResults||!state.searchKeyword)return void debugLog("没有更多结果或搜索关键词为空");const e=document.getElementById("loadMoreBtn");if(e)try{e.disabled=!0,e.innerHTML='<span class="loader"></span><span>加载中...</span>',state.searchPage++,debugLog(`加载第 ${state.searchPage} 页结果`);const t=normalizeSource(state.searchSource);state.searchSource=t,safeSetLocalStorage("searchSource",t);const a=await API.search(state.searchKeyword,t,20,state.searchPage);a.length>0?(state.searchResults=[...state.searchResults,...a],state.hasMoreResults=20===a.length,displaySearchResults(a,{totalCount:state.searchResults.length}),debugLog(`加载完成: 新增 ${a.length} 个结果`)):(state.hasMoreResults=!1,showNotification("没有更多结果了"),debugLog("没有更多结果"))}catch(e){console.error("加载更多失败:",e),showNotification("加载失败，请稍后重试","error"),state.searchPage--}finally{e&&(e.disabled=!1,e.innerHTML='<i class="fas fa-plus"></i><span>加载更多</span>')}else debugLog("找不到加载更多按钮")}function createSearchResultItem(e,t){const a=document.createElement("div");a.className="search-result-item",a.dataset.index=String(t),a.tabIndex=0,a.setAttribute("role","button"),a.setAttribute("aria-label",`${e.name||"未知歌曲"} - 播放`);const n=document.createElement("div");n.className="search-result-info";const l=document.createElement("div");l.className="search-result-title",l.textContent=e.name||"未知歌曲";const i=document.createElement("div");i.className="search-result-artist";const o=Array.isArray(e.artist)?e.artist.join(", "):e.artist||"未知艺术家",s=e.album?` - ${e.album}`:"";i.textContent=`${o}${s}`,n.appendChild(l),n.appendChild(i);const r=document.createElement("div");r.className="search-result-actions";const c=document.createElement("button");return c.className="action-btn add",c.type="button",c.title="添加到播放列表",c.setAttribute("aria-label","添加到播放列表"),c.innerHTML='<i class="fas fa-plus"></i>',c.addEventListener("click",e=>{if(e.preventDefault(),e.stopPropagation(),state.playlists.length<=1)return addSearchResultToPlaylist(t,state.activePlaylistId),void closePlaylistPicker();openPlaylistPickerForSearchResult(c,t)}),r.appendChild(c),a.appendChild(n),a.appendChild(r),a.addEventListener("click",()=>playSearchResult(t)),a.addEventListener("keydown",e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),playSearchResult(t))}),a}function createLoadMoreButton(){const e=document.createElement("button");return e.id="loadMoreBtn",e.className="load-more-btn",e.type="button",e.innerHTML='<i class="fas fa-plus"></i><span>加载更多</span>',e.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),loadMoreResults()}),e}function displaySearchResults(e,t={}){dom.playlist.classList.remove("empty");const a=dom.searchResults;if(!a)return;const{reset:n=!1,totalCount:l=state.searchResults.length}=t;n&&(closePlaylistPicker(),a.innerHTML="",state.renderedSearchCount=0);const i=a.querySelector("#loadMoreBtn");i&&i.remove();const o=Array.isArray(e)?e:[];if(0===o.length&&0===state.renderedSearchCount&&0===l)return a.innerHTML='<div style="text-align: center; color: var(--text-secondary-color); padding: 20px;">未找到相关歌曲</div>',state.renderedSearchCount=0,void debugLog("显示搜索结果: 0 个结果, 无可用数据");if(o.length>0){const e=document.createDocumentFragment(),t=state.renderedSearchCount;o.forEach((a,n)=>{e.appendChild(createSearchResultItem(a,t+n))}),a.appendChild(e),state.renderedSearchCount+=o.length}state.hasMoreResults&&a.appendChild(createLoadMoreButton());debugLog(`显示搜索结果: 新增 ${o.length} 个结果, 总计 ${state.renderedSearchCount} 个, 加载更多按钮: ${state.hasMoreResults?"显示":"隐藏"}`)}function showQualityMenu(e,t,a){e.stopPropagation();const n=document.querySelector(".dynamic-quality-menu");n&&n.remove();const l=document.createElement("div");l.className="dynamic-quality-menu",l.innerHTML=`\n        <div class="quality-option" onclick="downloadWithQuality(event, ${t}, '${a}', '128')">标准音质 (128k)</div>\n        <div class="quality-option" onclick="downloadWithQuality(event, ${t}, '${a}', '192')">高音质 (192k)</div>\n        <div class="quality-option" onclick="downloadWithQuality(event, ${t}, '${a}', '320')">超高音质 (320k)</div>\n        <div class="quality-option" onclick="downloadWithQuality(event, ${t}, '${a}', '999')">无损音质</div>\n    `;const i=e.target.closest("button").getBoundingClientRect();l.style.position="fixed",l.style.top=i.bottom+5+"px",l.style.left=i.left-50+"px",l.style.zIndex="10000",document.body.appendChild(l),setTimeout(()=>{document.addEventListener("click",function e(t){l.contains(t.target)||(l.remove(),document.removeEventListener("click",e))})},0)}async function downloadWithQuality(e,t,a,n){let l;if(e.stopPropagation(),"search"===a?l=state.searchResults[t]:"online"===a?l=state.onlineSongs[t]:"playlist"===a&&(l=state.playlistSongs[t]),!l)return;document.querySelectorAll(".quality-menu").forEach(e=>{e.classList.remove("show");const t=e.closest(".search-result-item");t&&t.classList.remove("menu-active")});const i=document.querySelector(".dynamic-quality-menu");i&&i.remove();try{await downloadSong(l,n)}catch(e){console.error("下载失败:",e),showNotification("下载失败，请稍后重试","error")}}function addSearchResultToPlaylist(e,t=state.activePlaylistId,a={}){const n=state.searchResults[e];if(!n)return;const l=!1!==(a&&"object"==typeof a?a:{}).showMessage,i=addSongToPlaylist(n,t);i.playlist?(t===state.activePlaylistId?i.added?renderPlaylist():updatePlaylistHighlight():i.added&&(buildPlaylistMenu(),updatePlaylistSelectorLabel(),savePlayerState()),i.added?l&&showNotification(`已添加到「${i.playlist.name}」`,"success"):l&&i.duplicate&&showNotification("歌曲已在歌单中","warning")):l&&showNotification("目标歌单不存在","error")}async function playSearchResult(e){const t=state.searchResults[e];if(t)try{const e=state.activePlaylistId,a=addSongToPlaylist(t,e);state.currentPlaylist="playlist",a.added?(state.currentTrackIndex=a.index,e===state.activePlaylistId?renderPlaylist():(buildPlaylistMenu(),updatePlaylistSelectorLabel(),savePlayerState())):a.duplicate&&(state.currentTrackIndex=a.index,updatePlaylistHighlight()),await playSong(t),showNotification(`正在播放: ${t.name}`)}catch(e){console.error("播放失败:",e),showNotification("播放失败，请稍后重试","error")}}function renderPlaylist(){const e=getActivePlaylist(),t=e&&Array.isArray(e.songs)?e.songs:[];if(state.playlistSongs=t,updatePlaylistSelectorLabel(),buildPlaylistMenu(),!dom.playlistItems)return savePlayerState(),void updateMobileClearPlaylistVisibility();if(!t.length)return dom.playlist&&dom.playlist.classList.add("empty"),dom.playlistItems.innerHTML="",savePlayerState(),updatePlaylistHighlight(),void updateMobileClearPlaylistVisibility();dom.playlist&&dom.playlist.classList.remove("empty");const a=t.map((e,t)=>`<div class="playlist-item" data-index="${t}" role="button" tabindex="0" aria-label="播放 ${e.name}">\n            ${e.name} - ${Array.isArray(e.artist)?e.artist.join(", "):e.artist}\n            <button class="playlist-item-remove" type="button" data-playlist-action="remove" data-index="${t}" title="从播放列表移除">\n                <i class="fas fa-times"></i>\n            </button>\n            <button class="playlist-item-download" type="button" data-playlist-action="download" data-index="${t}" title="下载">\n                <i class="fas fa-download"></i>\n            </button>\n        </div>`).join("");dom.playlistItems.innerHTML=a,savePlayerState(),updatePlaylistHighlight(),updateMobileClearPlaylistVisibility()}function removeFromPlaylist(e){if(e<0||e>=state.playlistSongs.length)return;const t="playlist"===state.currentPlaylist&&state.currentTrackIndex===e;if(t?1===state.playlistSongs.length?(dom.audioPlayer.pause(),dom.audioPlayer.src="",state.currentTrackIndex=-1,state.currentSong=null,setTabTitleBase(""),state.currentAudioUrl=null,state.currentPlaybackTime=0,state.lastSavedPlaybackTime=0,dom.progressBar.value=0,dom.progressBar.max=0,dom.currentTimeDisplay.textContent="00:00",dom.durationDisplay.textContent="00:00",updateProgressBarBackground(0,1),dom.currentSongTitle.textContent="选择一首歌曲开始播放",updateMobileToolbarTitle(),dom.currentSongArtist.textContent="未知艺术家",showAlbumCoverPlaceholder(),clearLyricsContent(),dom.lyrics&&(dom.lyrics.dataset.placeholder="default"),dom.lyrics.classList.add("empty"),updatePlayPauseButton()):e===state.playlistSongs.length-1&&(state.currentTrackIndex=e-1):"playlist"===state.currentPlaylist&&state.currentTrackIndex>e&&state.currentTrackIndex--,state.playlistSongs.splice(e,1),0===state.playlistSongs.length)dom.playlist.classList.add("empty"),dom.playlistItems&&(dom.playlistItems.innerHTML=""),state.currentPlaylist="playlist",updateMobileClearPlaylistVisibility();else if("playlist"===state.currentPlaylist&&state.currentTrackIndex<0&&(state.currentTrackIndex=0),renderPlaylist(),t&&"playlist"===state.currentPlaylist&&state.currentTrackIndex>=0){const e=Math.min(state.currentTrackIndex,state.playlistSongs.length-1);state.currentTrackIndex=e,playPlaylistSong(e)}else updatePlaylistHighlight();buildPlaylistMenu(),updatePlaylistSelectorLabel(),savePlayerState(),showNotification("已从播放列表移除","success")}function clearPlaylist(e){let t=e;t&&"object"==typeof t&&"function"==typeof t.preventDefault&&(t.preventDefault(),"function"==typeof t.stopPropagation&&t.stopPropagation(),t={});const a=Boolean((t&&"object"==typeof t?t:{}).silent);0!==state.playlistSongs.length?("playlist"===state.currentPlaylist&&(dom.audioPlayer.pause(),dom.audioPlayer.src="",state.currentTrackIndex=-1,state.currentSong=null,setTabTitleBase(""),state.currentAudioUrl=null,state.currentPlaybackTime=0,state.lastSavedPlaybackTime=0,dom.progressBar.value=0,dom.progressBar.max=0,dom.currentTimeDisplay.textContent="00:00",dom.durationDisplay.textContent="00:00",updateProgressBarBackground(0,1),dom.currentSongTitle.textContent="选择一首歌曲开始播放",updateMobileToolbarTitle(),dom.currentSongArtist.textContent="未知艺术家",showAlbumCoverPlaceholder(),clearLyricsContent(),dom.lyrics&&(dom.lyrics.dataset.placeholder="default"),dom.lyrics.classList.add("empty"),updatePlayPauseButton()),setActivePlaylistSongs([]),state.currentPlaylist="playlist",state.currentTrackIndex=-1,closePlaylistPicker(),closePlaylistMenu(),renderPlaylist(),a||showNotification("播放列表已清空","success")):a||showNotification("播放列表已为空","warning")}async function playPlaylistSong(e){if(e<0||e>=state.playlistSongs.length)return;const t=state.playlistSongs[e];state.currentTrackIndex=e,state.currentPlaylist="playlist";try{await playSong(t),updatePlaylistHighlight(),isMobileView&&closeMobilePanel()}catch(e){console.error("播放失败:",e),showNotification("播放失败，请稍后重试","error")}}function updatePlaylistHighlight(){if(!dom.playlistItems)return;dom.playlistItems.querySelectorAll(".playlist-item").forEach((e,t)=>{const a="playlist"===state.currentPlaylist&&t===state.currentTrackIndex;e.classList.toggle("current",a),e.setAttribute("aria-current",a?"true":"false"),e.setAttribute("aria-pressed",a?"true":"false")})}function waitForAudioReady(e){return e?e.readyState>=1?Promise.resolve():new Promise((t,a)=>{const n=()=>{e.removeEventListener("loadedmetadata",l),e.removeEventListener("error",i)},l=()=>{n(),t()},i=()=>{n(),a(new Error("音频加载失败"))};e.addEventListener("loadedmetadata",l,{once:!0}),e.addEventListener("error",i,{once:!0})}):Promise.resolve()}function getSongArtistText(e){return e&&"object"==typeof e?Array.isArray(e.artist)?e.artist.join(" "):"string"==typeof e.artist?e.artist:"":""}function normalizeSongMatchString(e){if(!e)return"";return(Array.isArray(e)?e.join(" "):String(e)).toLowerCase().replace(/（.*?）/g,"").replace(/\(.*?\)/g,"").replace(/[\s'"\-_,.!?？。·、【】\[\]（）()<>《》「」『』\/\\]+/g,"").trim()}function scoreKuwoCandidate(e,t){if(!t)return-1/0;const a=normalizeSongMatchString(e?.name),n=normalizeSongMatchString(getSongArtistText(e)),l=normalizeSongMatchString(t.name),i=normalizeSongMatchString(getSongArtistText(t)),o=normalizeSongMatchString(e?.album),s=normalizeSongMatchString(t.album);let r=0;return l&&a&&(l===a?r+=6:(l.includes(a)||a.includes(l))&&(r+=3)),i&&n&&(i===n?r+=4:(i.includes(n)||n.includes(i))&&(r+=2)),s&&o&&s===o&&(r+=1),l&&a&&l.startsWith(a)&&(r+=1),r}async function findKuwoFallbackSong(e){if(!e||!e.name)return null;const t=[],a=String(e.name).trim(),n=getSongArtistText(e).trim(),l=n?n.split(/[,&\/]/)[0].trim():"";a&&n&&t.push(`${a} ${n}`),a&&l&&l!==a&&t.push(`${a} ${l}`),a&&t.push(a);const i=new Set;for(const a of t){const t=a.trim();if(t&&!i.has(t)){i.add(t);try{debugLog(`尝试酷我音源搜索: ${t}`);const a=await API.search(t,"kuwo",10,1),n=Array.isArray(a)?a.filter(e=>e&&"kuwo"===e.source):[];if(!n.length)continue;let l=null,i=-1/0;for(const t of n){const a=scoreKuwoCandidate(e,t);(null===l||a>i)&&(l=t,i=a)}if(l){return{...l,album:l.album||e.album,pic_id:l.pic_id||e.pic_id,lyric_id:l.lyric_id||l.id||e.lyric_id||e.id,url_id:l.url_id||l.id||e.url_id||e.id}}}catch(e){console.warn("酷我搜索失败:",e)}}}return null}async function playSong(e,t={}){const a=t&&"object"==typeof t?t:{},{autoplay:n=!0,startTime:l=0,preserveProgress:i=!1,allowKuwoFallback:o=!0}=a;window.clearTimeout(pendingPaletteTimer),state.audioReadyForPalette=!1,state.pendingPaletteData=null,state.pendingPaletteImage=null,state.pendingPaletteImmediate=!1,state.pendingPaletteReady=!1;try{updateCurrentSongInfo(e,{loadArtwork:!1});const t=state.playbackQuality||"320",a=API.getSongUrl(e,t);debugLog(`获取音频URL: ${a}`);const o=await API.fetchJson(a);if(!o||!o.url)throw new Error("无法获取音频播放地址");const s=o.url,r=buildAudioProxyUrl(s),c=preferHttpsUrl(s),u=Array.from(new Set([r,c,s].filter(Boolean))),d=u[0]||s;r&&r!==s?debugLog(`音频地址已通过代理转换为 HTTPS: ${r}`):c&&c!==s&&debugLog(`音频地址由 HTTP 升级为 HTTPS: ${c}`),state.currentSong=e,state.currentAudioUrl=null,dom.audioPlayer.pause(),i?l>0&&(state.currentPlaybackTime=l,state.lastSavedPlaybackTime=l):(state.currentPlaybackTime=0,state.lastSavedPlaybackTime=0,safeSetLocalStorage("currentPlaybackTime","0")),state.pendingSeekTime=l>0?l:null;let y=null,m=null,p=!1;for(const e of u){dom.audioPlayer.src=e,dom.audioPlayer.load();try{await waitForAudioReady(dom.audioPlayer),y=e,p=e!==d&&u.length>1;break}catch(t){m=t,console.warn("音频元数据加载异常",t),e===d&&u.length>1&&debugLog("主音频地址加载失败，尝试使用备用地址")}}if(!y)throw m||new Error("音频加载失败");p&&(debugLog(`已回退至备用音频地址: ${y}`),showNotification("主音频加载失败，已切换到备用音源","warning")),state.currentAudioUrl=y,null!=state.pendingSeekTime?(setAudioCurrentTime(state.pendingSeekTime),state.pendingSeekTime=null):setAudioCurrentTime(dom.audioPlayer.currentTime||0),state.lastSavedPlaybackTime=state.currentPlaybackTime;let g=null;n?(g=dom.audioPlayer.play(),void 0!==g?g.catch(e=>{console.error("播放失败:",e),showNotification("播放失败，请检查网络连接","error")}):g=null):(dom.audioPlayer.pause(),updatePlayPauseButton()),scheduleDeferredSongAssets(e,g),debugLog(`开始播放: ${e.name} @${t}`)}catch(t){console.error("播放歌曲失败:",t);if(o&&e&&"kuwo"!==e.source)try{const t=await findKuwoFallbackSong(e);if(t)return showNotification("主音源播放失败，正在尝试酷我音源...","warning"),debugLog(`切换到酷我音源播放尝试: ${t.name} (${t.id})`),await playSong(t,{...a,allowKuwoFallback:!1}),void showNotification("已切换到酷我音源播放","success");debugLog("未找到可用的酷我音源备选")}catch(e){console.warn("酷我音源播放失败:",e)}throw t}finally{savePlayerState()}}function scheduleDeferredSongAssets(e,t){const a=()=>{state.currentSong===e&&(updateCurrentSongInfo(e,{loadArtwork:!0}),loadLyrics(e),state.audioReadyForPalette=!0,attemptPaletteApplication())},n=()=>{state.currentSong===e&&("function"==typeof window.requestAnimationFrame?window.requestAnimationFrame(()=>{state.currentSong===e&&("function"==typeof window.requestIdleCallback?window.requestIdleCallback(()=>{state.currentSong===e&&a()},{timeout:600}):a())}):window.setTimeout(a,0))};t&&"function"==typeof t.finally?t.finally(n):n()}function autoPlayNext(){if("single"===state.playMode)return dom.audioPlayer.currentTime=0,void dom.audioPlayer.play();playNext(),updatePlayPauseButton()}function playNext(){let e=-1,t=[];"playlist"===state.currentPlaylist?t=state.playlistSongs:"online"===state.currentPlaylist?t=state.onlineSongs:"search"===state.currentPlaylist&&(t=state.searchResults),0!==t.length&&(e="random"===state.playMode?Math.floor(Math.random()*t.length):(state.currentTrackIndex+1)%t.length,state.currentTrackIndex=e,"playlist"===state.currentPlaylist?playPlaylistSong(e):"online"===state.currentPlaylist?playOnlineSong(e):"search"===state.currentPlaylist&&playSearchResult(e))}function playPrevious(){let e=-1,t=[];"playlist"===state.currentPlaylist?t=state.playlistSongs:"online"===state.currentPlaylist?t=state.onlineSongs:"search"===state.currentPlaylist&&(t=state.searchResults),0!==t.length&&("random"===state.playMode?e=Math.floor(Math.random()*t.length):(e=state.currentTrackIndex-1,e<0&&(e=t.length-1)),state.currentTrackIndex=e,"playlist"===state.currentPlaylist?playPlaylistSong(e):"online"===state.currentPlaylist?playOnlineSong(e):"search"===state.currentPlaylist&&playSearchResult(e))}async function playOnlineSong(e){const t=state.onlineSongs[e];if(t){state.currentTrackIndex=e,state.currentPlaylist="online";try{await playSong(t),updateOnlineHighlight()}catch(e){console.error("播放失败:",e),showNotification("播放失败，请稍后重试","error")}}}function updateOnlineHighlight(){if(!dom.playlistItems)return;dom.playlistItems.querySelectorAll(".playlist-item").forEach((e,t)=>{"online"===state.currentPlaylist&&t===state.currentTrackIndex?e.classList.add("current"):e.classList.remove("current")})}async function loadLyrics(e){const t=[0,500,1e3];for(let a=0;a<3;a++){if(state.currentSong!==e)return;try{if(a>0&&await new Promise(e=>setTimeout(e,t[a])),state.currentSong!==e)return;const n=API.getLyric(e);debugLog(`获取歌词URL (尝试 ${a+1}/3): ${n}`);const l=await API.fetchJson(n);if(l&&l.lyric){const e=l.tlyric||null;return parseLyrics(l.lyric,e),dom.lyrics.classList.remove("empty"),void(dom.lyrics.dataset.placeholder="default")}a<2&&debugLog(`第 ${a+1} 次尝试未获取到歌词，准备重试...`)}catch(e){if(console.error(`加载歌词失败 (尝试 ${a+1}/3):`,e),2===a)return setLyricsContentHtml("<div>歌词加载失败</div>"),dom.lyrics.classList.add("empty"),dom.lyrics.dataset.placeholder="message",state.lyricsData=[],state.currentLyricLine=-1,void setTabTitleLyric("")}}setLyricsContentHtml("<div>暂无歌词</div>"),dom.lyrics.classList.add("empty"),dom.lyrics.dataset.placeholder="message",state.lyricsData=[],state.currentLyricLine=-1,setTabTitleLyric("")}function parseLyrics(e,t=null){const a=e=>{if(!e)return[];const t=e.split("\n"),a=[];return t.forEach(e=>{const t=e.match(/\[(\d{2}):(\d{2})\.(\d{2,3})\](.*)/);if(t){const e=60*parseInt(t[1])+parseInt(t[2])+parseInt(t[3].padEnd(3,"0"))/1e3,n=t[4].trim();n&&a.push({time:e,text:n})}}),a},n=a(e),l=t?a(t):[],i=[],o=new Map;l.forEach(e=>{o.set(e.time,e.text)}),n.forEach(e=>{const t=o.get(e.time)||"";i.push({time:e.time,text:e.text,translation:t})}),state.currentLyricLine=-1,state.lyricsData=i.sort((e,t)=>e.time-t.time),setTabTitleLyric(""),displayLyrics()}function setLyricsContentHtml(e){dom.lyricsContent&&(dom.lyricsContent.innerHTML=e),dom.mobileInlineLyricsContent&&(dom.mobileInlineLyricsContent.innerHTML=e)}function clearLyricsContent(){setLyricsContentHtml(""),state.lyricsData=[],state.currentLyricLine=-1,setTabTitleLyric(""),isMobileView&&closeMobileInlineLyrics({force:!0})}function containsChinese(e){return!(!e||"string"!=typeof e)&&/[\u4e00-\u9fff\u3400-\u4dbf]/.test(e)}function getPreferredLyricForTitle(e){if(!e)return"";const t=e.text&&"string"==typeof e.text,a=e.translation&&"string"==typeof e.translation;if(!t&&!a)return"";if(!a)return e.text;if(!t)return e.translation;const n=containsChinese(e.text),l=containsChinese(e.translation);return n&&!l?e.text:!n&&l?e.translation:e.text}function displayLyrics(){setLyricsContentHtml(state.lyricsData.map((e,t)=>state.bilingualLyrics&&e.translation?`<div data-time="${e.time}" data-index="${t}" class="lyric-line">\n                <div class="lyric-original">${e.text}</div>\n                <div class="lyric-translation">${e.translation}</div>\n            </div>`:`<div data-time="${e.time}" data-index="${t}" class="lyric-line">${e.text}</div>`).join("")),dom.lyrics&&(dom.lyrics.dataset.placeholder="default"),state.isMobileInlineLyricsOpen&&syncLyrics()}function syncLyrics(){if(0===state.lyricsData.length)return;const e=dom.audioPlayer.currentTime;let t=-1;for(let a=0;a<state.lyricsData.length&&e>=state.lyricsData[a].time;a++)t=a;if(t!==state.currentLyricLine){state.currentLyricLine=t;const e=t>=0&&t<state.lyricsData.length?state.lyricsData[t]:null;setTabTitleLyric(e?getPreferredLyricForTitle(e):"");const a=[];dom.lyricsContent&&a.push({elements:dom.lyricsContent.querySelectorAll("div[data-index]"),container:dom.lyricsScroll||dom.lyrics}),dom.mobileInlineLyricsContent&&a.push({elements:dom.mobileInlineLyricsContent.querySelectorAll("div[data-index]"),container:dom.mobileInlineLyricsScroll||dom.mobileInlineLyrics,inline:!0}),a.forEach(({elements:e,container:a,inline:n})=>{e.forEach((e,l)=>{if(l===t){e.classList.add("current");!state.userScrolledLyrics&&(!n||state.isMobileInlineLyricsOpen)&&scrollToCurrentLyric(e,a)}else e.classList.remove("current")})})}}function handleLyricLineClick(e){if(!e||!e.target||"function"!=typeof e.target.closest)return;const t=e.target.closest("div[data-time]");if(!t)return;e.preventDefault(),e.stopPropagation();const a=Number.parseFloat(t.dataset.time);Number.isFinite(a)&&(clearTimeout(state.lyricsScrollTimeout),state.lyricsScrollTimeout=null,state.userScrolledLyrics=!1,seekAudio(a),syncLyrics())}function scrollToCurrentLyric(e,t){const a=t||dom.lyricsScroll||dom.lyrics;if(!a||!e)return;const n=a.clientHeight,l=e.getBoundingClientRect(),i=a.getBoundingClientRect(),o=l.top-i.top+a.scrollTop,s=o-n/2+l.height/2,r=a.scrollHeight-n,c=Math.max(0,Math.min(s,r));Math.abs(a.scrollTop-c)>1&&("function"==typeof a.scrollTo?a.scrollTo({top:c,behavior:"smooth"}):a.scrollTop=c),debugLog(`歌词滚动: 元素在容器内偏移=${o}, 容器高度=${n}, 目标滚动=${c}`)}async function downloadSong(e,t="320"){try{showNotification("正在准备下载...");const a=API.getSongUrl(e,t),n=await API.fetchJson(a);if(!n||!n.url)throw new Error("无法获取下载地址");{const a=buildAudioProxyUrl(n.url),l=preferHttpsUrl(n.url);a!==n.url?debugLog(`下载链接已通过代理转换为 HTTPS: ${a}`):l!==n.url&&debugLog(`下载链接由 HTTP 升级为 HTTPS: ${l}`);const i=a||l||n.url,o=document.createElement("a");o.href=i;const s="999"===t?"flac":"740"===t?"ape":"mp3",r=(()=>{try{const e=new URL(n.url),t=(e.pathname||"").match(/\.([a-z0-9]+)$/i);if(t)return t[1]}catch(e){console.warn("无法从下载链接中解析扩展名:",e)}return s})();o.download=`${e.name} - ${Array.isArray(e.artist)?e.artist.join(", "):e.artist}.${r}`,o.target="_blank",document.body.appendChild(o),o.click(),document.body.removeChild(o),showNotification("下载已开始","success")}}catch(e){console.error("下载失败:",e),showNotification("下载失败，请稍后重试","error")}}function switchMobileView(e){"playlist"===e?(dom.showPlaylistBtn&&dom.showPlaylistBtn.classList.add("active"),dom.showLyricsBtn&&dom.showLyricsBtn.classList.remove("active"),dom.playlist.classList.add("active"),dom.lyrics.classList.remove("active")):"lyrics"===e&&(dom.showLyricsBtn&&dom.showLyricsBtn.classList.add("active"),dom.showPlaylistBtn&&dom.showPlaylistBtn.classList.remove("active"),dom.lyrics.classList.add("active"),dom.playlist.classList.remove("active")),isMobileView&&document.body&&(document.body.setAttribute("data-mobile-panel-view",e),dom.mobilePanelTitle&&(dom.mobilePanelTitle.textContent="lyrics"===e?"歌词":"播放列表"),updateMobileClearPlaylistVisibility())}function showNotification(e,t="success"){const a=dom.notification;a.textContent=e,a.className=`notification ${t}`,a.classList.add("show"),setTimeout(()=>{a.classList.remove("show")},3e3)}window.addEventListener("load",()=>{setupInteractions().catch(e=>{console.error("初始化界面失败:",e),showNotification("初始化失败，请刷新页面重试","error")})}),dom.audioPlayer.addEventListener("ended",autoPlayNext);