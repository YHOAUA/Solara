const e={container:document.getElementById("mainContainer"),backgroundStage:document.getElementById("backgroundStage"),backgroundBaseLayer:document.getElementById("backgroundBaseLayer"),backgroundTransitionLayer:document.getElementById("backgroundTransitionLayer"),playlist:document.getElementById("playlist"),playlistItems:document.getElementById("playlistItems"),playlistSelectorButton:document.getElementById("playlistSelectorButton"),playlistSelectorLabel:document.getElementById("playlistSelectorLabel"),playlistMenu:document.getElementById("playlistMenu"),createPlaylistBtn:document.getElementById("createPlaylistBtn"),importPlaylistBtn:document.getElementById("importPlaylistBtn"),deletePlaylistBtn:document.getElementById("deletePlaylistBtn"),lyrics:document.getElementById("lyrics"),lyricsScroll:document.getElementById("lyricsScroll"),lyricsContent:document.getElementById("lyricsContent"),mobileInlineLyrics:document.getElementById("mobileInlineLyrics"),mobileInlineLyricsScroll:document.getElementById("mobileInlineLyricsScroll"),mobileInlineLyricsContent:document.getElementById("mobileInlineLyricsContent"),audioPlayer:document.getElementById("audioPlayer"),themeToggleButton:document.getElementById("themeToggleButton"),showPlaylistBtn:document.getElementById("showPlaylistBtn"),showLyricsBtn:document.getElementById("showLyricsBtn"),searchInput:document.getElementById("searchInput"),searchBtn:document.getElementById("searchBtn"),sourceSelectButton:document.getElementById("sourceSelectButton"),sourceSelectLabel:document.getElementById("sourceSelectLabel"),sourceMenu:document.getElementById("sourceMenu"),searchResults:document.getElementById("searchResults"),notification:document.getElementById("notification"),albumCover:document.getElementById("albumCover"),currentSongTitle:document.getElementById("currentSongTitle"),currentSongArtist:document.getElementById("currentSongArtist"),debugInfo:document.getElementById("debugInfo"),playModeBtn:document.getElementById("playModeBtn"),playPauseBtn:document.getElementById("playPauseBtn"),progressBar:document.getElementById("progressBar"),currentTimeDisplay:document.getElementById("currentTimeDisplay"),durationDisplay:document.getElementById("durationDisplay"),volumeSlider:document.getElementById("volumeSlider"),volumeIcon:document.getElementById("volumeIcon"),qualityToggle:document.getElementById("qualityToggle"),playerQualityMenu:document.getElementById("playerQualityMenu"),qualityLabel:document.getElementById("qualityLabel"),mobileToolbarTitle:document.getElementById("mobileToolbarTitle"),mobileSearchToggle:document.getElementById("mobileSearchToggle"),mobileSearchClose:document.getElementById("mobileSearchClose"),mobilePanelClose:document.getElementById("mobilePanelClose"),mobileClearPlaylistBtn:document.getElementById("mobileClearPlaylistBtn"),mobileOverlayScrim:document.getElementById("mobileOverlayScrim"),mobileQualityToggle:document.getElementById("mobileQualityToggle"),mobileQualityLabel:document.getElementById("mobileQualityLabel"),mobilePanel:document.getElementById("mobilePanel"),mobilePanelTitle:document.getElementById("mobilePanelTitle"),mobileQueueToggle:document.getElementById("mobileQueueToggle"),searchArea:document.getElementById("searchArea"),playlistSyncStatus:document.getElementById("playlistSyncStatus"),playlistSyncBtn:document.getElementById("playlistSyncBtn")};window.SolaraDom=e;const t=Boolean(window.__SOLARA_IS_MOBILE),n=window.SolaraMobileBridge||{};function r(e,...r){if(!t)return;const a=n.handlers[e];if("function"==typeof a)return a(...r);n.queue.push({name:e,args:r})}function a(){return r("updateToolbarTitle")}function i(e){if("function"!=typeof e||!t)return;const n=()=>{document.body&&e()};"function"==typeof window.requestAnimationFrame?window.requestAnimationFrame(n):window.setTimeout(n,0)}function l(){if(!t||!document.body)return;const n=document.body.classList.contains("mobile-search-open"),r=document.body.classList.contains("mobile-panel-open");e.searchArea&&e.searchArea.setAttribute("aria-hidden",n?"false":"true"),e.mobileOverlayScrim&&e.mobileOverlayScrim.setAttribute("aria-hidden",n||r?"false":"true")}function o(){if(!t)return;const n=e.mobileClearPlaylistBtn;if(!n)return;const r=e.playlist,a=document.body,i=a?a.getAttribute("data-mobile-panel-view"):null,l=!a||!i||"playlist"===i,o=0===(void 0!==Be&&Array.isArray(Be.playlistSongs)?Be.playlistSongs:[]).length||!r||r.classList.contains("empty"),s=l&&!o;n.hidden=!s,n.setAttribute("aria-hidden",s?"false":"true")}function s(){t&&document.body&&(document.body.classList.remove("mobile-search-open"),e.searchInput&&e.searchInput.blur(),l())}function c(){t&&document.body&&(document.body.classList.remove("mobile-panel-open"),l())}function u(e="playlist"){return r("openPanel",e)}function d(t){e.mobileInlineLyrics&&e.mobileInlineLyrics.setAttribute("aria-hidden",t?"false":"true")}function y(n){t&&document.body&&e.mobileInlineLyrics&&(Be.isMobileInlineLyricsOpen=Boolean(n),document.body.classList.toggle("mobile-inline-lyrics-open",Boolean(n)),d(Boolean(n)))}function m(){if(!t||!document.body)return!1;return Boolean(Be.currentSong)&&function(){const t=e.mobileInlineLyricsContent;return!!t&&t.textContent.trim().length>0}()}function p(e={}){return!(!t||!document.body)&&(document.body.classList.contains("mobile-inline-lyrics-open")?(y(!1),e.force&&(Be.userScrolledLyrics=!1),!0):(d(!1),Be.isMobileInlineLyricsOpen=!1,!1))}function g(){t&&document.body&&(document.body.classList.contains("mobile-inline-lyrics-open")?p():t&&document.body&&m()&&(y(!0),Be.userScrolledLyrics=!1,window.requestAnimationFrame(()=>{const t=e.mobileInlineLyricsScroll||e.mobileInlineLyrics,n=e.mobileInlineLyricsContent?.querySelector(".current")||e.mobileInlineLyricsContent?.querySelector("div[data-index]");t&&n&&wn(n,t)}),vn()))}n.handlers=n.handlers||{},n.queue=Array.isArray(n.queue)?n.queue:[],window.SolaraMobileBridge=n;const f='<div class="placeholder"><i class="fas fa-music"></i></div>',h=new Map,b="paletteCache.v1";let v=null;let S=null;let w=null,P=null,L="",M=null;const k={light:{gradient:"",primaryColor:"",primaryColorDark:""},dark:{gradient:"",primaryColor:"",primaryColorDark:""}};function I(e){try{return localStorage.getItem(e)}catch(t){return console.warn(`读取本地存储失败: ${e}`,t),null}}function T(e,t){try{localStorage.setItem(e,t)}catch(t){console.warn(`写入本地存储失败: ${e}`,t)}}function B(e){try{localStorage.removeItem(e)}catch(t){console.warn(`移除本地存储失败: ${e}`,t)}}function x(e,t){if(!e)return t;try{return JSON.parse(e)}catch(e){return console.warn("解析本地存储 JSON 失败",e),t}}function E(){return"undefined"!=typeof crypto&&"function"==typeof crypto.randomUUID?crypto.randomUUID():`pl_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,8)}`}function $(e){const t="string"==typeof e?e.trim():"";return t?t.length>j?t.slice(0,j):t:U}function A(e){const t=e&&"object"==typeof e?e:{};const n={id:"string"==typeof t.id&&t.id.trim()?t.id.trim():E(),name:$(t.name),songs:Array.isArray(t.songs)?t.songs.filter(e=>e&&"object"==typeof e):[]};return n.id||(n.id=E()),n}function C(e){return Array.isArray(e)?e.filter(e=>e&&"object"==typeof e):[]}const N="playlistSync.meta.v1",D="/playlist",O="sync",q=(()=>{const e=x(I(N),null);return e&&"object"==typeof e?{id:"string"==typeof e.id&&e.id.trim()?e.id.trim():null,updatedAt:"string"==typeof e.updatedAt?e.updatedAt:null,lastSyncedAt:"string"==typeof e.lastSyncedAt?e.lastSyncedAt:null,lastSyncedSnapshot:"string"==typeof e.lastSyncedSnapshot?e.lastSyncedSnapshot:null}:null})(),R=["list","single","random"],_=["playlist","online","search"],F="playlists.v1",Q="activePlaylistId.v1",U="默认歌单",j=40,H=500,J={id:q?.id||null,updatedAt:q?.updatedAt||null,lastSyncedAt:q?.lastSyncedAt||null,lastSyncedSnapshot:q?.lastSyncedSnapshot||null,pendingSnapshot:null,debounceTimer:null,inFlight:null,enabled:!0,error:null,notifiedError:!1};let W=!1;function G({message:e,type:t="error"}={}){const n=J.enabled;J.debounceTimer&&(window.clearTimeout(J.debounceTimer),J.debounceTimer=null),J.enabled=!1,J.pendingSnapshot=null,J.inFlight=null,J.id=null,J.updatedAt=null,J.lastSyncedAt=null,J.lastSyncedSnapshot=null,J.error=null,J.notifiedError=!1,Y(),Z(),ee(),e&&n&&Ln(e,t)}function V(e){if(!e||"string"!=typeof e)return e;try{const t=new URL(e,window.location.href);return"http:"===t.protocol&&"https:"===window.location.protocol?(t.protocol="https:",t.toString()):t.toString()}catch(t){return"https:"===window.location.protocol&&e.startsWith("http://")?"https://"+e.substring(7):e}}function K(e){if(!e||"string"!=typeof e)return e;try{const t=new URL(e,window.location.href);return"https:"===t.protocol?t.toString():"http:"===t.protocol&&/(^|\.)kuwo\.cn$/i.test(t.hostname)?`${Te.baseUrl}?target=${encodeURIComponent(t.toString())}`:t.toString()}catch(t){return console.warn("无法解析音频地址，跳过代理",t),e}}function z(){const e=Array.isArray(Be.playlistSongs)?Be.playlistSongs:[];let t=Number.isInteger(Be.currentTrackIndex)?Be.currentTrackIndex:e.length?0:-1;0===e.length?t=-1:(t<0||t>=e.length)&&(t=Math.min(Math.max(t,0),e.length-1));const n={songs:e,currentTrackIndex:t,playMode:"string"==typeof Be.playMode&&R.includes(Be.playMode)?Be.playMode:R[0],playbackQuality:de(Be.playbackQuality),currentPlaylist:"string"==typeof Be.currentPlaylist&&_.includes(Be.currentPlaylist)?Be.currentPlaylist:_[0],currentSong:Be.currentSong&&"object"==typeof Be.currentSong?Be.currentSong:null,currentPlaybackTime:Number.isFinite(Be.currentPlaybackTime)&&Be.currentPlaybackTime>=0?Be.currentPlaybackTime:0};return Number.isFinite(Be.volume)&&(n.volume=Math.min(Math.max(Be.volume,0),1)),n}function X(e=null){const t=e||z();try{return JSON.stringify(t)}catch(e){return console.warn("序列化播放列表失败，使用空数据",e),JSON.stringify({songs:[],currentTrackIndex:-1,playMode:R[0],playbackQuality:"320",currentPlaylist:_[0],currentSong:null,currentPlaybackTime:0})}}function Y(){if(!J.id)return void B(N);const e={id:J.id,updatedAt:J.updatedAt,lastSyncedAt:J.lastSyncedAt,lastSyncedSnapshot:J.lastSyncedSnapshot};T(N,JSON.stringify(e))}function Z(){try{const e=new URL(window.location.href);if(J.id){if(e.searchParams.get(O)===J.id)return;e.searchParams.set(O,J.id)}else{if(!e.searchParams.has(O))return;e.searchParams.delete(O)}const t=`${e.pathname}${e.search}${e.hash}`;window.history.replaceState(window.history.state,document.title,t)}catch(e){console.warn("更新云同步分享链接失败",e)}}function ee(){if(!e.playlistSyncBtn||!e.playlistSyncStatus)return;const t=e.playlistSyncBtn,n=e.playlistSyncStatus;if(n.className="playlist-sync-status",!J.enabled)return t.disabled=!0,t.title="云同步不可用",n.textContent="云同步不可用",void n.classList.add("playlist-sync-status--error");if(!J.id)return t.disabled=!0,t.title="云同步初始化中...",void(n.textContent="云同步初始化中...");if(t.disabled=Boolean(J.inFlight),t.title="复制云同步链接",J.inFlight)return void(n.textContent="云同步中...");if(J.error)return n.textContent="同步失败，将自动重试",void n.classList.add("playlist-sync-status--error");let r="";if(J.lastSyncedAt){const e=function(e){if(!e)return"";const t=Date.parse(e);if(!Number.isFinite(t))return e;const n=Date.now()-t;if(n<45e3)return"刚刚";if(n<36e5)return`${Math.round(n/6e4)} 分钟前`;if(n<864e5)return`${Math.round(n/36e5)} 小时前`;const r=new Date(t);return`${r.toLocaleDateString()} ${r.toLocaleTimeString()}`}(J.lastSyncedAt);r=e?` · 更新于 ${e}`:"",n.classList.add("playlist-sync-status--success")}n.textContent=`云同步 ID: ${J.id}${r}`}function te(e){J.pendingSnapshot=e,J.debounceTimer&&window.clearTimeout(J.debounceTimer),J.id?(J.debounceTimer=window.setTimeout(()=>{J.debounceTimer=null,ne()},800),ee()):ee()}async function ne(){if(!J.enabled)return J.pendingSnapshot=null,void ee();if(!J.id||!J.pendingSnapshot)return void ee();if(J.inFlight)return;const e=J.pendingSnapshot;J.pendingSnapshot=null;const t=re(e).catch(t=>{J.error=t,J.pendingSnapshot=e,J.notifiedError||(Ln("云同步失败，将自动重试","error"),J.notifiedError=!0),console.warn("同步播放列表失败:",t)}).finally(()=>{J.inFlight=null,J.pendingSnapshot&&!J.debounceTimer&&J.enabled&&(J.debounceTimer=window.setTimeout(()=>{J.debounceTimer=null,ne()},1600)),ee()});J.inFlight=t,ee(),await t}async function re(e){if(!J.id)throw new Error("Missing playlist sync identifier");let t;try{t=JSON.parse(e)}catch(n){console.warn("解析同步数据失败",n),t=z(),e=X(t)}const n=await fetch(`${D}?id=${encodeURIComponent(J.id)}`,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(t)});if(404===n.status)return ae(t,e);if(501===n.status)throw G({message:"云同步不可用，将使用本地播放列表"}),new Error("Playlist sync unavailable");if(!n.ok)throw new Error(`Failed to update playlist: ${n.status}`);const r=await n.json(),a="string"==typeof r.updatedAt?r.updatedAt:(new Date).toISOString();return J.updatedAt=a,J.lastSyncedAt=a,J.lastSyncedSnapshot=e,J.error=null,J.notifiedError=!1,Y(),r}async function ae(e,t=X(e)){const n=await fetch(D,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(e)});if(501===n.status)throw G({message:"云同步不可用，将使用本地播放列表"}),new Error("Playlist sync unavailable");if(!n.ok)throw new Error(`Failed to create playlist: ${n.status}`);const r=await n.json();"string"==typeof r.id&&r.id.trim()&&(J.id=r.id.trim());const a="string"==typeof r.updatedAt?r.updatedAt:(new Date).toISOString();return J.updatedAt=a,J.lastSyncedAt=a,J.lastSyncedSnapshot=t,J.pendingSnapshot=null,J.error=null,J.notifiedError=!1,Y(),Z(),ee(),r}function ie(e){const t=e&&"object"==typeof e?e:{},n=Array.isArray(t.songs)?t.songs:[];let r=Number.isInteger(t.currentTrackIndex)?t.currentTrackIndex:n.length?0:-1;0===n.length?r=-1:(r<0||r>=n.length)&&(r=Math.min(Math.max(r,0),n.length-1));const a={songs:n,currentTrackIndex:r,playMode:"string"==typeof t.playMode&&R.includes(t.playMode)?t.playMode:R[0],playbackQuality:de("string"==typeof t.playbackQuality?t.playbackQuality:void 0),currentPlaylist:"string"==typeof t.currentPlaylist&&_.includes(t.currentPlaylist)?t.currentPlaylist:_[0],currentSong:t.currentSong&&"object"==typeof t.currentSong?t.currentSong:null,currentPlaybackTime:"number"==typeof t.currentPlaybackTime&&Number.isFinite(t.currentPlaybackTime)&&t.currentPlaybackTime>=0?t.currentPlaybackTime:0};return"number"==typeof t.volume&&Number.isFinite(t.volume)&&(a.volume=Math.min(Math.max(t.volume,0),1)),a}async function le(){if(!J.enabled)return void ee();if("function"!=typeof fetch)return void G({message:"当前环境不支持云同步"});ee();let t=null;try{const e=new URL(window.location.href);t=e.searchParams.get(O)?.trim()||null}catch(e){console.warn("解析云同步参数失败",e)}t&&t!==J.id&&(J.id=t,J.updatedAt=null,J.lastSyncedAt=null,J.lastSyncedSnapshot=null,J.pendingSnapshot=null,Y());const n=X();if(J.id){Z();try{const t=await async function(e){const t=await fetch(`${D}?id=${encodeURIComponent(e)}`,{method:"GET",headers:{Accept:"application/json"}});if(404===t.status)return null;if(501===t.status)return G({message:"云同步不可用，将使用本地播放列表"}),null;if(!t.ok)throw new Error(`Failed to fetch playlist: ${t.status}`);const n=await t.json();return{updatedAt:"string"==typeof n.updatedAt?n.updatedAt:(new Date).toISOString(),playlist:ie(n.playlist),version:n.version??1}}(J.id);if(!J.enabled)return void ee();if(!t)return await re(n),void ee();const r=X(t.playlist),a=Date.parse(t.updatedAt||""),i=J.updatedAt?Date.parse(J.updatedAt):NaN;Number.isFinite(a)&&(!Number.isFinite(i)||a>=i)&&r!==J.lastSyncedSnapshot&&function(t,n){const r=ie(t);W=!0;try{Ce(r.songs),Be.currentTrackIndex=r.currentTrackIndex,Be.playMode=r.playMode,Be.playbackQuality=r.playbackQuality,Be.currentPlaylist=r.currentPlaylist,Be.currentSong=r.currentSong,Be.currentPlaybackTime=r.currentPlaybackTime,"number"!=typeof r.volume||Number.isNaN(r.volume)||(Be.volume=r.volume,e.audioPlayer&&(e.audioPlayer.volume=r.volume),e.volumeSlider&&(e.volumeSlider.value=r.volume,Tt(r.volume),Bt(r.volume))),on()}finally{W=!1}J.lastSyncedSnapshot=n||X(r),J.pendingSnapshot=null,J.error=null,J.notifiedError=!1,Y(),ee()}(t.playlist,r),J.updatedAt=t.updatedAt,J.lastSyncedAt=t.updatedAt,J.lastSyncedSnapshot=r,J.error=null,J.notifiedError=!1,Y(),ee(),r!==n?te(n):J.pendingSnapshot=null}catch(e){if(!J.enabled)return void ee();J.error=e,J.notifiedError=!0,console.warn("拉取云播放列表失败:",e),Ln("同步云播放列表失败，将稍后重试","error"),ee()}}else{try{await ae(z(),n)}catch(e){return console.warn("初始化云同步失败:",e),void G({message:"云同步不可用，将使用本地播放列表"})}ee()}}async function oe(){if(!J.id)return void Ln("云同步尚未初始化","error");const e=function(e=J.id){if(!e)return window.location.href;try{const t=new URL(window.location.href);return t.searchParams.set(O,e),t.toString()}catch(t){return console.warn("生成云同步链接失败",t),`${window.location.origin}${window.location.pathname}?${O}=${encodeURIComponent(e)}`}}(J.id);try{if(navigator.clipboard&&"function"==typeof navigator.clipboard.writeText)await navigator.clipboard.writeText(e),Ln("云同步链接已复制","success");else{null!==window.prompt("复制云同步链接",e)&&Ln("请在新浏览器中打开该链接以恢复播放列表","success")}}catch(e){console.warn("复制云同步链接失败",e),Ln("复制失败，请手动复制链接","error")}}const se=[{value:"netease",label:"网易云音乐"},{value:"kuwo",label:"酷我音乐"},{value:"joox",label:"JOOX音乐"}];function ce(e){return se.map(e=>e.value).includes(e)?e:se[0].value}const ue=[{value:"128",label:"标准音质",description:"128 kbps"},{value:"192",label:"高品音质",description:"192 kbps"},{value:"320",label:"极高音质",description:"320 kbps"},{value:"999",label:"无损音质",description:"FLAC"}];function de(e){const t=ue.find(t=>t.value===e);return t?t.value:"320"}const ye=(()=>{const e=x(I("playlistSongs"),[]);return Array.isArray(e)?e:[]})(),me=(()=>{const e=x(I(F),null);if(!Array.isArray(e))return null;const t=[],n=new Set;for(const r of e){const e=A(r);let a=e.id;for(;n.has(a);)a=E();e.id=a,n.add(a),t.push(e)}return t})(),pe=(()=>{const e=I(Q);return"string"==typeof e&&e.trim()?e.trim():null})(),ge=(()=>{const e=I("currentTrackIndex"),t=Number.parseInt(e,10);return Number.isInteger(t)?t:-1})(),fe=(()=>{const e=I("playMode");return["list","single","random"].includes(e)?e:"list"})(),he=de(I("playbackQuality")),be=(()=>{const e=I("playerVolume"),t=Number.parseFloat(e);return Number.isFinite(t)?Math.min(Math.max(t,0),1):.8})(),ve=ce(I("searchSource")),Se=(()=>{const e=I("currentPlaybackTime"),t=Number.parseFloat(e);return Number.isFinite(t)&&t>=0?t:0})(),we=x(I("currentSong"),null),Pe=(()=>{const e=I("currentPlaylist");return["playlist","online","search"].includes(e)?e:"playlist"})(),Le=(()=>{const e=me&&me.length?me:null;if(e&&e.length)return e.map(e=>({id:e.id,name:$(e.name),songs:C(e.songs)}));const t=C(ye);return[A({id:E(),name:U,songs:t})]})(),Me=Le.length?pe&&Le.some(e=>e.id===pe)?pe:Le[0].id:null,ke=(()=>{if(!Le.length)return null;return Le.find(e=>e.id===Me)||Le[0]})(),Ie=ke?ke.songs:[],Te={baseUrl:"/proxy",generateSignature:()=>Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15),fetchJson:async e=>{try{const t=await fetch(e,{headers:{Accept:"application/json"}});if(!t.ok)throw new Error(`Request failed with status ${t.status}`);const n=await t.text();try{return JSON.parse(n)}catch(e){return console.warn("JSON parse failed, returning raw text",e),n}}catch(e){throw console.error("API request error:",e),e}},search:async(e,t="netease",n=20,r=1)=>{const a=Te.generateSignature(),i=`${Te.baseUrl}?types=search&source=${t}&name=${encodeURIComponent(e)}&count=${n}&pages=${r}&s=${a}`;try{ht(`API请求: ${i}`);const e=await Te.fetchJson(i);if(ht(`API响应: ${JSON.stringify(e).substring(0,200)}...`),!Array.isArray(e))throw new Error("搜索结果格式错误");return e.map(e=>({id:e.id,name:e.name,artist:e.artist,album:e.album,pic_id:e.pic_id,url_id:e.url_id,lyric_id:e.lyric_id,source:e.source}))}catch(e){throw ht(`API错误: ${e.message}`),e}},getRadarPlaylist:async(e="3778678",t={})=>{const n=Te.generateSignature();let r=50,a=0;"number"==typeof t?r=t:t&&"object"==typeof t&&(Number.isFinite(t.limit)?r=t.limit:Number.isFinite(t.count)&&(r=t.count),Number.isFinite(t.offset)&&(a=t.offset)),r=Math.max(1,Math.min(200,Math.trunc(r))||50),a=Math.max(0,Math.trunc(a)||0);const i=new URLSearchParams({types:"playlist",id:e,limit:String(r),offset:String(a),s:n}),l=`${Te.baseUrl}?${i.toString()}`;try{const e=await Te.fetchJson(l),t=e&&e.playlist&&Array.isArray(e.playlist.tracks)?e.playlist.tracks.slice(0,r):[];if(0===t.length)throw new Error("No tracks found");return t.map(e=>({id:e.id,name:e.name,artist:Array.isArray(e.ar)?e.ar.map(e=>e.name).join(" / "):"",source:"netease",lyric_id:e.id,pic_id:e.al?.pic_str||e.al?.pic||e.al?.picUrl||""}))}catch(e){throw console.error("API request failed:",e),e}},getNeteasePlaylistDetail:async(e,t={})=>{if(!e)throw new Error("缺少歌单ID");const n=Number.isFinite(t.limit)?Math.trunc(t.limit):null,r=Number.isFinite(t.maxTracks)?Math.trunc(t.maxTracks):null,a=Number.isFinite(t.offset)?Math.trunc(t.offset):null,i=Math.max(1,Math.min(200,n??200)),l=Math.max(i,Math.min(H,r??H));let o=Math.max(0,a??0);const s=[],c=new Set;let u=null,d=null,y=0;for(;s.length<l;){const t=new URLSearchParams({types:"playlist",id:e,limit:String(i),offset:String(o),s:Te.generateSignature()}),n=`${Te.baseUrl}?${t.toString()}`,r=await Te.fetchJson(n),a=r&&r.playlist?r.playlist:null;if(!a)break;u||(u={id:a.id??e,name:a.name??"",trackCount:"number"==typeof a.trackCount?a.trackCount:null,coverImgUrl:a.coverImgUrl||a.cover?.imgUrl||""}),null==d&&"number"==typeof a.trackCount&&(d=a.trackCount);const m=Array.isArray(a.tracks)?a.tracks:[],p=s.length;for(const e of m){if(!e||"object"!=typeof e)continue;const t=e.id??e.trackId??e.song?.id;if(null==t)continue;const n=String(t);if(c.has(n))continue;c.add(n);const r=Array.isArray(e.ar)?e.ar.map(e=>e&&e.name?e.name:null).filter(Boolean):Array.isArray(e.artists)?e.artists.map(e=>e?"string"==typeof e?e:Array.isArray(e.alias)&&e.alias.length?e.alias[0]:e.name||null:null).filter(Boolean):[],a=r.length?r.join(" / "):"string"==typeof e.artist&&e.artist.trim()?e.artist:"未知艺术家",i=e.al?.name||e.album?.name||e.album||"",o=e.al?.pic_str||e.al?.pic||e.al?.picUrl||e.album?.picUrl||e.al?.coverImgId_str||e.al?.coverImgId||e.al?.picId||"";if(s.push({id:n,name:e.name||e.song?.name||`未命名歌曲 ${n}`,artist:a,album:i,source:"netease",lyric_id:e.id||e.lyricId||n,pic_id:o,url_id:n}),s.length>=l)break}if(s.length>=l)break;if(m.length<i)break;if(s.length===p)break;if(o+=m.length,y+=1,y>=5)break;if(null!=d&&o>=d)break}const m=d??u?.trackCount??null,p=s.length>=l,g=p||null!=m&&m>s.length;return{playlist:u||{id:e,name:"",trackCount:s.length,coverImgUrl:""},songs:s.slice(0,l),truncated:g,truncatedByLimit:p}},getSongUrl:(e,t="320")=>{const n=Te.generateSignature();return`${Te.baseUrl}?types=url&id=${e.id}&source=${e.source||"netease"}&br=${t}&s=${n}`},getLyric:e=>{const t=Te.generateSignature();return`${Te.baseUrl}?types=lyric&id=${e.lyric_id||e.id}&source=${e.source||"netease"}&s=${t}`},getPicUrl:e=>{const t=Te.generateSignature();return`${Te.baseUrl}?types=pic&id=${e.pic_id}&source=${e.source||"netease"}&size=300&s=${t}`}};Object.freeze(Te);const Be={onlineSongs:[],searchResults:[],renderedSearchCount:0,playlists:Le,activePlaylistId:Me,currentTrackIndex:ge,currentAudioUrl:null,lyricsData:[],currentLyricLine:-1,currentPlaylist:Pe,searchPage:1,searchKeyword:"",searchSource:ve,hasMoreResults:!0,currentSong:we,debugMode:!1,isSearchMode:!1,playlistSongs:Ie,playMode:fe,playbackQuality:he,volume:be,currentPlaybackTime:Se,lastSavedPlaybackTime:Se,pendingSeekTime:null,isSeeking:!1,qualityMenuOpen:!1,sourceMenuOpen:!1,playlistMenuOpen:!1,userScrolledLyrics:!1,lyricsScrollTimeout:null,themeDefaultsCaptured:!1,dynamicPalette:null,currentPaletteImage:null,pendingPaletteData:null,pendingPaletteImage:null,pendingPaletteImmediate:!1,pendingPaletteReady:!1,audioReadyForPalette:!0,currentGradient:"",isMobileInlineLyricsOpen:!1,defaultDocumentTitle:document.title,tabTitleBase:document.title,currentLyricForTitle:"",bilingualLyrics:!0};let xe=null;function Ee(e){return e&&Be.playlists.find(t=>t.id===e)||null}function $e(){if(!Be.playlists.length){const e=A({id:E(),name:U,songs:[]});return Be.playlists.push(e),Be.activePlaylistId=e.id,Be.playlistSongs=e.songs,e}let e=Ee(Be.activePlaylistId);return e||(e=Be.playlists[0],Be.activePlaylistId=e.id,Be.playlistSongs=e.songs),e}function Ae(){return $e()}function Ce(e){const t=$e();return t.songs=Array.isArray(e)?C(e):[],Be.playlistSongs=t.songs,t}function Ne(e){if(!e||"object"!=typeof e)return"";return`${null!=e.id?String(e.id):JSON.stringify(e)}::${null!=e.source?String(e.source):""}`}function De(e,t=Be.activePlaylistId){const n=Ee(t);if(!n||!e||"object"!=typeof e)return{added:!1,index:-1,playlist:n||null,duplicate:!1};n.songs=Array.isArray(n.songs)?n.songs:[];const r=n.songs,a=Ne(e),i=r.findIndex(e=>Ne(e)===a);return-1!==i?{added:!1,index:i,playlist:n,duplicate:!0}:(r.push(e),t===Be.activePlaylistId&&(Be.playlistSongs=r),{added:!0,index:r.length-1,playlist:n,duplicate:!1})}function Oe(){if(!e.playlistSelectorLabel||!e.playlistSelectorButton)return;const t=Ae(),n=t?t.name:U;if(e.playlistSelectorLabel.textContent=n,e.playlistSelectorButton.setAttribute("aria-expanded",Be.playlistMenuOpen?"true":"false"),t?(e.playlistSelectorButton.dataset.playlistId=t.id,e.playlistSelectorButton.title=`当前歌单：${n}`):(e.playlistSelectorButton.dataset.playlistId="",e.playlistSelectorButton.title="选择歌单"),e.deletePlaylistBtn){const t=Be.playlists.length<=1;e.deletePlaylistBtn.disabled=t,e.deletePlaylistBtn.setAttribute("aria-disabled",t?"true":"false"),e.deletePlaylistBtn.title=t?"至少保留一个歌单":"删除当前歌单"}}function qe(){if(e.playlistMenu){if(e.playlistMenu.innerHTML="",!Be.playlists.length){const t=document.createElement("div");return t.className="playlist-selector__empty",t.textContent="暂无歌单",void e.playlistMenu.appendChild(t)}Be.playlists.forEach(t=>{const n=t.id===Be.activePlaylistId,r=document.createElement("div");r.className="playlist-selector__item"+(n?" active":""),r.dataset.playlistId=t.id,r.setAttribute("role","option"),r.setAttribute("aria-selected",n?"true":"false");const a=document.createElement("span");a.className="playlist-selector__item-name",a.textContent=t.name;const i=document.createElement("span");i.className="playlist-selector__item-count",i.textContent=String(Array.isArray(t.songs)?t.songs.length:0),r.appendChild(a),r.appendChild(i),e.playlistMenu.appendChild(r)})}}function Re(){e.playlistMenu&&e.playlistSelectorButton?(e.playlistMenu.classList.remove("show"),e.playlistSelectorButton.setAttribute("aria-expanded","false"),Be.playlistMenuOpen=!1):Be.playlistMenuOpen=!1}function _e(t){t&&(t.preventDefault(),t.stopPropagation()),Be.playlistMenuOpen?Re():e.playlistMenu&&e.playlistSelectorButton&&(Be.playlistMenuOpen||(Je(),qe(),e.playlistMenu.classList.add("show"),e.playlistSelectorButton.setAttribute("aria-expanded","true"),Be.playlistMenuOpen=!0))}function Fe(e){const t=e.target.closest(".playlist-selector__item");if(!t)return;const n=t.dataset.playlistId;Re(),n&&function(e){const t=Ee(e);if(!t||t.id===Be.activePlaylistId)return void Oe();Je(),Re(),Be.activePlaylistId=t.id,Be.playlistSongs=t.songs,Be.currentPlaylist="playlist","playlist"===Be.currentPlaylist&&(Be.currentTrackIndex=-1);on()}(n)}function Qe(e=""){const t=$(e||`新歌单${Be.playlists.length+1}`),n=window.prompt("输入歌单名称",t);if(null===n)return null;return $(n)||t}function Ue(e,{activate:t=!0,songs:n=[]}={}){const r=A({id:E(),name:e,songs:n});return Be.playlists.push(r),t&&(Be.activePlaylistId=r.id,Be.playlistSongs=r.songs,Be.currentTrackIndex=-1),qe(),Oe(),t||ft(),r}function je(){if(Be.playlists.length<=1)return void Ln("至少保留一个歌单","warning");Je(),Re();const t=Ae();if(!t)return;const n=t.songs.length?`确定删除歌单「${t.name}」？这将移除其中的 ${t.songs.length} 首歌曲`:`确定删除歌单「${t.name}」？`;if(!window.confirm(n))return;const r=Be.playlists.findIndex(e=>e.id===t.id);if(-1===r)return;"playlist"===Be.currentPlaylist&&Be.activePlaylistId===t.id&&function(t){let n=t;n&&"object"==typeof n&&"function"==typeof n.preventDefault&&(n.preventDefault(),"function"==typeof n.stopPropagation&&n.stopPropagation(),n={});const r=Boolean((n&&"object"==typeof n?n:{}).silent);if(0===Be.playlistSongs.length)return void(r||Ln("播放列表已为空","warning"));"playlist"===Be.currentPlaylist&&(e.audioPlayer.pause(),e.audioPlayer.src="",Be.currentTrackIndex=-1,Be.currentSong=null,Ge(""),Be.currentAudioUrl=null,Be.currentPlaybackTime=0,Be.lastSavedPlaybackTime=0,e.progressBar.value=0,e.progressBar.max=0,e.currentTimeDisplay.textContent="00:00",e.durationDisplay.textContent="00:00",It(0,1),e.currentSongTitle.textContent="选择一首歌曲开始播放",a(),e.currentSongArtist.textContent="未知艺术家",gt(),bn(),e.lyrics&&(e.lyrics.dataset.placeholder="default"),e.lyrics.classList.add("empty"),kt());Ce([]),Be.currentPlaylist="playlist",Be.currentTrackIndex=-1,Je(),Re(),on(),r||Ln("播放列表已清空","success")}({silent:!0}),Be.playlists.splice(r,1);const i=Be.playlists[r]||Be.playlists[r-1]||Be.playlists[0]||null;if(i)Be.activePlaylistId=i.id,Be.playlistSongs=i.songs;else{const e=Ue(U,{activate:!0});Be.activePlaylistId=e.id,Be.playlistSongs=e.songs}Be.currentPlaylist="playlist",on(),Ln(`已删除歌单「${t.name}」`,"success")}async function He(){Je(),Re();const t=window.prompt("输入网易云歌单链接或ID","");if(null===t)return;const n=function(e){if(null==e)return"";const t=String(e).trim();if(!t)return"";if(/^\d+$/.test(t))return t;const n=t.match(/id=(\d+)/);if(n)return n[1];try{const e=/^https?:\/\//i.test(t)?t:`https://${t.replace(/^\/+/,"")}`,n=new URL(e),r=n.searchParams.get("id");if(r&&/^\d+$/.test(r))return r;if(n.hash){const e=n.hash.match(/id=(\d+)/);if(e)return e[1];const t=n.hash.replace(/^#/,"");if(t)try{const e=new URL(`${n.origin}/${t.startsWith("/")?t.slice(1):t}`).searchParams.get("id");if(e&&/^\d+$/.test(e))return e}catch{}}const a=n.pathname.match(/playlist[\/-](\d+)/i);if(a)return a[1]}catch{}return""}(t);if(!n)return void Ln("请输入有效的网易云歌单链接或ID","error");const r=e.importPlaylistBtn;let a=null;r&&(a=r.innerHTML,r.disabled=!0,r.setAttribute("aria-busy","true"),r.innerHTML='<i class="fas fa-spinner fa-spin"></i>');try{const{playlist:e,songs:t,truncated:r,truncatedByLimit:a}=await Te.getNeteasePlaylistDetail(n,{limit:200,maxTracks:H,offset:0});if(!t.length)return void Ln("未能从该歌单导入歌曲，请检查链接是否正确","error");const i=Ae(),l=i?i.name:U,o=e&&e.name?e.name:"网易云歌单";if(!(!e||!e.name)&&window.confirm(`导入歌单「${e.name}」，是否创建新的本地歌单保存？\n选择“确定”创建新歌单，选择“取消”将歌曲添加到当前歌单「${l}」。`)){const e=Qe(o);if(null===e)return void Ln("已取消导入","warning");const n=Ue(e,{activate:!0,songs:t});if(Be.currentPlaylist="playlist",Be.currentTrackIndex=-1,on(),Ln(`已导入 ${t.length} 首歌曲到新歌单「${n.name}」`,"success"),r){Ln(a?"部分歌曲未导入，已达到导入上限（最多 500 首）":"部分歌曲未导入，网易云接口未返回全部歌曲","warning")}return}const s=i?i.id:Be.activePlaylistId,c=function(e,t=Be.activePlaylistId){const n=Ee(t);if(!n||!Array.isArray(e)||!e.length)return{added:0,duplicates:0,playlist:n};n.songs=Array.isArray(n.songs)?n.songs:[];const r=new Set(n.songs.map(Ne));let a=0,i=0;for(const t of e){if(!t||"object"!=typeof t)continue;const e=Ne(t);r.has(e)?i+=1:(r.add(e),n.songs.push(t),a+=1)}return t===Be.activePlaylistId&&(Be.playlistSongs=n.songs),{added:a,duplicates:i,playlist:n}}(t,s),u=Ee(s);if(c.added>0){u&&u.id===Be.activePlaylistId?on():(qe(),Oe(),ft());let e=`已导入 ${c.added} 首歌曲到「${u?u.name:U}」`;if(c.duplicates>0&&(e+=`，跳过 ${c.duplicates} 首已存在的歌曲`),Ln(e,"success"),r){Ln(a?"部分歌曲未导入，已达到导入上限（最多 500 首）":"部分歌曲未导入，网易云接口未返回全部歌曲","warning")}}else Ln("导入的歌曲已全部存在当前歌单","warning")}catch(e){console.error("导入网易云歌单失败:",e);Ln(`导入失败：${e&&e.message?e.message:"导入失败"}`,"error")}finally{r&&(r.disabled=!1,r.setAttribute("aria-busy","false"),null!=a&&(r.innerHTML=a))}}function Je(){xe&&xe.parentNode&&xe.parentNode.removeChild(xe),xe=null}function We(){const e=Be.defaultDocumentTitle||document.title||"",t=(Be.currentLyricForTitle||"").trim(),n=(Be.tabTitleBase||e).trim(),r=[];t&&r.push(t),n&&n!==t&&r.push(n);const a=r.join(" · ")||e;document.title!==a&&(document.title=a)}function Ge(e){const t=Be.defaultDocumentTitle||document.title||"",n=("string"==typeof e?e.trim():"")||t;Be.tabTitleBase!==n&&(Be.tabTitleBase=n),We()}function Ve(e){const t="string"==typeof e?e.trim():"";Be.currentLyricForTitle!==t&&(Be.currentLyricForTitle=t),We()}let Ke=null,ze=null,Xe=!1,Ye=null;function Ze(){null!==Ke&&(window.cancelAnimationFrame(Ke),Ke=null)}function et(){Be.sourceMenuOpen?null===Ke&&(Ke=window.requestAnimationFrame(()=>{Ke=null,Ft()})):Ze()}function tt(){null!==ze&&(window.cancelAnimationFrame(ze),ze=null)}function nt(){Be.qualityMenuOpen?null===ze&&(ze=window.requestAnimationFrame(()=>{ze=null,zt()})):tt()}function rt(){Be.sourceMenuOpen&&et(),Be.qualityMenuOpen&&nt()}function at(){Be.sourceMenuOpen&&et(),Be.qualityMenuOpen&&nt()}function it(){Xe||(window.addEventListener("resize",rt),window.addEventListener("scroll",at,{passive:!0,capture:!0}),Xe=!0)}function lt(){Be.sourceMenuOpen||Be.qualityMenuOpen||Xe&&(window.removeEventListener("resize",rt),window.removeEventListener("scroll",at,!0),Xe=!1)}function ot(e,t){"string"==typeof e&&(document.documentElement.style.setProperty(e,t),document.body&&document.body.style.setProperty(e,t))}function st(e){"string"==typeof e&&(document.documentElement.style.removeProperty(e),document.body&&document.body.style.removeProperty(e))}function ct(){if(Be.themeDefaultsCaptured)return;const e=document.body.classList.contains("dark-mode");document.body.classList.remove("dark-mode");const t=getComputedStyle(document.body);k.light.gradient=t.getPropertyValue("--bg-gradient").trim(),k.light.primaryColor=t.getPropertyValue("--primary-color").trim(),k.light.primaryColorDark=t.getPropertyValue("--primary-color-dark").trim(),document.body.classList.add("dark-mode");const n=getComputedStyle(document.body);k.dark.gradient=n.getPropertyValue("--bg-gradient").trim(),k.dark.primaryColor=n.getPropertyValue("--primary-color").trim(),k.dark.primaryColorDark=n.getPropertyValue("--primary-color-dark").trim(),e||document.body.classList.remove("dark-mode"),Be.themeDefaultsCaptured=!0}function ut(e){e&&(e.primaryColor&&ot("--primary-color",e.primaryColor),e.primaryColorDark&&ot("--primary-color-dark",e.primaryColorDark))}function dt(t={}){Be.themeDefaultsCaptured||ct();const n=document.body.classList.contains("dark-mode")?"dark":"light",r=k[n];let a=r.gradient||"";ut(r);const i=Be.dynamicPalette;if(i&&i.gradients){const e=i.gradients;let t=n,r=e[t]||null;if(!r){const n="dark"===t?["light"]:["dark"];for(const a of n)if(e[a]){t=a,r=e[a];break}if(!r){const n=Object.keys(e);if(n.length){const a=n[0];t=a,r=e[a]}}}if(r&&r.gradient&&(a=r.gradient),i.tokens){const e=i.tokens[t]||i.tokens[n];e&&ut(e)}}!function(t,{immediate:n=!1}={}){const r=(t||"").trim(),a=(Be.currentGradient||"").trim(),i=n||r===a;e.backgroundTransitionLayer&&e.backgroundBaseLayer?(window.clearTimeout(S),i?(r?(ot("--bg-gradient",r),ot("--bg-gradient-next",r)):(st("--bg-gradient"),st("--bg-gradient-next")),document.body.classList.remove("background-transitioning"),Be.currentGradient=r):(r?ot("--bg-gradient-next",r):st("--bg-gradient-next"),requestAnimationFrame(()=>{document.body.classList.add("background-transitioning"),S=window.setTimeout(()=>{r?(ot("--bg-gradient",r),ot("--bg-gradient-next",r)):(st("--bg-gradient"),st("--bg-gradient-next")),document.body.classList.remove("background-transitioning"),Be.currentGradient=r},850)}))):(r?(ot("--bg-gradient",r),ot("--bg-gradient-next",r)):(st("--bg-gradient"),st("--bg-gradient-next")),Be.currentGradient=r)}(a,t)}function yt(e={}){window.clearTimeout(w),w=null,mt(),Be.pendingPaletteData=null,Be.pendingPaletteImage=null,Be.pendingPaletteImmediate=Boolean(e.immediate),Be.pendingPaletteReady=!0,pt()}function mt(){null!==P&&("idle"===L&&"function"==typeof window.cancelIdleCallback?window.cancelIdleCallback(P):window.clearTimeout(P),P=null,L="",M=null)}function pt(){if(!Be.pendingPaletteReady||!Be.audioReadyForPalette)return;const e=Be.pendingPaletteData||null,t=Be.pendingPaletteImage||null,n=Be.pendingPaletteImmediate;Be.pendingPaletteData=null,Be.pendingPaletteImage=null,Be.pendingPaletteImmediate=!1,Be.pendingPaletteReady=!1;if(n)return w=null,Be.dynamicPalette=e,Be.currentPaletteImage=t,void dt({immediate:!0});w=window.setTimeout(()=>{w=null,Be.dynamicPalette=e,Be.currentPaletteImage=t,dt({immediate:!1})},140)}function gt(){e.albumCover.innerHTML=f,e.albumCover.classList.remove("loading"),yt()}function ft(){T("playlistSongs",JSON.stringify(Be.playlistSongs)),T(F,JSON.stringify(Be.playlists)),Be.activePlaylistId?T(Q,Be.activePlaylistId):B(Q),T("currentTrackIndex",String(Be.currentTrackIndex)),T("playMode",Be.playMode),T("playbackQuality",Be.playbackQuality),T("playerVolume",String(Be.volume)),T("currentPlaylist",Be.currentPlaylist),Be.currentSong?T("currentSong",JSON.stringify(Be.currentSong)):T("currentSong",""),T("currentPlaybackTime",String(Be.currentPlaybackTime||0));const e=X();if(W)return J.lastSyncedSnapshot=e,Y(),void ee();!function(e){if(J.enabled){if(e||(e=X()),!J.id)return J.pendingSnapshot=e,void ee();(J.lastSyncedSnapshot!==e||J.pendingSnapshot)&&te(e)}}(e),ee()}function ht(t){if(console.log(`[DEBUG] ${t}`),Be.debugMode){const n=e.debugInfo;n.innerHTML+=`<div>${(new Date).toLocaleTimeString()}: ${t}</div>`,n.classList.add("show"),n.scrollTop=n.scrollHeight}}function bt(t){Be.isSearchMode=t,t?(e.container.classList.add("search-mode"),ht("进入搜索模式")):(e.container.classList.remove("search-mode"),ht("退出搜索模式"))}function vt(){bt(!1),Be.sourceMenuOpen&&et(),Be.qualityMenuOpen&&nt(),e.searchResults.innerHTML="",Be.renderedSearchCount=0}Be.currentGradient=getComputedStyle(document.documentElement).getPropertyValue("--bg-gradient").trim(),Be.currentGradient&&ot("--bg-gradient-next",Be.currentGradient),function(){const e=I(b);if(e)try{const t=JSON.parse(e);if(Array.isArray(t))for(const e of t)Array.isArray(e)&&"string"==typeof e[0]&&e[1]&&"object"==typeof e[1]&&h.set(e[0],e[1])}catch(e){console.warn("解析调色板缓存失败",e)}}(),document.addEventListener("keydown",t=>{t.ctrlKey&&"d"===t.key&&(t.preventDefault(),Be.debugMode=!Be.debugMode,Be.debugMode?(e.debugInfo.classList.add("show"),ht("调试模式已启用")):e.debugInfo.classList.remove("show"))});const St={list:"列表循环",single:"单曲循环",random:"随机播放"},wt={list:"fa-repeat",single:"fa-redo",random:"fa-shuffle"};function Pt(){const t=Be.playMode;e.playModeBtn.innerHTML=`<i class="fas ${wt[t]||wt.list}"></i>`,e.playModeBtn.title=`播放模式: ${St[t]||St.list}`}function Lt(){const e=["list","single","random"],t=(e.indexOf(Be.playMode)+1)%e.length;Be.playMode=e[t],Pt(),ft();Ln(`播放模式: ${St[Be.playMode]||St.list}`),ht(`播放模式切换为: ${Be.playMode}`)}function Mt(e){if(!Number.isFinite(e)||e<0)return"00:00";const t=Math.floor(e),n=Math.floor(t/60),r=t%60;return`${String(n).padStart(2,"0")}:${String(r).padStart(2,"0")}`}function kt(){if(!e.playPauseBtn)return;const t=!e.audioPlayer.paused&&!e.audioPlayer.ended;e.playPauseBtn.innerHTML=`<i class="fas ${t?"fa-pause":"fa-play"}"></i>`,e.playPauseBtn.title=t?"暂停":"播放",document.body&&document.body.classList.toggle("is-playing",t)}function It(t=Number(e.progressBar.value),n=Number(e.progressBar.max)){const r=Number.isFinite(n)&&n>0?n:0,a=Number.isFinite(t)?Math.max(t,0):0,i=r>0?100*Math.min(a/r,1):0;e.progressBar.style.setProperty("--progress",`${i}%`)}function Tt(t=e.audioPlayer.volume){const n=Math.min(Math.max(Number.isFinite(t)?t:0,0),1);e.volumeSlider.style.setProperty("--volume-progress",100*n+"%")}function Bt(t){if(!e.volumeIcon)return;const n=Math.min(Math.max(Number.isFinite(t)?t:0,0),1);let r="fa-volume-high";0===n?r="fa-volume-xmark":n<.4&&(r="fa-volume-low"),e.volumeIcon.className=`fas ${r}`}function xt(){const t=e.audioPlayer.volume;Be.volume=t,e.volumeSlider.value=t,Tt(t),Bt(t),ft()}function Et(t){const n=Number.parseFloat(t.target.value),r=Number.isFinite(n)?Math.min(Math.max(n,0),1):e.audioPlayer.volume;e.audioPlayer.volume=r,Be.volume=r,Tt(r),Bt(r),T("playerVolume",String(r))}function $t(){const t=e.audioPlayer.currentTime||0;Be.isSeeking||(e.progressBar.value=t,e.currentTimeDisplay.textContent=Mt(t),It(t,Number(e.progressBar.max))),vn(),Be.currentPlaybackTime=t,Math.abs(t-Be.lastSavedPlaybackTime)>=2&&(Be.lastSavedPlaybackTime=t,T("currentPlaybackTime",t.toFixed(1)))}function At(){const t=e.audioPlayer.duration||0;e.progressBar.max=t,e.durationDisplay.textContent=Mt(t),It(e.audioPlayer.currentTime||0,t),null!=Be.pendingSeekTime&&(Ct(Be.pendingSeekTime),Be.pendingSeekTime=null)}function Ct(t){if(!Number.isFinite(t))return;const n=e.audioPlayer.duration||Number(e.progressBar.max)||0,r=n>0?Math.min(Math.max(t,0),n):Math.max(t,0);try{e.audioPlayer.currentTime=r}catch(e){console.warn("设置播放进度失败",e)}e.progressBar.value=r,e.currentTimeDisplay.textContent=Mt(r),It(r,n),Be.currentPlaybackTime=r}function Nt(){Be.isSeeking=!0;const t=Number(e.progressBar.value);e.currentTimeDisplay.textContent=Mt(t),It(t,Number(e.progressBar.max))}function Dt(){const t=Number(e.progressBar.value);Be.isSeeking=!1,Ot(t)}function Ot(e){Number.isFinite(e)&&(Ct(e),Be.lastSavedPlaybackTime=Be.currentPlaybackTime,T("currentPlaybackTime",Be.currentPlaybackTime.toFixed(1)))}async function qt(){if(Be.currentSong)if(e.audioPlayer.src)if(e.audioPlayer.paused){const t=e.audioPlayer.play();void 0!==t&&t.catch(e=>{console.error("播放失败:",e),Ln("播放失败，请检查网络连接","error")})}else e.audioPlayer.pause();else try{await pn(Be.currentSong,{autoplay:!0,startTime:Be.currentPlaybackTime,preserveProgress:!0})}catch(e){console.error("恢复播放失败:",e),Ln("播放失败，请稍后重试","error")}else if(Be.playlistSongs.length>0){const e=Be.currentTrackIndex>=0&&Be.currentTrackIndex<Be.playlistSongs.length?Be.currentTrackIndex:0;await sn(e)}else Ln("播放列表为空，请先添加歌曲","error")}function Rt(){if(!e.sourceMenu)return;const t=se.map(e=>{const t=e.value===Be.searchSource;return`\n            <div class="source-option${t?" active":""}" data-source="${e.value}" role="option" aria-selected="${t}">\n                <span>${e.label}</span>\n                ${t?'<i class="fas fa-check" aria-hidden="true"></i>':""}\n            </div>\n        `}).join("");e.sourceMenu.innerHTML=t,Be.sourceMenuOpen&&et()}function _t(){const t=se.find(e=>e.value===Be.searchSource)||se[0];t&&e.sourceSelectLabel&&e.sourceSelectButton&&(e.sourceSelectLabel.textContent=t.label,e.sourceSelectButton.dataset.source=t.value,e.sourceSelectButton.setAttribute("aria-expanded",Be.sourceMenuOpen?"true":"false"),e.sourceSelectButton.setAttribute("aria-label",`当前音源：${t.label}，点击切换音源`),e.sourceSelectButton.setAttribute("title",`音源：${t.label}`))}function Ft(){if(!Be.sourceMenuOpen||!e.sourceMenu||!e.sourceSelectButton)return;const t=e.sourceMenu,n=e.sourceSelectButton,r=Math.ceil(n.getBoundingClientRect().width),a=Math.max(r,140);t.style.left="0px",t.style.width=`${a}px`,t.style.minWidth=`${a}px`,t.style.maxWidth=`${a}px`;const i=Math.max(t.scrollHeight,0),l=n.getBoundingClientRect(),o=Math.max(window.innerHeight||0,document.documentElement.clientHeight||0),s=Math.max(o-l.bottom-10,0),c=l.top-10-i>=0;i>s&&c?(t.classList.add("open-upwards"),t.classList.remove("open-downwards"),t.style.top="",t.style.bottom=`${n.offsetHeight+10}px`):(t.classList.add("open-downwards"),t.classList.remove("open-upwards"),t.style.bottom="",t.style.top=`${n.offsetHeight+10}px`)}function Qt(){e.sourceMenu&&(e.sourceMenu.classList.remove("show"),e.sourceSelectButton.classList.remove("active"),e.sourceSelectButton.setAttribute("aria-expanded","false"),Be.sourceMenuOpen=!1,Ze(),e.sourceMenu&&(e.sourceMenu.classList.remove("open-upwards","open-downwards"),e.sourceMenu.style.top="",e.sourceMenu.style.left="",e.sourceMenu.style.bottom="",e.sourceMenu.style.minWidth="",e.sourceMenu.style.maxWidth="",e.sourceMenu.style.width=""),lt())}function Ut(t){t.preventDefault(),t.stopPropagation(),Be.sourceMenuOpen?Qt():e.sourceMenu&&e.sourceSelectButton&&(Be.sourceMenuOpen=!0,it(),Rt(),e.sourceMenu.classList.add("show"),e.sourceSelectButton.classList.add("active"),e.sourceSelectButton.setAttribute("aria-expanded","true"),Ft(),et())}function jt(e){const t=e.target.closest(".source-option");if(!t)return;e.preventDefault(),e.stopPropagation();const{source:n}=t.dataset;n&&function(e){const t=ce(e);if(t===Be.searchSource)return void Qt();Be.searchSource=t,T("searchSource",t),_t(),Rt(),Qt()}(n)}function Ht(){if(!e.playerQualityMenu)return;const t=ue.map(e=>`\n            <div class="player-quality-option${e.value===Be.playbackQuality?" active":""}" data-quality="${e.value}">\n                <span>${e.label}</span>\n                <small>${e.description}</small>\n            </div>\n        `).join("");e.playerQualityMenu.innerHTML=t,Be.qualityMenuOpen&&nt()}function Jt(e){return Boolean(e)&&"object"==typeof e&&1===e.nodeType}function Wt(t){return Jt(t)?t:Jt(e.qualityToggle)?e.qualityToggle:Jt(e.mobileQualityToggle)?e.mobileQualityToggle:null}function Gt(e,t){Jt(e)&&(e.classList.toggle("active",Boolean(t)),"function"==typeof e.setAttribute&&e.setAttribute("aria-expanded",t?"true":"false"))}function Vt(){const t=ue.find(e=>e.value===Be.playbackQuality)||ue[0];t&&(e.qualityLabel.textContent=t.label,e.qualityToggle.title=`音质: ${t.label} (${t.description})`,e.mobileQualityLabel&&(e.mobileQualityLabel.textContent=t.label),e.mobileQualityToggle&&(e.mobileQualityToggle.title=`音质: ${t.label} (${t.description})`))}function Kt(t){t&&(t.preventDefault(),t.stopPropagation());const n=Wt(t&&t.currentTarget?t.currentTarget:Ye);n&&(Be.qualityMenuOpen&&Ye===n?Yt():function(t){if(!e.playerQualityMenu)return;const n=Wt(t);if(!n)return;Ye&&Ye!==n&&Gt(Ye,!1);Ye=n,Be.qualityMenuOpen=!0,it();const r=e.playerQualityMenu;Gt(Ye,!0),r.classList.add("floating"),r.classList.remove("show"),function(e,t){if(!e||"function"!=typeof t)return;const n=e.style.transition;e.style.transition="none",t(),e.offsetHeight,n?e.style.transition=n:e.style.removeProperty("transition")}(r,()=>{zt()}),requestAnimationFrame(()=>{Be.qualityMenuOpen&&r.classList.add("show")}),nt()}(n))}function zt(){if(!Be.qualityMenuOpen||!e.playerQualityMenu)return;const n=function(){if(Jt(Ye)&&(!document.body||document.body.contains(Ye)))return Ye;const e=Wt();return Ye=e,e}();if(!Jt(n))return;const r=e.playerQualityMenu,a=n.getBoundingClientRect(),i=Math.max(window.innerWidth||0,document.documentElement.clientWidth||0),l=Math.max(window.innerHeight||0,document.documentElement.clientHeight||0),o=10;r.classList.add("floating");const s=Math.max(Math.round(a.width),180);r.style.minWidth=`${s}px`,r.style.maxWidth=`${s}px`,r.style.width=`${s}px`,r.style.right="auto";const c=r.getBoundingClientRect(),u=Math.round(c.height),d=Math.round(c.width)||s;let y=Math.round(a.bottom+o),m=!1;if(y+u>l-o){const e=Math.round(a.top-o-u);e>=o?(y=e,m=!0):y=Math.max(o,l-o-u)}const p=(()=>{if("function"==typeof window.matchMedia){const e=window.matchMedia("(orientation: portrait)");if("boolean"==typeof e.matches)return e.matches}return l>=i})();let g;g=t&&p?Math.round(a.left+(a.width-d)/2):Math.round(a.right-d);const f=Math.max(10,i-o-d);g=Math.min(Math.max(g,10),f),r.style.top=`${y}px`,r.style.left=`${g}px`,r.classList.toggle("open-upwards",m),r.classList.toggle("open-downwards",!m)}function Xt(){e.playerQualityMenu&&(e.playerQualityMenu.classList.remove("floating","open-upwards","open-downwards"),e.playerQualityMenu.style.top="",e.playerQualityMenu.style.left="",e.playerQualityMenu.style.right="",e.playerQualityMenu.style.minWidth="",e.playerQualityMenu.style.maxWidth="",e.playerQualityMenu.style.width="")}function Yt(){if(!e.playerQualityMenu)return;const t=e.playerQualityMenu;if(!(Be.qualityMenuOpen||t.classList.contains("show")))return Xt(),Gt(Ye,!1),Ye=null,void lt();const n=()=>{n._timeout&&(window.clearTimeout(n._timeout),n._timeout=null),t.removeEventListener("transitionend",r),Be.qualityMenuOpen||t.classList.contains("show")||(Xt(),lt())},r=e=>{e.target===t&&(e.propertyName&&!["opacity","transform"].includes(e.propertyName)||n())};t.addEventListener("transitionend",r),n._timeout=window.setTimeout(n,250),t.classList.remove("show"),Be.qualityMenuOpen=!1,tt(),Gt(Ye,!1),Ye=null}function Zt(t){const n=t.target.closest(".player-quality-option");if(!n)return;t.preventDefault(),t.stopPropagation();const{quality:r}=n.dataset;r&&async function(t){const n=de(t);if(n===Be.playbackQuality)return void Yt();Be.playbackQuality=n,Vt(),Ht(),ft(),Yt();const r=ue.find(e=>e.value===n);r&&Ln(`音质已切换为 ${r.label} (${r.description})`);if(Be.currentSong){await async function(){if(!Be.currentSong)return!0;const t=!e.audioPlayer.paused,n=e.audioPlayer.currentTime||Be.currentPlaybackTime||0;try{return await pn(Be.currentSong,{autoplay:t,startTime:n,preserveProgress:!0}),t||(e.audioPlayer.pause(),kt()),!0}catch(e){return console.error("切换音质失败:",e),!1}}()||Ln("切换音质失败，请稍后重试","error")}}(r)}function en(t,n={}){const{loadArtwork:r=!0}=n;Be.currentSong=t,e.currentSongTitle.textContent=t.name,a();const i=Array.isArray(t.artist)?t.artist.join(", "):t.artist||"未知艺术家";e.currentSongArtist.textContent=i;const l="string"==typeof t.name?t.name.trim():"",o="string"==typeof i?i.trim():"",s=[];if(l&&s.push(l),o&&s.push(o),Ge(s.join(" - ")),Ve(""),mt(),!r)return e.albumCover.classList.add("loading"),e.albumCover.innerHTML=f,Promise.resolve();if(t.pic_id){mt(),e.albumCover.classList.add("loading");const n=Te.getPicUrl(t);Te.fetchJson(n).then(n=>{if(!n||!n.url)throw new Error("封面地址缺失");const r=new Image,a=V(n.url);r.crossOrigin="anonymous",r.onload=()=>{if(Be.currentSong!==t)return;var n;n=a,e.albumCover.innerHTML=`<img src="${n}" alt="专辑封面">`,e.albumCover.classList.remove("loading");!function(e,t={}){const n=Boolean(t.immediate);mt(),v&&(v.abort(),v=null),Be.currentPaletteImage=null,yt({immediate:n})}(0,{immediate:h.has(a)||Be.currentPaletteImage===a&&Be.dynamicPalette})},r.onerror=()=>{Be.currentSong===t&&(mt(),gt())},r.src=a}).catch(e=>{console.error("加载封面失败:",e),Be.currentSong===t&&(mt(),gt())})}else mt(),gt();return Promise.resolve()}async function tn(t=!1){const n=e.searchInput.value.trim();if(!n)return void Ln("请输入搜索关键词","error");Be.sourceMenuOpen&&Qt();const r=ce(Be.searchSource);Be.searchSource=r,T("searchSource",r),_t(),Rt(),t?(Be.searchKeyword=n,Be.searchSource=r):(Be.searchPage=1,Be.searchKeyword=n,Be.searchSource=r,Be.searchResults=[],Be.hasMoreResults=!0,Be.renderedSearchCount=0,ht(`开始新搜索: ${n}, 来源: ${r}`));try{e.searchBtn.disabled=!0,e.searchBtn.innerHTML='<span class="loader"></span><span>搜索中...</span>',bt(!0),Be.sourceMenuOpen&&et(),Be.qualityMenuOpen&&nt(),ht("已切换到搜索模式");const t=await Te.search(n,r,20,Be.searchPage);ht(`API返回结果数量: ${t.length}`),1===Be.searchPage?Be.searchResults=t:Be.searchResults=[...Be.searchResults,...t],Be.hasMoreResults=20===t.length,an(t,{reset:1===Be.searchPage,totalCount:Be.searchResults.length}),ht(`搜索完成: 总共显示 ${Be.searchResults.length} 个结果`),0===Be.searchResults.length&&Ln("未找到相关歌曲","error")}catch(e){console.error("搜索失败:",e),Ln("搜索失败，请稍后重试","error"),vt(),ht(`搜索失败: ${e.message}`)}finally{e.searchBtn.disabled=!1,e.searchBtn.innerHTML='<i class="fas fa-search"></i><span>搜索</span>'}}async function nn(){if(!Be.hasMoreResults||!Be.searchKeyword)return void ht("没有更多结果或搜索关键词为空");const e=document.getElementById("loadMoreBtn");if(e)try{e.disabled=!0,e.innerHTML='<span class="loader"></span><span>加载中...</span>',Be.searchPage++,ht(`加载第 ${Be.searchPage} 页结果`);const t=ce(Be.searchSource);Be.searchSource=t,T("searchSource",t);const n=await Te.search(Be.searchKeyword,t,20,Be.searchPage);n.length>0?(Be.searchResults=[...Be.searchResults,...n],Be.hasMoreResults=20===n.length,an(n,{totalCount:Be.searchResults.length}),ht(`加载完成: 新增 ${n.length} 个结果`)):(Be.hasMoreResults=!1,Ln("没有更多结果了"),ht("没有更多结果"))}catch(e){console.error("加载更多失败:",e),Ln("加载失败，请稍后重试","error"),Be.searchPage--}finally{e&&(e.disabled=!1,e.innerHTML='<i class="fas fa-plus"></i><span>加载更多</span>')}else ht("找不到加载更多按钮")}function rn(e,t){const n=document.createElement("div");n.className="search-result-item",n.dataset.index=String(t),n.tabIndex=0,n.setAttribute("role","button"),n.setAttribute("aria-label",`${e.name||"未知歌曲"} - 播放`);const r=document.createElement("div");r.className="search-result-info";const a=document.createElement("div");a.className="search-result-title",a.textContent=e.name||"未知歌曲";const i=document.createElement("div");i.className="search-result-artist";const l=Array.isArray(e.artist)?e.artist.join(", "):e.artist||"未知艺术家",o=e.album?` - ${e.album}`:"";i.textContent=`${l}${o}`,r.appendChild(a),r.appendChild(i);const s=document.createElement("div");s.className="search-result-actions";const c=document.createElement("button");return c.className="action-btn add",c.type="button",c.title="添加到播放列表",c.setAttribute("aria-label","添加到播放列表"),c.innerHTML='<i class="fas fa-plus"></i>',c.addEventListener("click",e=>{if(e.preventDefault(),e.stopPropagation(),Be.playlists.length<=1)return function(e,t=Be.activePlaylistId,n={}){const r=Be.searchResults[e];if(!r)return;const a=!1!==(n&&"object"==typeof n?n:{}).showMessage,i=De(r,t);if(!i.playlist)return void(a&&Ln("目标歌单不存在","error"));t===Be.activePlaylistId?i.added?on():cn():i.added&&(qe(),Oe(),ft());if(!i.added)return void(a&&i.duplicate&&Ln("歌曲已在歌单中","warning"));a&&Ln(`已添加到「${i.playlist.name}」`,"success")}(t,Be.activePlaylistId),void Je();!function(e,t){const n=Be.searchResults[t];if(!n||!e)return;Re(),Je();const r=document.createElement("div");if(r.className="playlist-picker",Be.playlists.length)Be.playlists.forEach(e=>{const t=document.createElement("button");t.type="button",t.className="playlist-picker__item"+(e.id===Be.activePlaylistId?" playlist-picker__item--active":""),t.dataset.playlistId=e.id;const a=document.createElement("span");a.className="playlist-picker__item-name",a.textContent=e.name;const i=document.createElement("span");i.className="playlist-picker__item-count",i.textContent=String(Array.isArray(e.songs)?e.songs.length:0),t.appendChild(a),t.appendChild(i),t.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation();const r=De(n,e.id);e.id===Be.activePlaylistId?on():r.added&&(qe(),ft()),Je(),r.added?Ln(`已添加到「${e.name}」`,"success"):r.duplicate&&Ln("歌曲已在歌单中","warning")}),r.appendChild(t)});else{const e=document.createElement("div");e.className="playlist-picker__empty",e.textContent="暂无歌单，请先创建一个",r.appendChild(e)}const a=document.createElement("button");a.type="button",a.className="playlist-picker__item playlist-picker__item--create";const i=document.createElement("span");i.className="playlist-picker__item-name";const l=document.createElement("i");l.className="fas fa-plus playlist-picker__item-icon",l.setAttribute("aria-hidden","true"),i.appendChild(l),i.appendChild(document.createTextNode("新建歌单")),a.appendChild(i),a.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),Je();const t=Qe();if(null===t)return;const r=Ue(t,{activate:!0}),a=De(n,r.id);on(),a.added?Ln(`已创建歌单并添加到「${r.name}」`,"success"):a.duplicate&&Ln("歌曲已在歌单中","warning")}),r.appendChild(a),r.addEventListener("click",e=>{e.stopPropagation()}),document.body.appendChild(r);const o=e.getBoundingClientRect(),s=r.getBoundingClientRect(),c=Math.max(window.innerWidth||0,document.documentElement.clientWidth||0),u=Math.max(window.innerHeight||0,document.documentElement.clientHeight||0);let d=o.left,y=o.bottom+8;d+s.width>c-16&&(d=Math.max(16,c-s.width-16)),y+s.height>u-16&&(y=Math.max(16,o.top-s.height-8)),r.style.left=`${d}px`,r.style.top=`${y}px`,xe=r}(c,t)}),s.appendChild(c),n.appendChild(r),n.appendChild(s),n.addEventListener("click",()=>ln(t)),n.addEventListener("keydown",e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),ln(t))}),n}function an(t,n={}){e.playlist.classList.remove("empty");const r=e.searchResults;if(!r)return;const{reset:a=!1,totalCount:i=Be.searchResults.length}=n;a&&(Je(),r.innerHTML="",Be.renderedSearchCount=0);const l=r.querySelector("#loadMoreBtn");l&&l.remove();const o=Array.isArray(t)?t:[];if(0===o.length&&0===Be.renderedSearchCount&&0===i)return r.innerHTML='<div style="text-align: center; color: var(--text-secondary-color); padding: 20px;">未找到相关歌曲</div>',Be.renderedSearchCount=0,void ht("显示搜索结果: 0 个结果, 无可用数据");if(o.length>0){const e=document.createDocumentFragment(),t=Be.renderedSearchCount;o.forEach((n,r)=>{e.appendChild(rn(n,t+r))}),r.appendChild(e),Be.renderedSearchCount+=o.length}Be.hasMoreResults&&r.appendChild(function(){const e=document.createElement("button");return e.id="loadMoreBtn",e.className="load-more-btn",e.type="button",e.innerHTML='<i class="fas fa-plus"></i><span>加载更多</span>',e.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),nn()}),e}());ht(`显示搜索结果: 新增 ${o.length} 个结果, 总计 ${Be.renderedSearchCount} 个, 加载更多按钮: ${Be.hasMoreResults?"显示":"隐藏"}`)}async function ln(e){const t=Be.searchResults[e];if(t)try{const e=Be.activePlaylistId,n=De(t,e);Be.currentPlaylist="playlist",n.added?(Be.currentTrackIndex=n.index,e===Be.activePlaylistId?on():(qe(),Oe(),ft())):n.duplicate&&(Be.currentTrackIndex=n.index,cn()),await pn(t),Ln(`正在播放: ${t.name}`)}catch(e){console.error("播放失败:",e),Ln("播放失败，请稍后重试","error")}}function on(){const t=Ae(),n=t&&Array.isArray(t.songs)?t.songs:[];if(Be.playlistSongs=n,Oe(),qe(),!e.playlistItems)return ft(),void o();if(!n.length)return e.playlist&&e.playlist.classList.add("empty"),e.playlistItems.innerHTML="",ft(),cn(),void o();e.playlist&&e.playlist.classList.remove("empty");const r=n.map((e,t)=>`<div class="playlist-item" data-index="${t}" role="button" tabindex="0" aria-label="播放 ${e.name}">\n            ${e.name} - ${Array.isArray(e.artist)?e.artist.join(", "):e.artist}\n            <button class="playlist-item-remove" type="button" data-playlist-action="remove" data-index="${t}" title="从播放列表移除">\n                <i class="fas fa-times"></i>\n            </button>\n            <button class="playlist-item-download" type="button" data-playlist-action="download" data-index="${t}" title="下载">\n                <i class="fas fa-download"></i>\n            </button>\n        </div>`).join("");e.playlistItems.innerHTML=r,ft(),cn(),o()}async function sn(e){if(e<0||e>=Be.playlistSongs.length)return;const n=Be.playlistSongs[e];Be.currentTrackIndex=e,Be.currentPlaylist="playlist";try{await pn(n),cn(),t&&function(){const e=r("closePanel");i(c)}()}catch(e){console.error("播放失败:",e),Ln("播放失败，请稍后重试","error")}}function cn(){if(!e.playlistItems)return;e.playlistItems.querySelectorAll(".playlist-item").forEach((e,t)=>{const n="playlist"===Be.currentPlaylist&&t===Be.currentTrackIndex;e.classList.toggle("current",n),e.setAttribute("aria-current",n?"true":"false"),e.setAttribute("aria-pressed",n?"true":"false")})}function un(e){return e?e.readyState>=1?Promise.resolve():new Promise((t,n)=>{const r=()=>{e.removeEventListener("loadedmetadata",a),e.removeEventListener("error",i)},a=()=>{r(),t()},i=()=>{r(),n(new Error("音频加载失败"))};e.addEventListener("loadedmetadata",a,{once:!0}),e.addEventListener("error",i,{once:!0})}):Promise.resolve()}function dn(e){return e&&"object"==typeof e?Array.isArray(e.artist)?e.artist.join(" "):"string"==typeof e.artist?e.artist:"":""}function yn(e){if(!e)return"";return(Array.isArray(e)?e.join(" "):String(e)).toLowerCase().replace(/（.*?）/g,"").replace(/\(.*?\)/g,"").replace(/[\s'"\-_,.!?？。·、【】\[\]（）()<>《》「」『』\/\\]+/g,"").trim()}function mn(e,t){if(!t)return-1/0;const n=yn(e?.name),r=yn(dn(e)),a=yn(t.name),i=yn(dn(t)),l=yn(e?.album),o=yn(t.album);let s=0;return a&&n&&(a===n?s+=6:(a.includes(n)||n.includes(a))&&(s+=3)),i&&r&&(i===r?s+=4:(i.includes(r)||r.includes(i))&&(s+=2)),o&&l&&o===l&&(s+=1),a&&n&&a.startsWith(n)&&(s+=1),s}async function pn(t,n={}){const r=n&&"object"==typeof n?n:{},{autoplay:a=!0,startTime:i=0,preserveProgress:l=!1,allowKuwoFallback:o=!0}=r;window.clearTimeout(w),Be.audioReadyForPalette=!1,Be.pendingPaletteData=null,Be.pendingPaletteImage=null,Be.pendingPaletteImmediate=!1,Be.pendingPaletteReady=!1;try{en(t,{loadArtwork:!1});const n=Be.playbackQuality||"320",r=Te.getSongUrl(t,n);ht(`获取音频URL: ${r}`);const o=await Te.fetchJson(r);if(!o||!o.url)throw new Error("无法获取音频播放地址");const s=o.url,c=K(s),u=V(s),d=Array.from(new Set([c,u,s].filter(Boolean))),y=d[0]||s;c&&c!==s?ht(`音频地址已通过代理转换为 HTTPS: ${c}`):u&&u!==s&&ht(`音频地址由 HTTP 升级为 HTTPS: ${u}`),Be.currentSong=t,Be.currentAudioUrl=null,e.audioPlayer.pause(),l?i>0&&(Be.currentPlaybackTime=i,Be.lastSavedPlaybackTime=i):(Be.currentPlaybackTime=0,Be.lastSavedPlaybackTime=0,T("currentPlaybackTime","0")),Be.pendingSeekTime=i>0?i:null;let m=null,p=null,g=!1;for(const t of d){e.audioPlayer.src=t,e.audioPlayer.load();try{await un(e.audioPlayer),m=t,g=t!==y&&d.length>1;break}catch(e){p=e,console.warn("音频元数据加载异常",e),t===y&&d.length>1&&ht("主音频地址加载失败，尝试使用备用地址")}}if(!m)throw p||new Error("音频加载失败");g&&(ht(`已回退至备用音频地址: ${m}`),Ln("主音频加载失败，已切换到备用音源","warning")),Be.currentAudioUrl=m,null!=Be.pendingSeekTime?(Ct(Be.pendingSeekTime),Be.pendingSeekTime=null):Ct(e.audioPlayer.currentTime||0),Be.lastSavedPlaybackTime=Be.currentPlaybackTime;let f=null;a?(f=e.audioPlayer.play(),void 0!==f?f.catch(e=>{console.error("播放失败:",e),Ln("播放失败，请检查网络连接","error")}):f=null):(e.audioPlayer.pause(),kt()),function(t,n){const r=()=>{Be.currentSong===t&&(en(t,{loadArtwork:!0}),async function(t){const n=3,r=[0,500,1e3];for(let a=0;a<n;a++){if(Be.currentSong!==t)return;try{if(a>0&&await new Promise(e=>setTimeout(e,r[a])),Be.currentSong!==t)return;const i=Te.getLyric(t);ht(`获取歌词URL (尝试 ${a+1}/${n}): ${i}`);const l=await Te.fetchJson(i);if(l&&l.lyric){const t=l.tlyric||null;return fn(l.lyric,t),e.lyrics.classList.remove("empty"),void(e.lyrics.dataset.placeholder="default")}a<n-1&&ht(`第 ${a+1} 次尝试未获取到歌词，准备重试...`)}catch(t){if(console.error(`加载歌词失败 (尝试 ${a+1}/${n}):`,t),a===n-1)return hn("<div>歌词加载失败</div>"),e.lyrics.classList.add("empty"),e.lyrics.dataset.placeholder="message",Be.lyricsData=[],Be.currentLyricLine=-1,void Ve("")}}hn("<div>暂无歌词</div>"),e.lyrics.classList.add("empty"),e.lyrics.dataset.placeholder="message",Be.lyricsData=[],Be.currentLyricLine=-1,Ve("")}(t),Be.audioReadyForPalette=!0,pt())},a=()=>{Be.currentSong===t&&("function"==typeof window.requestAnimationFrame?window.requestAnimationFrame(()=>{Be.currentSong===t&&("function"==typeof window.requestIdleCallback?window.requestIdleCallback(()=>{Be.currentSong===t&&r()},{timeout:600}):r())}):window.setTimeout(r,0))};n&&"function"==typeof n.finally?n.finally(a):a()}(t,f),ht(`开始播放: ${t.name} @${n}`)}catch(e){console.error("播放歌曲失败:",e);if(o&&t&&"kuwo"!==t.source)try{const e=await async function(e){if(!e||!e.name)return null;const t=[],n=String(e.name).trim(),r=dn(e).trim(),a=r?r.split(/[,&\/]/)[0].trim():"";n&&r&&t.push(`${n} ${r}`),n&&a&&a!==n&&t.push(`${n} ${a}`),n&&t.push(n);const i=new Set;for(const n of t){const t=n.trim();if(t&&!i.has(t)){i.add(t);try{ht(`尝试酷我音源搜索: ${t}`);const n=await Te.search(t,"kuwo",10,1),r=Array.isArray(n)?n.filter(e=>e&&"kuwo"===e.source):[];if(!r.length)continue;let a=null,i=-1/0;for(const t of r){const n=mn(e,t);(null===a||n>i)&&(a=t,i=n)}if(a)return{...a,album:a.album||e.album,pic_id:a.pic_id||e.pic_id,lyric_id:a.lyric_id||a.id||e.lyric_id||e.id,url_id:a.url_id||a.id||e.url_id||e.id}}catch(e){console.warn("酷我搜索失败:",e)}}}return null}(t);if(e)return Ln("主音源播放失败，正在尝试酷我音源...","warning"),ht(`切换到酷我音源播放尝试: ${e.name} (${e.id})`),await pn(e,{...r,allowKuwoFallback:!1}),void Ln("已切换到酷我音源播放","success");ht("未找到可用的酷我音源备选")}catch(e){console.warn("酷我音源播放失败:",e)}throw e}finally{ft()}}async function gn(t){const n=Be.onlineSongs[t];if(n){Be.currentTrackIndex=t,Be.currentPlaylist="online";try{await pn(n),function(){if(!e.playlistItems)return;e.playlistItems.querySelectorAll(".playlist-item").forEach((e,t)=>{"online"===Be.currentPlaylist&&t===Be.currentTrackIndex?e.classList.add("current"):e.classList.remove("current")})}()}catch(e){console.error("播放失败:",e),Ln("播放失败，请稍后重试","error")}}}function fn(t,n=null){const r=e=>{if(!e)return[];const t=e.split("\n"),n=[];return t.forEach(e=>{const t=e.match(/\[(\d{2}):(\d{2})\.(\d{2,3})\](.*)/);if(t){const e=60*parseInt(t[1])+parseInt(t[2])+parseInt(t[3].padEnd(3,"0"))/1e3,r=t[4].trim();r&&n.push({time:e,text:r})}}),n},a=r(t),i=n?r(n):[],l=[],o=new Map;i.forEach(e=>{o.set(e.time,e.text)}),a.forEach(e=>{const t=o.get(e.time)||"";l.push({time:e.time,text:e.text,translation:t})}),Be.currentLyricLine=-1,Be.lyricsData=l.sort((e,t)=>e.time-t.time),Ve(""),function(){hn(Be.lyricsData.map((e,t)=>{const n=Be.bilingualLyrics&&e.translation;if(n){return`<div data-time="${e.time}" data-index="${t}" class="lyric-line">\n                <div class="lyric-original">${e.text}</div>\n                <div class="lyric-translation">${e.translation}</div>\n            </div>`}else{return`<div data-time="${e.time}" data-index="${t}" class="lyric-line">${e.text}</div>`}}).join("")),e.lyrics&&(e.lyrics.dataset.placeholder="default");Be.isMobileInlineLyricsOpen&&vn()}()}function hn(t){e.lyricsContent&&(e.lyricsContent.innerHTML=t),e.mobileInlineLyricsContent&&(e.mobileInlineLyricsContent.innerHTML=t)}function bn(){hn(""),Be.lyricsData=[],Be.currentLyricLine=-1,Ve(""),t&&p({force:!0})}function vn(){if(0===Be.lyricsData.length)return;const t=e.audioPlayer.currentTime;let n=-1;for(let e=0;e<Be.lyricsData.length&&t>=Be.lyricsData[e].time;e++)n=e;if(n!==Be.currentLyricLine){Be.currentLyricLine=n;const t=n>=0&&n<Be.lyricsData.length?Be.lyricsData[n]:null;Ve(t?t.text:"");const r=[];e.lyricsContent&&r.push({elements:e.lyricsContent.querySelectorAll("div[data-index]"),container:e.lyricsScroll||e.lyrics}),e.mobileInlineLyricsContent&&r.push({elements:e.mobileInlineLyricsContent.querySelectorAll("div[data-index]"),container:e.mobileInlineLyricsScroll||e.mobileInlineLyrics,inline:!0}),r.forEach(({elements:e,container:t,inline:r})=>{e.forEach((e,a)=>{if(a===n){e.classList.add("current");!Be.userScrolledLyrics&&(!r||Be.isMobileInlineLyricsOpen)&&wn(e,t)}else e.classList.remove("current")})})}}function Sn(e){if(!e||!e.target||"function"!=typeof e.target.closest)return;const t=e.target.closest("div[data-time]");if(!t)return;e.preventDefault(),e.stopPropagation();const n=Number.parseFloat(t.dataset.time);Number.isFinite(n)&&(clearTimeout(Be.lyricsScrollTimeout),Be.lyricsScrollTimeout=null,Be.userScrolledLyrics=!1,Ot(n),vn())}function wn(t,n){const r=n||e.lyricsScroll||e.lyrics;if(!r||!t)return;const a=r.clientHeight,i=t.getBoundingClientRect(),l=r.getBoundingClientRect(),o=i.top-l.top+r.scrollTop,s=o-a/2+i.height/2,c=r.scrollHeight-a,u=Math.max(0,Math.min(s,c));Math.abs(r.scrollTop-u)>1&&("function"==typeof r.scrollTo?r.scrollTo({top:u,behavior:"smooth"}):r.scrollTop=u),ht(`歌词滚动: 元素在容器内偏移=${o}, 容器高度=${a}, 目标滚动=${u}`)}function Pn(n){"playlist"===n?(e.showPlaylistBtn&&e.showPlaylistBtn.classList.add("active"),e.showLyricsBtn&&e.showLyricsBtn.classList.remove("active"),e.playlist.classList.add("active"),e.lyrics.classList.remove("active")):"lyrics"===n&&(e.showLyricsBtn&&e.showLyricsBtn.classList.add("active"),e.showPlaylistBtn&&e.showPlaylistBtn.classList.remove("active"),e.lyrics.classList.add("active"),e.playlist.classList.remove("active")),t&&document.body&&(document.body.setAttribute("data-mobile-panel-view",n),e.mobilePanelTitle&&(e.mobilePanelTitle.textContent="lyrics"===n?"歌词":"播放列表"),o())}function Ln(t,n="success"){const r=e.notification;r.textContent=t,r.className=`notification ${n}`,r.classList.add("show"),setTimeout(()=>{r.classList.remove("show")},3e3)}window.addEventListener("load",()=>{(async function(){function n(){if(!e.playerQualityMenu||!document.body||!t)return;const n=e.playerQualityMenu.parentElement;n&&n!==document.body&&(n.removeChild(e.playerQualityMenu),document.body.appendChild(e.playerQualityMenu))}function l(){if(!e.playlistItems)return;const t=e=>{"number"!=typeof e||Number.isNaN(e)||sn(e)},n=(t,n)=>{const r=Number(n.dataset.index);if(Number.isNaN(r))return;const i=n.dataset.playlistAction;"remove"===i?(t.preventDefault(),t.stopPropagation(),function(t){if(t<0||t>=Be.playlistSongs.length)return;const n="playlist"===Be.currentPlaylist&&Be.currentTrackIndex===t;n?1===Be.playlistSongs.length?(e.audioPlayer.pause(),e.audioPlayer.src="",Be.currentTrackIndex=-1,Be.currentSong=null,Ge(""),Be.currentAudioUrl=null,Be.currentPlaybackTime=0,Be.lastSavedPlaybackTime=0,e.progressBar.value=0,e.progressBar.max=0,e.currentTimeDisplay.textContent="00:00",e.durationDisplay.textContent="00:00",It(0,1),e.currentSongTitle.textContent="选择一首歌曲开始播放",a(),e.currentSongArtist.textContent="未知艺术家",gt(),bn(),e.lyrics&&(e.lyrics.dataset.placeholder="default"),e.lyrics.classList.add("empty"),kt()):t===Be.playlistSongs.length-1&&(Be.currentTrackIndex=t-1):"playlist"===Be.currentPlaylist&&Be.currentTrackIndex>t&&Be.currentTrackIndex--;if(Be.playlistSongs.splice(t,1),0===Be.playlistSongs.length)e.playlist.classList.add("empty"),e.playlistItems&&(e.playlistItems.innerHTML=""),Be.currentPlaylist="playlist",o();else if("playlist"===Be.currentPlaylist&&Be.currentTrackIndex<0&&(Be.currentTrackIndex=0),on(),n&&"playlist"===Be.currentPlaylist&&Be.currentTrackIndex>=0){const e=Math.min(Be.currentTrackIndex,Be.playlistSongs.length-1);Be.currentTrackIndex=e,sn(e)}else cn();qe(),Oe(),ft(),Ln("已从播放列表移除","success")}(r)):"download"===i&&(t.preventDefault(),t.stopPropagation(),function(e,t,n){e.stopPropagation();const r=document.querySelector(".dynamic-quality-menu");r&&r.remove();const a=document.createElement("div");a.className="dynamic-quality-menu",a.innerHTML=`\n        <div class="quality-option" onclick="downloadWithQuality(event, ${t}, '${n}', '128')">标准音质 (128k)</div>\n        <div class="quality-option" onclick="downloadWithQuality(event, ${t}, '${n}', '192')">高音质 (192k)</div>\n        <div class="quality-option" onclick="downloadWithQuality(event, ${t}, '${n}', '320')">超高音质 (320k)</div>\n        <div class="quality-option" onclick="downloadWithQuality(event, ${t}, '${n}', '999')">无损音质</div>\n    `;const i=e.target.closest("button"),l=i.getBoundingClientRect();a.style.position="fixed",a.style.top=l.bottom+5+"px",a.style.left=l.left-50+"px",a.style.zIndex="10000",document.body.appendChild(a),setTimeout(()=>{document.addEventListener("click",function e(t){a.contains(t.target)||(a.remove(),document.removeEventListener("click",e))})},0)}(t,r,"playlist"))},r=r=>{const a=r.target.closest("[data-playlist-action]");if(a)return void n(r,a);const i=r.target.closest(".playlist-item");if(!i||!e.playlistItems.contains(i))return;const l=Number(i.dataset.index);Number.isNaN(l)||t(l)},i=n=>{if("Enter"!==n.key&&" "!==n.key)return;if(n.target.closest("[data-playlist-action]"))return;const r=n.target.closest(".playlist-item");if(!r||!e.playlistItems.contains(r))return;const a=Number(r.dataset.index);Number.isNaN(a)||(n.preventDefault(),t(a))};e.playlistItems.addEventListener("click",r),e.playlistItems.addEventListener("keydown",i)}function d(t){Be.themeDefaultsCaptured||ct(),document.body.classList.toggle("dark-mode",t),e.themeToggleButton.classList.toggle("is-dark",t);const n=t?"切换为浅色模式":"切换为深色模式";e.themeToggleButton.setAttribute("aria-label",n),e.themeToggleButton.setAttribute("title",n),dt()}ct();const y=I("theme"),m=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;d(y?y==="dark":m),e.themeToggleButton.addEventListener("click",()=>{const e=!document.body.classList.contains("dark-mode");d(e),T("theme",e?"dark":"light")}),e.audioPlayer.volume=Be.volume,e.volumeSlider.value=Be.volume,Tt(Be.volume),Bt(Be.volume),Rt(),_t(),Ht(),qe(),Oe(),n(),l(),Vt(),kt(),e.currentTimeDisplay.textContent=Mt(Be.currentPlaybackTime),It(0,Number(e.progressBar.max)),e.playPauseBtn.addEventListener("click",qt),e.audioPlayer.addEventListener("timeupdate",$t),e.audioPlayer.addEventListener("loadedmetadata",At),e.audioPlayer.addEventListener("play",kt),e.audioPlayer.addEventListener("pause",kt),e.audioPlayer.addEventListener("volumechange",xt),e.progressBar.addEventListener("input",Nt),e.progressBar.addEventListener("change",Dt),e.progressBar.addEventListener("pointerup",Dt),e.volumeSlider.addEventListener("input",Et),e.sourceSelectButton&&e.sourceMenu&&(e.sourceSelectButton.addEventListener("click",Ut),e.sourceMenu.addEventListener("click",jt));e.playlistSelectorButton&&e.playlistMenu&&(e.playlistSelectorButton.addEventListener("click",_e),e.playlistMenu.addEventListener("click",Fe));e.createPlaylistBtn&&e.createPlaylistBtn.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),function(){Je(),Re();const e=Qe();if(null===e)return;const t=Ue(e,{activate:!0});Be.currentPlaylist="playlist",on(),Ln(`已创建歌单「${t.name}」`,"success")}()});e.importPlaylistBtn&&e.importPlaylistBtn.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),He()});e.deletePlaylistBtn&&e.deletePlaylistBtn.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),je()});e.qualityToggle.addEventListener("click",Kt),e.mobileQualityToggle&&e.mobileQualityToggle.addEventListener("click",Kt);Gt(e.qualityToggle,!1),e.mobileQualityToggle&&Gt(e.mobileQualityToggle,!1);e.playerQualityMenu.addEventListener("click",Zt),e.playlistSyncBtn&&e.playlistSyncBtn.addEventListener("click",oe);t&&e.albumCover&&e.albumCover.addEventListener("click",()=>{g()});t&&e.mobileInlineLyrics&&e.mobileInlineLyrics.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),Be.isMobileInlineLyricsOpen&&p()});e.showPlaylistBtn&&e.showPlaylistBtn.addEventListener("click",()=>{t?u("playlist"):Pn("playlist")});e.showLyricsBtn&&e.showLyricsBtn.addEventListener("click",()=>{t?u("lyrics"):Pn("lyrics")});Pt(),e.playModeBtn.addEventListener("click",Lt),e.searchBtn.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),ht("搜索按钮被点击"),tn()}),e.searchInput.addEventListener("keypress",e=>{"Enter"===e.key&&(e.preventDefault(),e.stopPropagation(),ht("搜索输入框回车键被按下"),tn())}),document.addEventListener("click",e=>{const t=document.querySelector(".search-area");t&&!t.contains(e.target)&&Be.isSearchMode&&(ht("点击搜索区域外部，隐藏搜索结果"),vt())}),document.addEventListener("keydown",e=>{"Escape"===e.key&&(Be.sourceMenuOpen&&Qt(),Be.qualityMenuOpen&&Yt(),Be.playlistMenuOpen&&Re(),xe&&Je(),t&&function(){const e=r("closeAllOverlays");i(()=>{s(),c()})}())}),document.addEventListener("click",t=>{if(document.querySelectorAll(".quality-menu").forEach(e=>{if(!e.contains(t.target)&&!t.target.closest(".playlist-item-download")){e.classList.remove("show");const t=e.closest(".search-result-item");t&&t.classList.remove("menu-active")}}),Be.qualityMenuOpen&&e.playerQualityMenu&&!e.playerQualityMenu.contains(t.target)){const e=Jt(Ye)?Ye:Wt();if(e&&e.contains(t.target))return;Yt()}Be.sourceMenuOpen&&e.sourceMenu&&e.sourceSelectButton&&!e.sourceMenu.contains(t.target)&&!e.sourceSelectButton.contains(t.target)&&Qt(),Be.playlistMenuOpen&&e.playlistMenu&&e.playlistSelectorButton&&!e.playlistMenu.contains(t.target)&&!e.playlistSelectorButton.contains(t.target)&&Re(),xe&&!xe.contains(t.target)&&Je()}),e.searchResults.addEventListener("click",e=>{ht(`点击事件触发: ${e.target.tagName} ${e.target.className} ${e.target.id}`);(e.target.closest(".load-more-btn")||e.target.closest("#loadMoreBtn")||("loadMoreBtn"===e.target.id?e.target:null)||(e.target.classList.contains("load-more-btn")?e.target:null))&&(ht("检测到加载更多按钮点击"),e.preventDefault(),e.stopPropagation(),nn())}),document.addEventListener("click",e=>{("loadMoreBtn"===e.target.id||e.target.closest("#loadMoreBtn"))&&(ht("备用事件监听器触发"),e.preventDefault(),e.stopPropagation(),nn())});const f=(t,n)=>{t&&t.addEventListener("scroll",()=>{Be.userScrolledLyrics=!0,clearTimeout(Be.lyricsScrollTimeout),Be.lyricsScrollTimeout=setTimeout(()=>{Be.userScrolledLyrics=!1;const r="function"==typeof n?n():e.lyricsContent?.querySelector(".current");r&&wn(r,t)},3e3)},{passive:!0})};f(e.lyricsScroll,()=>e.lyricsContent?.querySelector(".current")),f(e.mobileInlineLyricsScroll,()=>e.mobileInlineLyricsContent?.querySelector(".current")),e.lyricsContent&&e.lyricsContent.addEventListener("click",Sn);e.mobileInlineLyricsContent&&e.mobileInlineLyricsContent.addEventListener("click",Sn);if(document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState&&ne()}),window.addEventListener("pagehide",()=>{ne()}),await le(),ee(),Pt(),Vt(),on(),Be.playlistSongs.length>0){let e=Be.currentTrackIndex;(e<0||e>=Be.playlistSongs.length)&&(e=0),Be.currentTrackIndex=e,Be.currentPlaylist="playlist";const t=Be.playlistSongs[e];t&&(Be.currentSong=t,cn(),en(t).catch(e=>{console.error("恢复歌曲信息失败:",e)}))}else o();Be.currentSong&&async function(){if(Be.currentSong)try{await pn(Be.currentSong,{autoplay:!1,startTime:Be.currentPlaybackTime,preserveProgress:!0}),e.audioPlayer.pause(),kt()}catch(e){console.warn("恢复音频失败:",e)}}();t&&(r("initialize"),o())})().catch(e=>{console.error("初始化界面失败:",e),Ln("初始化失败，请刷新页面重试","error")})}),e.audioPlayer.addEventListener("ended",function(){if("single"===Be.playMode)return e.audioPlayer.currentTime=0,void e.audioPlayer.play();(function(){let e=-1,t=[];"playlist"===Be.currentPlaylist?t=Be.playlistSongs:"online"===Be.currentPlaylist?t=Be.onlineSongs:"search"===Be.currentPlaylist&&(t=Be.searchResults);if(0===t.length)return;e="random"===Be.playMode?Math.floor(Math.random()*t.length):(Be.currentTrackIndex+1)%t.length;Be.currentTrackIndex=e,"playlist"===Be.currentPlaylist?sn(e):"online"===Be.currentPlaylist?gn(e):"search"===Be.currentPlaylist&&ln(e)})(),kt()});