# 音频播放优化改进

## 改进内容

本次更新实现了以下三个关键改进：

### 1. 默认使用高品音质（192 kbps）

**改动位置：**
- `normalizeQuality()` 函数：将默认音质从 "320" 改为 "192"
- `API.getSongUrl()` 方法：将默认 quality 参数从 "320" 改为 "192"
- `playSong()` 函数：将默认音质从 "320" 改为 "192"

**效果：**
- 新用户首次使用时，默认使用高品音质（192 kbps）而不是极高音质（320 kbps）
- 在保证音质的同时，减少带宽消耗，提供更快的加载速度
- 已有用户的音质设置不受影响（会从 localStorage 读取）

### 2. 优先加载专辑封面和歌词

**改动位置：**
- `playSong()` 函数重构

**实现方式：**
- 在获取音频数据之前，先并行加载专辑封面和歌词
- 使用 `Promise.all()` 等待封面和歌词加载完成
- 设置 800ms 超时，避免封面/歌词加载时间过长阻塞音频播放
- 使用 `Promise.race()` 确保即使封面或歌词加载失败，也不会无限等待

**效果：**
- 用户在音乐开始播放前就能看到封面和歌词
- 提升用户体验，避免播放开始后封面和歌词才显示的突兀感
- 不会因为封面或歌词加载失败而阻塞音频播放

### 3. 流式加载音频，不等待完全下载

**改动位置：**
- `playSong()` 函数中的音频加载逻辑

**实现方式：**
- 将原来的 `waitForAudioReady()` 改为监听 `canplay` 和 `loadedmetadata` 事件
- 使用 `canplay` 事件（浏览器准备好播放时触发）而不只是等待 `loadedmetadata`
- 两个事件中哪个先触发就使用哪个，确保尽早开始播放
- 保留 10 秒超时机制，避免无限等待

**效果：**
- 音频可以在部分数据加载完成后就开始播放（流式播放）
- 不需要等待整首歌曲下载完成
- 显著减少从点击播放到音乐响起的等待时间
- 浏览器会自动继续在后台下载音频数据

## 技术细节

### 加载顺序
1. 立即更新歌曲信息显示（标题、艺术家）
2. 并行加载封面图片和歌词（最多等待 800ms）
3. 获取音频 URL
4. 设置音频源并开始流式加载
5. 等待 `canplay` 或 `loadedmetadata` 事件
6. 开始播放音乐

### 错误处理
- 封面加载失败：显示占位符，不阻塞后续流程
- 歌词加载失败：显示"歌词加载失败"，不阻塞后续流程
- 音频加载失败：尝试备用 URL，显示错误通知
- 超时处理：避免任何环节无限等待

### 兼容性
- 所有现代浏览器都支持 `canplay` 和 `loadedmetadata` 事件
- 保持与原有功能的完全兼容
- 用户已保存的音质设置不受影响

## 用户体验改进

1. **更快的响应速度**：从点击播放到音乐响起的时间显著缩短
2. **更早的视觉反馈**：封面和歌词在音乐开始前就已显示
3. **更合理的默认设置**：高品音质在音质和速度之间取得更好的平衡
4. **流畅的播放体验**：音频流式加载，不需要等待完整下载

## 向后兼容性

- 所有改动都保持向后兼容
- 已有用户的音质偏好设置（存储在 localStorage）不受影响
- 播放列表、搜索、在线音乐等功能完全正常
- 所有错误处理机制保持不变
